<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrumento de Evaluaci√≥n</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; 
            min-height: 100vh;
        }
        .container { 
            max-width: 1600px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
        }
        .header { 
            background: #1F4E78; 
            color: white; 
            padding: 30px; 
            text-align: center; 
            border-radius: 15px 15px 0 0; 
        }
        .toolbar {
            background: #f8f9fa;
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 2px solid #ddd;
        }
        .btn-toolbar {
            padding: 10px 20px;
            background: white;
            border: 2px solid #70AD47;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #70AD47;
            font-size: 14px;
        }
        .btn-toolbar:hover {
            background: #70AD47;
            color: white;
        }
        .btn-toolbar.btn-secondary {
            border-color: #4472C4;
            color: #4472C4;
        }
        .btn-toolbar.btn-secondary:hover {
            background: #4472C4;
            color: white;
        }
        .btn-toolbar.btn-warning {
            border-color: #FF9800;
            color: #FF9800;
        }
        .btn-toolbar.btn-warning:hover {
            background: #FF9800;
            color: white;
        }
        input[type="file"] {
            display: none;
        }
        .nav { 
            background: white;
            padding: 15px 20px; 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .nav button { 
            padding: 10px 12px; 
            background: white; 
            border: 2px solid #4472C4; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            color: #4472C4;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .nav button:hover {
            background: #e3f2fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(68,114,196,0.2);
        }
        .nav button.active { 
            background: #4472C4; 
            color: white; 
        }
        .nav button.destacado {
            border-color: #28a745;
            color: #28a745;
        }
        .nav button.destacado:hover {
            background: #d4edda;
        }
        .nav button.destacado.active {
            background: #28a745;
            color: white;
        }
        
        /* ESTILOS PARA DROPDOWN DE CALIFICACIONES */
        .nav-dropdown {
            position: relative;
            display: inline-block;
        }
        .nav-dropdown > button {
            padding: 10px 12px;
            background: white;
            border: 2px solid #ff9800;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #ff9800;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .nav-dropdown > button:hover {
            background: #fff3e0;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255,152,0,0.2);
        }
        .nav-dropdown > button.active {
            background: #ff9800;
            color: white;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            z-index: 1000;
            margin-top: 5px;
            padding: 8px 0;
        }
        .nav-dropdown:hover .dropdown-content {
            display: block;
        }
        .dropdown-content button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            background: white;
            border: none;
            text-align: left;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            font-size: 13px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .dropdown-content button:hover {
            background: #f5f5f5;
            border-left-color: #ff9800;
            padding-left: 18px;
        }
        .dropdown-content button.active {
            background: #fff3e0;
            color: #ff9800;
            border-left-color: #ff9800;
        }
        /* FIN ESTILOS DROPDOWN */
        
        .content { 
            padding: 30px; 
        }
        .pantalla { 
            display: none; 
        }
        .pantalla.activa { 
            display: block; 
        }
        .seccion { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
        }
        .seccion h2 { 
            color: #1F4E78; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #4472C4; 
            padding-bottom: 10px; 
        }
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
        }
        .campo label { 
            font-weight: bold; 
            display: block; 
            margin-bottom: 8px; 
        }
        .campo input { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
        }
        .lista-estudiantes { 
            display: grid; 
            gap: 10px; 
            margin-top: 20px; 
        }
        .estudiante { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            padding: 10px; 
            background: white; 
            border-radius: 5px; 
        }
        .btn-eliminar { 
            padding: 8px 15px; 
            background: #c00; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 13px;
        }
        .btn-agregar { 
            margin-top: 15px; 
            padding: 12px 24px; 
            background: #70AD47; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .competencia-card {
            background: white;
            border: 3px solid #4472C4;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .competencia-header {
            background: #4472C4;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .competencia-titulo {
            font-size: 18px;
            font-weight: bold;
        }
        .competencia-content textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            min-height: 80px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .indicador-card {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 10px 0 10px 20px;
            border-radius: 5px;
        }
        .indicador-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .indicador-label {
            font-weight: bold;
            color: #1976D2;
            font-size: 14px;
        }
        .indicador-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #90CAF9;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .criterio-card {
            background: #fff3e0;
            border-left: 4px solid #FF9800;
            padding: 12px;
            margin: 8px 0 8px 40px;
            border-radius: 5px;
        }
        .criterio-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .criterio-label {
            font-weight: bold;
            color: #F57C00;
            font-size: 13px;
        }
        .criterio-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #FFB74D;
            border-radius: 5px;
        }
        .btn-add-ind {
            margin-left: 20px;
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        .btn-add-crit {
            margin-left: 40px;
            padding: 8px 16px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
        }
        .tabs-periodo { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
        }
        .tabs-periodo button { 
            padding: 10px 20px; 
            background: white; 
            border: 2px solid #4472C4; 
            border-radius: 6px; 
            cursor: pointer; 
            color: #4472C4; 
            font-weight: bold;
        }
        .tabs-periodo button.activo { 
            background: #4472C4; 
            color: white; 
        }
        .tabla-calif { 
            width: 100%; 
            border-collapse: collapse; 
            background: white; 
            font-size: 0.9em;
        }
        .tabla-calif th { 
            background: #4472C4; 
            color: white; 
            padding: 10px 5px; 
            text-align: center; 
        }
        .tabla-calif td { 
            padding: 8px 5px; 
            text-align: center; 
            border: 1px solid #ddd;
        }
        .select-nota { 
            width: 100%; 
            padding: 5px; 
            border: 2px solid #ddd; 
            border-radius: 4px;
        }
        .fecha-header-input {
            width: 90%;
            padding: 4px;
            border: 1px solid #fff;
            border-radius: 3px;
            font-size: 11px;
            text-align: center;
            background: rgba(255,255,255,0.3);
            color: white;
        }
        .fecha-header-input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .nota-a { background: #C6E0B4; }
        .nota-b { background: #FFE699; }
        .nota-c { background: #F4B084; }
        .nota-d { background: #FFB3B3; }
        .celda-promedio { 
            background: #FFC000; 
            font-weight: bold; 
        }
        
        /* TABLA REPORTE FINAL */
        .tabla-reporte {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.85em;
        }
        .tabla-reporte th {
            background: #1F4E78;
            color: white;
            padding: 12px 6px;
            text-align: center;
            font-weight: bold;
            border: 2px solid #0d2847;
        }
        .tabla-reporte td {
            padding: 10px 6px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .tabla-reporte .col-estudiante {
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
        }
        .tabla-reporte .col-numero {
            font-weight: bold;
        }
        
        .tabla-reporte .bloque1-col {
            background: #dae8fc;
            border-left: 3px solid #4472C4;
        }
        .tabla-reporte .bloque2-col {
            background: #d5e8d4;
            border-left: 3px solid #70AD47;
        }
        .tabla-reporte .bloque3-col {
            background: #fff2cc;
            border-left: 3px solid #FFC000;
        }
        .tabla-reporte .bloque4-col {
            background: #f8cecc;
            border-left: 3px solid #E74C3C;
        }
        
        .tabla-reporte .promedio-bloques {
            background: #fff3cd;
            font-weight: bold;
            border-left: 3px solid #ffc107;
        }
        .tabla-reporte .final-col {
            background: #d4edda;
            font-weight: bold;
            font-size: 1.1em;
            border-left: 3px solid #28a745;
        }
        .tabla-reporte .aprobado {
            background: #d4edda;
            color: #155724;
            font-weight: bold;
        }
        .tabla-reporte .reprobado {
            background: #f8d7da;
            color: #721c24;
            font-weight: bold;
        }
        .tabla-reporte .sin-datos {
            background: #f8f9fa;
            color: #6c757d;
            font-style: italic;
        }
        
        .tabla-reporte .header-bloque1 {
            background: #4472C4 !important;
        }
        .tabla-reporte .header-bloque2 {
            background: #70AD47 !important;
        }
        .tabla-reporte .header-bloque3 {
            background: #FFC000 !important;
            color: #333 !important;
        }
        .tabla-reporte .header-bloque4 {
            background: #E74C3C !important;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #1F4E78;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-card.aprobados .stat-number {
            color: #28a745;
        }
        .stat-card.reprobados .stat-number {
            color: #dc3545;
        }
        .stat-card.promedio .stat-number {
            color: #4472C4;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin: 20px 0;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .top-estudiantes {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .top-estudiantes h3 {
            color: #1F4E78;
            margin-bottom: 15px;
        }
        .top-list {
            list-style: none;
        }
        .top-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .top-item:nth-child(1) {
            background: #ffd700;
            font-weight: bold;
        }
        .top-item:nth-child(2) {
            background: #c0c0c0;
        }
        .top-item:nth-child(3) {
            background: #cd7f32;
        }
        
        .mensaje { 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            background: #70AD47; 
            color: white; 
            padding: 15px 25px; 
            border-radius: 8px; 
            display: none;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .mensaje.mostrar { 
            display: block; 
        }
        .mensaje.error {
            background: #c00;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-contenido {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }
        .modal-contenido h2 {
            color: #1F4E78;
            margin-bottom: 20px;
        }
        .opciones-pdf {
            display: grid;
            gap: 10px;
            margin: 20px 0;
        }
        .opciones-pdf button {
            padding: 15px;
            background: white;
            border: 2px solid #4472C4;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #4472C4;
            font-size: 14px;
        }
        .opciones-pdf button:hover {
            background: #4472C4;
            color: white;
        }
        .btn-cerrar {
            background: #ccc;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #4472C4;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .info-box h3 {
            color: #1F4E78;
            margin-bottom: 10px;
        }
        .info-box p {
            margin: 5px 0;
            line-height: 1.6;
        }
        .leyenda-reporte {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        .leyenda-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .leyenda-color {
            width: 35px;
            height: 22px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .leyenda-item span {
            font-size: 13px;
            font-weight: 500;
        }
        
        /* RULETA */
        .ruleta-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            padding: 20px;
        }
        .ruleta-canvas-wrapper {
            position: relative;
            width: 500px;
            height: 500px;
        }
        .ruleta-canvas {
            border: 8px solid #1F4E78;
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .ruleta-pointer {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #E74C3C;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
            z-index: 10;
        }
        .ruleta-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: #1F4E78;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            z-index: 5;
        }
        .ruleta-controles {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn-ruleta {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn-girar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-girar:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .btn-girar:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-eliminar-ruleta {
            background: #E74C3C;
            color: white;
        }
        .btn-restaurar {
            background: #70AD47;
            color: white;
        }
        .resultado-ruleta {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .resultado-ruleta h2 {
            color: #1F4E78;
            font-size: 28px;
            margin-bottom: 15px;
        }
        .resultado-ruleta .nombre-seleccionado {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            animation: aparecer 0.5s ease;
        }
        @keyframes aparecer {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .estudiantes-restantes {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        .estudiantes-restantes h3 {
            color: #1F4E78;
            margin-bottom: 10px;
        }
        .lista-restantes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }
        .chip-estudiante {
            background: #4472C4;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        .chip-eliminado {
            background: #ccc;
            color: #666;
            text-decoration: line-through;
        }
        
        /* GRUPOS */
        .grupos-container {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        .grupo-config {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .grupo-config label {
            font-weight: bold;
            font-size: 16px;
        }
        .grupo-config input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            width: 100px;
            font-size: 16px;
        }
        .btn-generar-grupos {
            padding: 12px 24px;
            background: #70AD47;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
        }
        .grupos-resultado {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .grupo-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-top: 5px solid;
        }
        .grupo-card:nth-child(4n+1) { border-top-color: #4472C4; }
        .grupo-card:nth-child(4n+2) { border-top-color: #70AD47; }
        .grupo-card:nth-child(4n+3) { border-top-color: #FFC000; }
        .grupo-card:nth-child(4n+4) { border-top-color: #E74C3C; }
        .grupo-card h3 {
            color: #1F4E78;
            margin-bottom: 15px;
            font-size: 20px;
        }
        .grupo-card ul {
            list-style: none;
            padding: 0;
        }
        .grupo-card li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .grupo-card li:last-child {
            border-bottom: none;
        }
        
        /* ASISTENCIA */
        .asistencia-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .asistencia-controles {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .asistencia-controles label {
            font-weight: bold;
            color: #1F4E78;
        }
        .asistencia-controles select,
        .asistencia-controles input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn-asistencia {
            padding: 10px 20px;
            background: #4472C4;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .btn-asistencia:hover {
            background: #365a99;
        }
        .btn-asistencia.success {
            background: #70AD47;
        }
        .btn-asistencia.success:hover {
            background: #5a8a38;
        }
        .tabla-asistencia {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.85em;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .tabla-asistencia th {
            background: #1F4E78;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .tabla-asistencia td {
            padding: 8px 5px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .tabla-asistencia .col-estudiante {
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
            background: #f8f9fa;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .tabla-asistencia .col-numero {
            font-weight: bold;
            background: #f8f9fa;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        .dia-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        .dia-input {
            width: 35px;
            padding: 3px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 3px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 12px;
        }
        .asistencia-select {
            width: 50px;
            padding: 5px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            font-size: 13px;
        }
        .asistencia-P { background: #C6E0B4; color: #2d5016; }
        .asistencia-T { background: #FFE699; color: #7f6000; }
        .asistencia-E { background: #F4B084; color: #7f3800; }
        .asistencia-A { background: #FFB3B3; color: #7f0000; }
        .col-porcentaje {
            background: #E7F3FF;
            font-weight: bold;
            font-size: 1.1em;
        }
        .porcentaje-excelente { color: #28a745; }
        .porcentaje-bueno { color: #70AD47; }
        .porcentaje-regular { color: #FFA500; }
        .porcentaje-malo { color: #E74C3C; }
        .leyenda-asistencia {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin: 15px 0;
        }
        .leyenda-asistencia-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        .leyenda-badge {
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 13px;
        }
        .mes-tab {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: white;
            border: 2px solid #4472C4;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #4472C4;
        }
        .mes-tab.activo {
            background: #4472C4;
            color: white;
        }
        .mes-tab:hover {
            background: #e3f2fd;
        }
        .mes-tab.activo:hover {
            background: #365a99;
        }
        
        /* ==================== ESTILOS PARA MODALES ==================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal.activo {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-contenido {
            background-color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            font-size: 14px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4472C4;
        }
        .modal-header h2 {
            margin: 0;
            color: #4472C4;
            font-size: 20px;
        }
        .modal-close {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
        }
        .modal-close:hover {
            background: #c82333;
        }
        .asistencia-encabezado {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .dia-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .dia-selector label {
            font-size: 14px;
        }
        .dia-selector span {
            font-size: 14px;
        }
        .dia-selector input {
            padding: 8px;
            border: 2px solid #4472C4;
            border-radius: 5px;
            font-size: 14px;
            width: 80px;
        }
        .opciones-masivas {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .opcion-masiva {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .opcion-masiva:hover {
            border-color: #4472C4;
            background: #f0f7ff;
        }
        .opcion-masiva input[type="radio"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .opcion-masiva label {
            cursor: pointer;
            font-weight: bold;
            margin: 0;
            font-size: 13px;
        }
        .lista-estudiantes-modal {
            display: grid;
            gap: 8px;
            margin-top: 15px;
        }
        .estudiante-row {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            transition: all 0.3s;
        }
        .estudiante-row:hover {
            border-color: #4472C4;
            background: #f8f9fa;
        }
        .estudiante-nombre {
            flex: 1;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .estudiante-num {
            background: #4472C4;
            color: white;
            padding: 4px 10px;
            border-radius: 5px;
            margin-right: 12px;
            font-weight: bold;
            font-size: 13px;
        }
        .estudiante-opciones {
            display: flex;
            gap: 8px;
        }
        .radio-option {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .radio-option input[type="radio"] {
            width: 15px;
            height: 15px;
            cursor: pointer;
        }
        .radio-option label {
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
        }
        .radio-option.opcion-P {
            background: #d4edda;
            border: 2px solid #28a745;
        }
        .radio-option.opcion-T {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }
        .radio-option.opcion-E {
            background: #ffe5d0;
            border: 2px solid #fd7e14;
        }
        .radio-option.opcion-A {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }
        .modal-acciones {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            transition: all 0.3s;
        }
        .btn-modal.success {
            background: #28a745;
            color: white;
        }
        .btn-modal.success:hover {
            background: #218838;
        }
        .btn-modal.secondary {
            background: #6c757d;
            color: white;
        }
        .btn-modal.secondary:hover {
            background: #5a6268;
        }
        .selector-dia-ver {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }
        .dia-btn {
            padding: 12px;
            border: 2px solid #4472C4;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
        }
        .dia-btn:hover {
            background: #4472C4;
            color: white;
        }
        .dia-btn.sin-datos {
            opacity: 0.3;
            cursor: not-allowed;
            background: #f5f5f5;
        }
        .tabla-ver-asistencia {
            margin-top: 20px;
        }
        .tabla-ver-asistencia h3 {
            font-size: 16px;
        }
        .tabla-ver-asistencia table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .tabla-ver-asistencia th,
        .tabla-ver-asistencia td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        .tabla-ver-asistencia th {
            background: #4472C4;
            color: white;
            font-weight: bold;
            font-size: 13px;
        }
        .tabla-ver-asistencia tr:nth-child(even) {
            background: #f8f9fa;
        }
        /* ==================== FIN ESTILOS MODALES ==================== */
        
        .resumen-asistencia {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .resumen-asistencia h3 {
            color: #1F4E78;
            margin-bottom: 15px;
        }
        .stats-asistencia {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .stat-asistencia {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .stat-asistencia .numero {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-asistencia .label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Instrumento de Evaluaci√≥n</h1>
            <p>Sistema Completo con Estad√≠sticas</p>
        </div>
        
        <div class="toolbar">
            <div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">
                <div style="display:flex;align-items:center;gap:10px;">
                    <button class="btn-toolbar" onclick="guardarExcel()">üíæ Guardar Excel</button>
                    <button class="btn-toolbar btn-secondary" onclick="document.getElementById('archivoExcel').click()">üìÇ Cargar Excel</button>
                    <button class="btn-toolbar btn-warning" onclick="abrirModalPDF()">üìÑ Exportar PDF</button>
                    <input type="file" id="archivoExcel" accept=".xlsx" onchange="cargarExcel(event)">
                </div>
                <div style="flex:1;text-align:right;">
                    <span id="indicadorGuardado" style="font-weight:bold;font-size:13px;padding:8px 15px;background:white;border-radius:8px;border:2px solid #e0e0e0;">
                        ‚ö™ Cargando...
                    </span>
                </div>
            </div>
        </div>
        
        <div class="nav">
            <button onclick="cambiarPantalla('inicio')" class="active">üè† Inicio</button>
            <button onclick="cambiarPantalla('estudiantes')">üë• Estudiantes</button>
            <button onclick="cambiarPantalla('asistencia')">üìÖ Asistencia</button>
            <button onclick="cambiarPantalla('ruleta')">üéØ Ruleta</button>
            
            <div class="nav-dropdown">
                <button id="btnCalificaciones">üìö Calificaciones ‚ñº</button>
                <div class="dropdown-content">
                    <button onclick="cambiarPantallaDropdown('bloque1')">üìò Bloque I</button>
                    <button onclick="cambiarPantallaDropdown('bloque2')">üìó Bloque II</button>
                    <button onclick="cambiarPantallaDropdown('bloque3')">üìô Bloque III</button>
                    <button onclick="cambiarPantallaDropdown('bloque4')">üìï Bloque IV</button>
                    <button onclick="cambiarPantallaDropdown('reporte')" style="color:#28a745;font-weight:bold;">üìã Reporte Final</button>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div id="inicio" class="pantalla activa">
                <div class="seccion">
                    <h2>üìã Informaci√≥n General</h2>
                    <div class="info-grid">
                        <div class="campo">
                            <label>Centro Educativo:</label>
                            <input type="text" value="Alberto Feliz Bello" readonly style="background:#f0f0f0;cursor:not-allowed;">
                        </div>
                        <div class="campo">
                            <label>Maestro/a:</label>
                            <input type="text" value="Luis Abel G√≥mez F√©liz" readonly style="background:#f0f0f0;cursor:not-allowed;">
                        </div>
                        <div class="campo">
                            <label>Asignatura:</label>
                            <input type="text" value="Educaci√≥n F√≠sica" readonly style="background:#f0f0f0;cursor:not-allowed;">
                        </div>
                        <div class="campo">
                            <label>üéì Grado:</label>
                            <select id="gradoSelect" onchange="cambiarGradoSeccion(this.value, document.getElementById('seccionSelect').value)" style="padding:10px;border:2px solid #4CAF50;border-radius:5px;font-size:14px;font-weight:bold;">
                                <option value="1ro">1ro</option>
                                <option value="2do">2do</option>
                                <option value="3ro">3ro</option>
                                <option value="4to">4to</option>
                                <option value="5to">5to</option>
                                <option value="6to">6to</option>
                            </select>
                        </div>
                        <div class="campo">
                            <label>üìù Secci√≥n:</label>
                            <select id="seccionSelect" onchange="cambiarGradoSeccion(document.getElementById('gradoSelect').value, this.value)" style="padding:10px;border:2px solid #2196F3;border-radius:5px;font-size:14px;font-weight:bold;">
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                            </select>
                        </div>
                        <div class="campo">
                            <label>A√±o Escolar:</label>
                            <input type="text" value="2025 - 2026" readonly style="background:#f0f0f0;cursor:not-allowed;">
                        </div>
                    </div>
                    <div style="margin-top:15px;padding:15px;background:#e3f2fd;border-left:4px solid #2196F3;border-radius:5px;">
                        <strong>üí° Info:</strong> Selecciona el grado y secci√≥n para trabajar. Los datos de cada secci√≥n se guardan independientemente.
                    </div>
                </div>
                
                <div class="seccion">
                    <h2>üìä Estad√≠sticas del Curso</h2>
                    <div class="stats-grid" id="statsGrid"></div>
                    
                    <div class="charts-container">
                        <div class="chart-container">
                            <canvas id="chartAprobados" width="200" height="200"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="chartPromedios" width="400" height="200"></canvas>
                        </div>
                    </div>
                    
                    <div class="top-estudiantes">
                        <h3>üèÜ Top 10 Mejores Calificaciones</h3>
                        <ul class="top-list" id="topEstudiantes"></ul>
                    </div>
                </div>
                
                <div class="seccion" style="background:#fff3e0;border:2px solid #ff9800;">
                    <h2>üíæ Gesti√≥n de Datos</h2>
                    <div style="display:grid;gap:15px;">
                        <div style="background:white;padding:15px;border-radius:8px;">
                            <h4 style="margin:0 0 10px 0;color:#ff9800;">üìä Estado de Guardado Autom√°tico</h4>
                            <p style="margin:0;color:#666;font-size:14px;">
                                Los datos se guardan autom√°ticamente cada vez que realizas cambios (agregar estudiantes, tomar asistencia, calificar, etc.).
                            </p>
                            <div style="margin-top:15px;padding:15px;background:#f8f9fa;border-radius:8px;border-left:4px solid #28a745;">
                                <strong>Estado actual:</strong> <span id="estadoGuardadoDetalle" style="color:#28a745;font-weight:bold;">‚úì Datos guardados</span>
                            </div>
                        </div>
                        
                        <div style="background:white;padding:15px;border-radius:8px;">
                            <h4 style="margin:0 0 10px 0;color:#ff9800;">üìÇ Backup Manual</h4>
                            <p style="margin:0;color:#666;font-size:14px;margin-bottom:15px;">
                                Aunque los datos se guardan autom√°ticamente, se recomienda crear backups en Excel peri√≥dicamente.
                            </p>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <button class="btn-asistencia success" onclick="guardarExcel()" style="font-size:14px;">
                                    üíæ Crear Backup (Excel)
                                </button>
                                <button class="btn-asistencia" onclick="document.getElementById('archivoExcel').click()" style="font-size:14px;">
                                    üìÇ Cargar Backup
                                </button>
                            </div>
                        </div>
                        
                        <div style="background:white;padding:15px;border-radius:8px;border:2px solid#4472C4;">
                            <h4 style="margin:0 0 10px 0;color:#4472C4;">üìö Importar Word Multigrado</h4>
                            <p style="margin:0;color:#666;font-size:14px;margin-bottom:15px;">
                                Importa un archivo Word con <strong>TODOS los grados</strong> (1ro-6to). El sistema aplicar√° autom√°ticamente los estudiantes correspondientes a cada grado/secci√≥n.
                            </p>
                            <button class="btn-asistencia" onclick="document.getElementById('archivoWordMultigrado').click()" style="background:#4472C4;border-color:#4472C4;font-size:14px;">
                                üìÑ Importar Word Multigrado
                            </button>
                            <input type="file" id="archivoWordMultigrado" accept=".docx" onchange="importarWordMultigrado(event)" style="display:none;">
                            <div style="margin-top:10px;padding:10px;background:#e3f2fd;border-radius:5px;font-size:12px;">
                                <strong>Formato esperado:</strong> El Word debe tener secciones claramente marcadas como "1RO", "2DO", "3RO", etc., seguidas de las listas de estudiantes.
                            </div>
                        </div>
                        
                        <div style="background:#ffebee;padding:15px;border-radius:8px;border:2px solid #f44336;">
                            <h4 style="margin:0 0 10px 0;color:#c62828;">üóëÔ∏è Zona Peligrosa</h4>
                            <p style="margin:0;color:#666;font-size:14px;margin-bottom:15px;">
                                <strong>‚ö†Ô∏è Advertencia:</strong> Estas acciones eliminar√°n datos. Aseg√∫rate de tener un backup antes de continuar.
                            </p>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <button class="btn-asistencia" onclick="resetearValoresEjemplo()" style="background:#ff9800;border-color:#ff9800;font-size:14px;">
                                    üîÑ Resetear a Valores de Ejemplo
                                </button>
                                <button class="btn-asistencia" onclick="limpiarDatosLocalStorage()" style="background:#f44336;border-color:#f44336;font-size:14px;">
                                    üóëÔ∏è Limpiar Todos los Datos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="estudiantes" class="pantalla">
                <div class="seccion">
                    <h2>üë• Lista de Estudiantes</h2>
                    <div class="lista-estudiantes" id="listaEstudiantes"></div>
                    <div class="btn-group">
                        <button class="btn-agregar" onclick="agregarEstudiante()">‚ûï Agregar Estudiante</button>
                        <button class="btn-agregar" style="background: #4472C4;" onclick="document.getElementById('archivoWord').click()">üìÑ Importar desde Word</button>
                    </div>
                    <input type="file" id="archivoWord" accept=".docx" onchange="importarWord(event)">
                </div>
            </div>
            
            <div id="asistencia" class="pantalla">
                <div class="seccion">
                    <h2>üìÖ Control de Asistencia</h2>
                    
                    <div class="asistencia-header">
                        <div class="asistencia-controles">
                            <label>Mes:</label>
                            <select id="mesAsistencia" onchange="cambiarMesAsistencia()">
                                <option value="8">Agosto</option>
                                <option value="9">Septiembre</option>
                                <option value="10">Octubre</option>
                                <option value="11">Noviembre</option>
                                <option value="12">Diciembre</option>
                                <option value="1">Enero</option>
                                <option value="2">Febrero</option>
                                <option value="3">Marzo</option>
                                <option value="4">Abril</option>
                                <option value="5">Mayo</option>
                                <option value="6">Junio</option>
                            </select>
                            
                            <label>A√±o:</label>
                            <input type="number" id="anioAsistencia" min="2020" max="2030" value="2025" onchange="cambiarMesAsistencia()">
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:15px;flex-wrap:wrap;margin:20px 0;">
                        <button class="btn-asistencia success" onclick="abrirModalTomarAsistencia()" style="font-size:16px;">
                            ‚úèÔ∏è Tomar Asistencia
                        </button>
                        <button class="btn-asistencia" onclick="abrirModalVerAsistencia()" style="font-size:16px;">
                            üëÅÔ∏è Ver Asistencia del Mes
                        </button>
                        <button class="btn-asistencia" onclick="abrirModalEditarAsistencia()" style="font-size:16px;">
                            ‚úèÔ∏è Editar Asistencia
                        </button>
                        <button class="btn-asistencia" onclick="exportarAsistenciaPDF()" style="font-size:16px;">
                            üìÑ Exportar Mes (PDF)
                        </button>
                    </div>
                    
                    <div class="leyenda-asistencia" style="margin-top:20px;">
                        <div class="leyenda-asistencia-item">
                            <span class="leyenda-badge" style="background:#d4edda;color:#155724;font-weight:bold;">P</span>
                            <span>Presente</span>
                        </div>
                        <div class="leyenda-asistencia-item">
                            <span class="leyenda-badge" style="background:#fff3cd;color:#856404;font-weight:bold;">T</span>
                            <span>Tardanza (1ra y 2da = P, 3ra = A)</span>
                        </div>
                        <div class="leyenda-asistencia-item">
                            <span class="leyenda-badge" style="background:#ffe5d0;color:#833c00;font-weight:bold;">E</span>
                            <span>Excusa (1ra y 2da = P, 3ra = A)</span>
                        </div>
                        <div class="leyenda-asistencia-item">
                            <span class="leyenda-badge" style="background:#f8d7da;color:#721c24;font-weight:bold;">A</span>
                            <span>Ausencia</span>
                        </div>
                    </div>
                    
                    <div class="resumen-asistencia" style="margin-top:30px;">
                        <h3>üìä Resumen del Mes</h3>
                        <div class="stats-asistencia" id="statsAsistencia"></div>
                    </div>
                    
                    <div style="text-align:center;margin-top:30px;">
                        <button class="btn-asistencia" onclick="abrirModalVerAnual()" style="font-size:16px;padding:15px 30px;background:#4472C4;color:white;">
                            üìà Ver Resumen Anual
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- MODAL TOMAR ASISTENCIA -->
            <div id="modalTomarAsistencia" class="modal">
                <div class="modal-contenido" style="max-width:1200px;">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Tomar Asistencia</h2>
                        <button class="modal-close" onclick="cerrarModal('modalTomarAsistencia')">‚úï</button>
                    </div>
                    
                    <div class="asistencia-encabezado">
                        <div class="dia-selector">
                            <label style="font-weight:bold;font-size:16px;">D√≠a del mes:</label>
                            <input type="number" id="diaTomarAsistencia" min="1" max="31" value="1" style="font-size:18px;width:80px;">
                            <span id="mesAnioTomarLabel" style="font-weight:bold;color:#4472C4;"></span>
                        </div>
                        
                        <div style="margin-top:15px;">
                            <label style="font-weight:bold;display:block;margin-bottom:10px;">Marcar todos como:</label>
                            <div class="opciones-masivas">
                                <div class="opcion-masiva" onclick="marcarTodos('P')" style="border-color:#28a745;background:#d4edda;">
                                    <input type="radio" name="todosMasivo" value="P">
                                    <label>‚úì Todos Presentes (P)</label>
                                </div>
                                <div class="opcion-masiva" onclick="marcarTodos('A')" style="border-color:#dc3545;background:#f8d7da;">
                                    <input type="radio" name="todosMasivo" value="A">
                                    <label>‚úó Todos Ausentes (A)</label>
                                </div>
                                <div class="opcion-masiva" onclick="marcarTodos('T')" style="border-color:#ffc107;background:#fff3cd;">
                                    <input type="radio" name="todosMasivo" value="T">
                                    <label>‚è∞ Todos Tarde (T)</label>
                                </div>
                                <div class="opcion-masiva" onclick="marcarTodos('E')" style="border-color:#fd7e14;background:#ffe5d0;">
                                    <input type="radio" name="todosMasivo" value="E">
                                    <label>üìù Todos Excusa (E)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lista-estudiantes-modal" id="listaTomarAsistencia"></div>
                    
                    <div class="modal-acciones">
                        <button class="btn-modal secondary" onclick="cerrarModal('modalTomarAsistencia')">Cancelar</button>
                        <button class="btn-modal success" onclick="guardarAsistenciaTomada()">üíæ Guardar Asistencia</button>
                    </div>
                </div>
            </div>
            
            <!-- MODAL VER ASISTENCIA -->
            <div id="modalVerAsistencia" class="modal">
                <div class="modal-contenido" style="max-width:1000px;">
                    <div class="modal-header">
                        <h2>üëÅÔ∏è Ver Asistencia del Mes</h2>
                        <button class="modal-close" onclick="cerrarModal('modalVerAsistencia')">‚úï</button>
                    </div>
                    
                    <div style="text-align:center;margin-bottom:20px;">
                        <h3 id="tituloVerMes" style="color:#4472C4;"></h3>
                        <p style="color:#666;">Selecciona un d√≠a para ver la asistencia</p>
                    </div>
                    
                    <div class="selector-dia-ver" id="selectorDiasVer"></div>
                    
                    <div class="tabla-ver-asistencia" id="tablaVerDia" style="display:none;"></div>
                </div>
            </div>
            
            <!-- MODAL EDITAR ASISTENCIA -->
            <div id="modalEditarAsistencia" class="modal">
                <div class="modal-contenido" style="max-width:1200px;">
                    <div class="modal-header">
                        <h2>‚úèÔ∏è Editar Asistencia</h2>
                        <button class="modal-close" onclick="cerrarModal('modalEditarAsistencia')">‚úï</button>
                    </div>
                    
                    <div class="asistencia-encabezado">
                        <div class="dia-selector">
                            <label style="font-weight:bold;font-size:16px;">Seleccionar d√≠a:</label>
                            <select id="diaEditarSelect" onchange="cargarDiaEditar()" style="padding:10px;font-size:16px;border:2px solid #4472C4;border-radius:5px;">
                                <option value="">-- Seleccione un d√≠a --</option>
                            </select>
                            <span id="mesAnioEditarLabel" style="font-weight:bold;color:#4472C4;"></span>
                        </div>
                    </div>
                    
                    <div class="lista-estudiantes-modal" id="listaEditarAsistencia"></div>
                    
                    <div class="modal-acciones">
                        <button class="btn-modal secondary" onclick="cerrarModal('modalEditarAsistencia')">Cancelar</button>
                        <button class="btn-modal success" onclick="guardarAsistenciaEditada()">üíæ Guardar Cambios</button>
                    </div>
                </div>
            </div>
            
            <!-- MODAL VER ANUAL -->
            <div id="modalVerAnual" class="modal">
                <div class="modal-contenido" style="max-width:95%;">
                    <div class="modal-header">
                        <h2>üìà Resumen Anual de Asistencia</h2>
                        <button class="modal-close" onclick="cerrarModal('modalVerAnual')">‚úï</button>
                    </div>
                    
                    <div style="text-align:center;margin:20px 0;">
                        <button class="btn-modal success" onclick="exportarResumenAnualPDF()">üìÑ Exportar Resumen Anual (PDF)</button>
                    </div>
                    
                    <div id="contenidoAnual"></div>
                </div>
            </div>
            
            <div id="ruleta" class="pantalla">
                <div class="seccion">
                    <h2>üéØ Ruleta de Estudiantes</h2>
                    
                    <div class="ruleta-container">
                        <div class="ruleta-canvas-wrapper">
                            <div class="ruleta-pointer">üîª</div>
                            <canvas id="ruletaCanvas" class="ruleta-canvas" width="500" height="500"></canvas>
                            <div class="ruleta-center">üéØ</div>
                        </div>
                        
                        <div class="ruleta-controles">
                            <button class="btn-ruleta btn-girar" onclick="girarRuleta()" id="btnGirar">üé≤ GIRAR RULETA</button>
                            <button class="btn-ruleta btn-eliminar-ruleta" onclick="eliminarSeleccionado()" id="btnEliminar" style="display:none;">‚ùå Eliminar del Sorteo</button>
                            <button class="btn-ruleta btn-restaurar" onclick="restaurarRuleta()">üîÑ Restaurar Todos</button>
                        </div>
                        
                        <div class="resultado-ruleta" id="resultadoRuleta" style="display:none;">
                            <h2>üéâ ¬°Seleccionado!</h2>
                            <div class="nombre-seleccionado" id="nombreSeleccionado"></div>
                        </div>
                        
                        <div class="estudiantes-restantes">
                            <h3>Estudiantes en la Ruleta (<span id="contadorRestantes">0</span>)</h3>
                            <div class="lista-restantes" id="listaRestantes"></div>
                        </div>
                    </div>
                </div>
                
                <div class="seccion">
                    <h2>üë• Generador de Grupos Aleatorios</h2>
                    
                    <div class="grupos-container">
                        <div class="grupo-config">
                            <label>N√∫mero de integrantes por grupo:</label>
                            <input type="number" id="numIntegrantes" min="2" max="10" value="4">
                            <button class="btn-generar-grupos" onclick="generarGrupos()">üé≤ Generar Grupos</button>
                        </div>
                        
                        <div id="gruposExportContainer" style="display:none;">
                            <div class="grupo-config" style="background:#e3f2fd;">
                                <label style="color:#1F4E78;">üì§ Exportar Grupos:</label>
                                <button class="btn-generar-grupos" style="background:#4472C4;" onclick="exportarGruposPDF()">üìÑ PDF</button>
                                <button class="btn-generar-grupos" style="background:#70AD47;" onclick="exportarGruposExcel()">üìä Excel</button>
                                <button class="btn-generar-grupos" style="background:#FF9800;" onclick="copiarGrupos()">üìã Copiar Texto</button>
                            </div>
                        </div>
                        
                        <div class="grupos-resultado" id="gruposResultado"></div>
                    </div>
                </div>
            </div>
            
            <div id="bloque1" class="pantalla"></div>
            <div id="bloque2" class="pantalla"></div>
            <div id="bloque3" class="pantalla"></div>
            <div id="bloque4" class="pantalla"></div>
            
            <div id="reporte" class="pantalla">
                <div class="seccion">
                    <h2>üìã Reporte Final Consolidado</h2>
                    
                    <div class="info-box">
                        <h3>üìà C√°lculo de Promedios con Recuperaciones</h3>
                        <p><strong>Columnas RP:</strong> Se muestran SOLO para estudiantes con calificaci√≥n menor a 70</p>
                        <p><strong>Edici√≥n de RP:</strong> Usa los botones de abajo (Recuperaci√≥n P1, P2, P3, P4)</p>
                        <p><strong>C√°lculo por Per√≠odo:</strong> Se toma la calificaci√≥n M√ÅS ALTA entre P y RP</p>
                        <p><strong>Promedio por Bloque:</strong> (P1 + P2 + P3 + P4) / 4 - SIEMPRE divide entre 4</p>
                        <p><strong>Promedio Final:</strong> (PB1 + PB2 + PB3 + PB4) / 4 - SIEMPRE divide entre 4</p>
                        <p><strong>Condici√≥n:</strong> APROBADO (‚â•70) o REPROBADO (<70)</p>
                    </div>
                    
                    <div class="leyenda-reporte">
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background:#dae8fc;border-left:3px solid #4472C4"></div>
                            <span>Bloque I</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background:#d5e8d4;border-left:3px solid #70AD47"></div>
                            <span>Bloque II</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background:#fff2cc;border-left:3px solid #FFC000"></div>
                            <span>Bloque III</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background:#f8cecc;border-left:3px solid #E74C3C"></div>
                            <span>Bloque IV</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background:#fff3cd;border-left:3px solid #ffc107"></div>
                            <span>Promedios Bloques</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background:#d4edda;border-left:3px solid #28a745"></div>
                            <span>Final / Aprobado</span>
                        </div>
                        <div class="leyenda-item">
                            <div class="leyenda-color" style="background:#f8d7da"></div>
                            <span>Reprobado</span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <div id="tablaReporte"></div>
                    </div>
                    
                    <!-- SECCI√ìN RECUPERACIONES -->
                    <div class="seccion" style="margin-top:30px;">
                        <h2>üîÑ Calificaciones de Recuperaci√≥n (RP)</h2>
                        <p style="margin-bottom:15px;">Ingresa las calificaciones de recuperaci√≥n para cada per√≠odo. El sistema tomar√° autom√°ticamente la calificaci√≥n m√°s alta entre el per√≠odo original y su recuperaci√≥n.</p>
                        
                        <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:15px; margin-bottom:20px;">
                            <button class="btn-toolbar" onclick="mostrarRecuperacion(1)" style="border-color:#4472C4; color:#4472C4;">
                                üìò Recuperaci√≥n P1
                            </button>
                            <button class="btn-toolbar" onclick="mostrarRecuperacion(2)" style="border-color:#70AD47; color:#70AD47;">
                                üìó Recuperaci√≥n P2
                            </button>
                            <button class="btn-toolbar" onclick="mostrarRecuperacion(3)" style="border-color:#FFC000; color:#FFC000;">
                                üìô Recuperaci√≥n P3
                            </button>
                            <button class="btn-toolbar" onclick="mostrarRecuperacion(4)" style="border-color:#E74C3C; color:#E74C3C;">
                                üìï Recuperaci√≥n P4
                            </button>
                        </div>
                        
                        <div id="contenedorRecuperacion"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="modalPDF" class="modal">
        <div class="modal-contenido">
            <h2>üìÑ Exportar a PDF</h2>
            <p>Selecciona qu√© deseas exportar:</p>
            <div class="opciones-pdf">
                <button onclick="exportarPDF('final')">üìã Solo Reporte Final</button>
                <button onclick="exportarPDF(1)">üìò Solo Bloque I</button>
                <button onclick="exportarPDF(2)">üìó Solo Bloque II</button>
                <button onclick="exportarPDF(3)">üìô Solo Bloque III</button>
                <button onclick="exportarPDF(4)">üìï Solo Bloque IV</button>
            </div>
            <button class="btn-cerrar" onclick="cerrarModalPDF()">Cancelar</button>
        </div>
    </div>
    
    <div class="mensaje" id="mensaje"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    
    <script>
        // Verificar que las bibliotecas se cargaron correctamente
        window.addEventListener('load', function() {
            console.log('üîç Verificando bibliotecas...');
            console.log('XLSX:', typeof XLSX !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('jsPDF:', typeof window.jspdf !== 'undefined' ? '‚úÖ' : '‚ùå');
            console.log('mammoth:', typeof mammoth !== 'undefined' ? '‚úÖ' : '‚ùå');
            
            if (typeof window.jspdf !== 'undefined') {
                const { jsPDF } = window.jspdf;
                const testDoc = new jsPDF();
                console.log('autoTable:', typeof testDoc.autoTable === 'function' ? '‚úÖ' : '‚ùå');
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script>
        var NOTAS = {'A+':100,'A':94,'A-':90,'B+':87,'B':84,'B-':80,'C+':77,'C':74,'C-':70,'D+':67,'D':64,'D-':60,'F':50};
        
        // ESTRUCTURA MULTIGRADO - FIREBASE READY
        var datosMultigrado = {
            grados: {
                "1ro": { secciones: {} },
                "2do": { secciones: {} },
                "3ro": { secciones: {} },
                "4to": { secciones: {} },
                "5to": { secciones: {} },
                "6to": { secciones: {} }
            },
            gradoActual: "1ro",
            seccionActual: "A"
        };
        
        // Funci√≥n para obtener estructura base de una secci√≥n
        function crearEstructuraSeccion() {
            return {
                estudiantes: [],
                bloques: [
                    {
                        comp:[],
                        periodos: {
                            1: {indicadores:[], cal:{}, fechasHeader:{}},
                            2: {indicadores:[], cal:{}, fechasHeader:{}},
                            3: {indicadores:[], cal:{}, fechasHeader:{}},
                            4: {indicadores:[], cal:{}, fechasHeader:{}}
                        },
                        recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                    },
                    {
                        comp:[],
                        periodos: {
                            1: {indicadores:[], cal:{}, fechasHeader:{}},
                            2: {indicadores:[], cal:{}, fechasHeader:{}},
                            3: {indicadores:[], cal:{}, fechasHeader:{}},
                            4: {indicadores:[], cal:{}, fechasHeader:{}}
                        },
                        recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                    },
                    {
                        comp:[],
                        periodos: {
                            1: {indicadores:[], cal:{}, fechasHeader:{}},
                            2: {indicadores:[], cal:{}, fechasHeader:{}},
                            3: {indicadores:[], cal:{}, fechasHeader:{}},
                            4: {indicadores:[], cal:{}, fechasHeader:{}}
                        },
                        recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                    },
                    {
                        comp:[],
                        periodos: {
                            1: {indicadores:[], cal:{}, fechasHeader:{}},
                            2: {indicadores:[], cal:{}, fechasHeader:{}},
                            3: {indicadores:[], cal:{}, fechasHeader:{}},
                            4: {indicadores:[], cal:{}, fechasHeader:{}}
                        },
                        recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                    }
                ]
            };
        }
        
        // DATOS ACTUALES (apunta a la secci√≥n activa)
        var datos = {
            info: {centro:'Alberto Feliz Bello', maestro:'Luis Abel G√≥mez F√©liz', asignatura:'Educaci√≥n F√≠sica', grado:'1ro', seccion:'A', anio:'2025 - 2026'},
            estudiantes: [],
            bloques: [
                {
                    comp:[],
                    periodos: {
                        1: {indicadores:[], cal:{}, fechasHeader:{}},
                        2: {indicadores:[], cal:{}, fechasHeader:{}},
                        3: {indicadores:[], cal:{}, fechasHeader:{}},
                        4: {indicadores:[], cal:{}, fechasHeader:{}}
                    },
                    recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                },
                {
                    comp:[],
                    periodos: {
                        1: {indicadores:[], cal:{}, fechasHeader:{}},
                        2: {indicadores:[], cal:{}, fechasHeader:{}},
                        3: {indicadores:[], cal:{}, fechasHeader:{}},
                        4: {indicadores:[], cal:{}, fechasHeader:{}}
                    },
                    recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                },
                {
                    comp:[],
                    periodos: {
                        1: {indicadores:[], cal:{}, fechasHeader:{}},
                        2: {indicadores:[], cal:{}, fechasHeader:{}},
                        3: {indicadores:[], cal:{}, fechasHeader:{}},
                        4: {indicadores:[], cal:{}, fechasHeader:{}}
                    },
                    recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                },
                {
                    comp:[],
                    periodos: {
                        1: {indicadores:[], cal:{}, fechasHeader:{}},
                        2: {indicadores:[], cal:{}, fechasHeader:{}},
                        3: {indicadores:[], cal:{}, fechasHeader:{}},
                        4: {indicadores:[], cal:{}, fechasHeader:{}}
                    },
                    recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
                }
            ]
        };
        
        // FUNCIONES MULTIGRADO
        function cambiarGradoSeccion(grado, seccion) {
            // Guardar datos actuales (estudiantes, bloques Y asistencia)
            guardarSeccionActual();
            guardarAsistenciaActual();
            
            // Cambiar a nuevo grado/secci√≥n
            datosMultigrado.gradoActual = grado;
            datosMultigrado.seccionActual = seccion;
            
            // Cargar datos del nuevo grado/secci√≥n
            cargarSeccion(grado, seccion);
            cargarAsistenciaSeccion(grado, seccion);
            
            // Actualizar interfaz
            datos.info.grado = grado;
            datos.info.seccion = seccion;
            document.getElementById('gradoSelect').value = grado;
            document.getElementById('seccionSelect').value = seccion;
            
            // Re-renderizar todo
            renderEstudiantes();
            renderBloques();
            renderEstadisticas();
            if(document.getElementById('inicio').classList.contains('activa')) {
                // Si estamos en inicio, no hacer nada m√°s
            } else if(document.getElementById('asistencia').classList.contains('activa')) {
                renderResumenMes(); // Si estamos en asistencia, actualizar
            }
            
            // Guardar en localStorage
            guardarDatosLocalStorage();
            
            mostrarMensaje('‚úì Cambiado a ' + grado + ' - Secci√≥n ' + seccion);
        }
        
        function guardarSeccionActual() {
            var grado = datosMultigrado.gradoActual;
            var seccion = datosMultigrado.seccionActual;
            
            if(!datosMultigrado.grados[grado].secciones[seccion]) {
                datosMultigrado.grados[grado].secciones[seccion] = crearEstructuraSeccion();
            }
            
            datosMultigrado.grados[grado].secciones[seccion].estudiantes = JSON.parse(JSON.stringify(datos.estudiantes));
            datosMultigrado.grados[grado].secciones[seccion].bloques = JSON.parse(JSON.stringify(datos.bloques));
        }
        
        function cargarSeccion(grado, seccion) {
            if(!datosMultigrado.grados[grado].secciones[seccion]) {
                datosMultigrado.grados[grado].secciones[seccion] = crearEstructuraSeccion();
            }
            
            var seccionData = datosMultigrado.grados[grado].secciones[seccion];
            datos.estudiantes = JSON.parse(JSON.stringify(seccionData.estudiantes));
            datos.bloques = JSON.parse(JSON.stringify(seccionData.bloques));
        }
        
        // GUARDAR/CARGAR MULTIGRADO EN LOCALSTORAGE
        function guardarDatosLocalStorage() {
            // Primero guardar la secci√≥n actual en la estructura multigrado
            guardarSeccionActual();
            guardarAsistenciaActual();
            
            // Guardar toda la estructura multigrado
            try {
                localStorage.setItem('educoco_multigrado', JSON.stringify(datosMultigrado));
                localStorage.setItem('educoco_asistencia_multigrado', JSON.stringify(asistenciaMultigrado));
                
                var estadoElem = document.getElementById('estadoGuardadoDetalle');
                if(estadoElem) {
                    estadoElem.textContent = '‚úì Datos guardados';
                    estadoElem.style.color = '#28a745';
                }
            } catch(error) {
                console.error('Error guardando en localStorage:', error);
                mostrarMensaje('‚ö†Ô∏è Error al guardar datos', true);
            }
        }
        
        function cargarDatosDesdeLocalStorage() {
            try {
                // Cargar estructura multigrado
                var datosGuardados = localStorage.getItem('educoco_multigrado');
                if(datosGuardados) {
                    var temp = JSON.parse(datosGuardados);
                    
                    // Cargar grados y secciones
                    datosMultigrado = temp;
                    
                    // Asegurar que existen todos los grados
                    var todosGrados = ["1ro", "2do", "3ro", "4to", "5to", "6to"];
                    for(var g=0; g<todosGrados.length; g++) {
                        if(!datosMultigrado.grados[todosGrados[g]]) {
                            datosMultigrado.grados[todosGrados[g]] = {secciones: {}};
                        }
                    }
                    
                    // Cargar la secci√≥n actual
                    cargarSeccion(datosMultigrado.gradoActual, datosMultigrado.seccionActual);
                    
                    // Actualizar selectores
                    document.getElementById('gradoSelect').value = datosMultigrado.gradoActual;
                    document.getElementById('seccionSelect').value = datosMultigrado.seccionActual;
                    
                    console.log('‚úÖ Datos multigrado cargados desde LocalStorage');
                }
                
                // Cargar asistencia multigrado
                var asistenciaGuardada = localStorage.getItem('educoco_asistencia_multigrado');
                if(asistenciaGuardada) {
                    var tempAsist = JSON.parse(asistenciaGuardada);
                    asistenciaMultigrado = tempAsist;
                    
                    // Asegurar estructura para todos los grados
                    var todosGrados = ["1ro", "2do", "3ro", "4to", "5to", "6to"];
                    for(var g=0; g<todosGrados.length; g++) {
                        if(!asistenciaMultigrado.grados[todosGrados[g]]) {
                            asistenciaMultigrado.grados[todosGrados[g]] = {secciones: {}};
                        }
                    }
                    
                    // Cargar asistencia de la secci√≥n actual
                    cargarAsistenciaSeccion(datosMultigrado.gradoActual, datosMultigrado.seccionActual);
                } else {
                    // Migrar asistencia antigua si existe
                    var asistenciaAntigua = localStorage.getItem('educoco_asistencia');
                    if(asistenciaAntigua) {
                        var tempOld = JSON.parse(asistenciaAntigua);
                        Object.assign(asistencia, tempOld);
                        guardarAsistenciaActual(); // Guardar en estructura nueva
                    }
                }
                
            } catch(error) {
                console.error('Error cargando datos:', error);
            }
        }
        
        var charts = {
            aprobados: null,
            promedios: null
        };
        
        // VARIABLES RULETA
        var ruleta = {
            estudiantes: [],
            eliminados: [],
            girando: false,
            anguloActual: 0,
            seleccionado: null
        };
        
        // VARIABLE GRUPOS
        var gruposGenerados = [];
        
        // VARIABLE ASISTENCIA
        // ASISTENCIA MULTIGRADO - Independiente por grado/secci√≥n
        var asistenciaMultigrado = {
            grados: {
                "1ro": { secciones: {} },
                "2do": { secciones: {} },
                "3ro": { secciones: {} },
                "4to": { secciones: {} },
                "5to": { secciones: {} },
                "6to": { secciones: {} }
            }
        };
        
        // Asistencia actual (apunta a la secci√≥n activa)
        var asistencia = {
            meses: {},
            mesActual: new Date().getMonth() + 1,
            anioActual: new Date().getFullYear()
        };
        
        // Funci√≥n para crear estructura de asistencia de secci√≥n
        function crearEstructuraAsistencia() {
            return {
                meses: {},
                mesActual: new Date().getMonth() + 1,
                anioActual: new Date().getFullYear()
            };
        }
        
        // Guardar asistencia de la secci√≥n actual en la estructura multigrado
        function guardarAsistenciaActual() {
            var grado = datosMultigrado.gradoActual;
            var seccion = datosMultigrado.seccionActual;
            
            if(!asistenciaMultigrado.grados[grado].secciones[seccion]) {
                asistenciaMultigrado.grados[grado].secciones[seccion] = crearEstructuraAsistencia();
            }
            
            asistenciaMultigrado.grados[grado].secciones[seccion] = JSON.parse(JSON.stringify(asistencia));
        }
        
        // Cargar asistencia de una secci√≥n espec√≠fica
        function cargarAsistenciaSeccion(grado, seccion) {
            if(!asistenciaMultigrado.grados[grado].secciones[seccion]) {
                asistenciaMultigrado.grados[grado].secciones[seccion] = crearEstructuraAsistencia();
            }
            
            asistencia = JSON.parse(JSON.stringify(asistenciaMultigrado.grados[grado].secciones[seccion]));
        }
        
        // ==================== SISTEMA DE LOCALSTORAGE ====================
        
        var estadoGuardado = {
            guardando: false,
            ultimoGuardado: null
        };
        
        function cargarDatosLocalStorage() {
            try {
                const datosGuardados = localStorage.getItem('sistemaEducativo_datos');
                const asistenciaGuardada = localStorage.getItem('sistemaEducativo_asistencia');
                
                if (datosGuardados) {
                    const temp = JSON.parse(datosGuardados);
                    
                    // Cargar info y estudiantes
                    datos.info = temp.info || datos.info;
                    datos.estudiantes = temp.estudiantes || datos.estudiantes;
                    
                    // MIGRAR ESTRUCTURA ANTIGUA A NUEVA
                    if (temp.bloques && temp.bloques.length > 0) {
                        for (var b = 0; b < temp.bloques.length && b < 4; b++) {
                            var bloqueViejo = temp.bloques[b];
                            
                            // Verificar si tiene la estructura antigua (comp con indicadores)
                            if (bloqueViejo.comp && bloqueViejo.comp.length > 0 && bloqueViejo.comp[0].indicadores) {
                                console.log('üîÑ Migrando estructura antigua del bloque ' + (b+1));
                                
                                // Extraer solo las competencias (sin indicadores)
                                datos.bloques[b].comp = [];
                                for (var ci = 0; ci < bloqueViejo.comp.length; ci++) {
                                    datos.bloques[b].comp.push({
                                        competencia: bloqueViejo.comp[ci].competencia
                                    });
                                }
                                
                                // Los indicadores y criterios antiguos SOLO al per√≠odo 1
                                // Los dem√°s per√≠odos se inicializan con valores de ejemplo
                                for (var p = 1; p <= 4; p++) {
                                    datos.bloques[b].periodos[p].cal = {};
                                    datos.bloques[b].periodos[p].fechasHeader = {};
                                    
                                    // Solo per√≠odo 1 recibe los datos antiguos
                                    if (p === 1) {
                                        datos.bloques[b].periodos[p].indicadores = [];
                                        for (var ci = 0; ci < bloqueViejo.comp.length; ci++) {
                                            if (bloqueViejo.comp[ci].indicadores) {
                                                for (var ii = 0; ii < bloqueViejo.comp[ci].indicadores.length; ii++) {
                                                    var indViejo = bloqueViejo.comp[ci].indicadores[ii];
                                                    datos.bloques[b].periodos[p].indicadores.push({
                                                        texto: indViejo.texto,
                                                        criterios: indViejo.criterios.slice() // copiar array
                                                    });
                                                }
                                            }
                                        }
                                    } else {
                                        // Per√≠odos 2, 3, 4 se inicializan con valores de ejemplo
                                        datos.bloques[b].periodos[p].indicadores = [
                                            {
                                                texto: 'Indicador de Bloque ' + (b+1) + ' - Per√≠odo ' + p + ' (Indicador 1)',
                                                criterios: [
                                                    'Criterio 1.1 del Per√≠odo ' + p,
                                                    'Criterio 1.2 del Per√≠odo ' + p
                                                ]
                                            },
                                            {
                                                texto: 'Indicador de Bloque ' + (b+1) + ' - Per√≠odo ' + p + ' (Indicador 2)',
                                                criterios: [
                                                    'Criterio 2.1 del Per√≠odo ' + p
                                                ]
                                            }
                                        ];
                                    }
                                    
                                    // Migrar calificaciones del per√≠odo correspondiente
                                    if (bloqueViejo.cal) {
                                        for (var key in bloqueViejo.cal) {
                                            if (key.includes('_' + p + '_')) {
                                                datos.bloques[b].periodos[p].cal[key] = bloqueViejo.cal[key];
                                            }
                                        }
                                    }
                                    
                                    // Migrar fechas del per√≠odo correspondiente
                                    if (bloqueViejo.fechasHeader) {
                                        for (var key in bloqueViejo.fechasHeader) {
                                            if (key.startsWith(p + '_')) {
                                                datos.bloques[b].periodos[p].fechasHeader[key] = bloqueViejo.fechasHeader[key];
                                            }
                                        }
                                    }
                                }
                            } 
                            // Si ya tiene la estructura nueva, hacer DEEP COPY para evitar referencias compartidas
                            else if (bloqueViejo.periodos) {
                                datos.bloques[b] = JSON.parse(JSON.stringify(bloqueViejo));
                            }
                            
                            // ASEGURAR ESTRUCTURA DE RECUPERACIONES
                            if (!datos.bloques[b].recuperaciones) {
                                datos.bloques[b].recuperaciones = {1:{}, 2:{}, 3:{}, 4:{}};
                            }
                            for (var p = 1; p <= 4; p++) {
                                if (!datos.bloques[b].recuperaciones[p]) {
                                    datos.bloques[b].recuperaciones[p] = {};
                                }
                            }
                        }
                    }
                    
                    estadoGuardado.ultimoGuardado = new Date();
                    console.log('‚úÖ Datos cargados y migrados desde LocalStorage');
                }
                
                if (asistenciaGuardada) {
                    const tempAsist = JSON.parse(asistenciaGuardada);
                    asistencia.meses = tempAsist.meses || asistencia.meses;
                    asistencia.mesActual = tempAsist.mesActual || asistencia.mesActual;
                    asistencia.anioActual = tempAsist.anioActual || asistencia.anioActual;
                }
                
                actualizarIndicadorGuardado();
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarMensaje('‚ö†Ô∏è Error al cargar datos. Limpia los datos en la secci√≥n Inicio.', true);
            }
        }
        
        function guardarDatosLocalStorage() {
            try {
                estadoGuardado.guardando = true;
                actualizarIndicadorGuardado();
                
                // Guardar datos principales
                localStorage.setItem('sistemaEducativo_datos', JSON.stringify({
                    info: datos.info,
                    estudiantes: datos.estudiantes,
                    bloques: datos.bloques
                }));
                
                // Guardar asistencia por separado (puede ser grande)
                localStorage.setItem('sistemaEducativo_asistencia', JSON.stringify(asistencia));
                
                estadoGuardado.guardando = false;
                estadoGuardado.ultimoGuardado = new Date();
                actualizarIndicadorGuardado();
                
                console.log('üíæ Datos guardados en LocalStorage');
            } catch (error) {
                console.error('Error guardando datos:', error);
                estadoGuardado.guardando = false;
                mostrarMensaje('‚ö†Ô∏è Error al guardar. Memoria llena?', true);
            }
        }
        
        function actualizarIndicadorGuardado() {
            const indicador = document.getElementById('indicadorGuardado');
            if (!indicador) return;
            
            if (estadoGuardado.guardando) {
                indicador.innerHTML = 'üîÑ Guardando...';
                indicador.style.color = '#ff9800';
            } else if (estadoGuardado.ultimoGuardado) {
                const ahora = new Date();
                const diff = Math.floor((ahora - estadoGuardado.ultimoGuardado) / 1000);
                let tiempo = '';
                
                if (diff < 10) tiempo = 'justo ahora';
                else if (diff < 60) tiempo = 'hace ' + diff + 's';
                else if (diff < 3600) tiempo = 'hace ' + Math.floor(diff / 60) + 'm';
                else tiempo = 'hace ' + Math.floor(diff / 3600) + 'h';
                
                indicador.innerHTML = 'üü¢ Guardado ' + tiempo;
                indicador.style.color = '#28a745';
            } else {
                indicador.innerHTML = '‚ö™ Sin guardar';
                indicador.style.color = '#999';
            }
        }
        
        function limpiarDatosLocalStorage() {
            if (confirm('‚ö†Ô∏è ¬øEliminar TODOS los datos guardados?\n\nEsto no se puede deshacer.\n\n‚úÖ Aseg√∫rate de tener un backup en Excel antes de continuar.')) {
                if (confirm('üö® √öLTIMA CONFIRMACI√ìN\n\n¬øRealmente quieres eliminar todo?')) {
                    localStorage.removeItem('sistemaEducativo_datos');
                    localStorage.removeItem('sistemaEducativo_asistencia');
                    estadoGuardado.ultimoGuardado = null;
                    mostrarMensaje('üóëÔ∏è Datos eliminados. Recargando...');
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                }
            }
        }
        
        function resetearValoresEjemplo() {
            if (confirm('üîÑ ¬øResetear a valores de ejemplo?\n\nEsto reemplazar√° todos los bloques con indicadores de ejemplo.\n\nLos estudiantes y asistencia NO se borrar√°n.\n\n‚úÖ Crea un backup si no quieres perder tus competencias/indicadores actuales.')) {
                // Resetear solo los bloques
                for(var b=0; b<4; b++) {
                    datos.bloques[b].comp = [{
                        competencia:'Competencia Fundamental ' + (b+1)
                    }];
                    
                    for(var p=1; p<=4; p++) {
                        datos.bloques[b].periodos[p].indicadores = [
                            {
                                texto: 'Indicador de Bloque ' + (b+1) + ' - Per√≠odo ' + p + ' (Indicador 1)',
                                criterios: [
                                    'Criterio 1.1 del Per√≠odo ' + p,
                                    'Criterio 1.2 del Per√≠odo ' + p
                                ]
                            },
                            {
                                texto: 'Indicador de Bloque ' + (b+1) + ' - Per√≠odo ' + p + ' (Indicador 2)',
                                criterios: [
                                    'Criterio 2.1 del Per√≠odo ' + p
                                ]
                            }
                        ];
                        
                        datos.bloques[b].periodos[p].cal = {};
                        datos.bloques[b].periodos[p].fechasHeader = {};
                    }
                }
                
                guardarDatosLocalStorage();
                renderBloques();
                renderEstadisticas();
                mostrarMensaje('üîÑ Valores de ejemplo restaurados en todos los bloques y per√≠odos');
            }
        }
        
        // Auto-actualizar indicador cada 10 segundos
        setInterval(actualizarIndicadorGuardado, 10000);
        
        // ==================== FIN LOCALSTORAGE ====================
        
        function mostrarMensaje(texto, esError) {
            var msg = document.getElementById('mensaje');
            msg.textContent = texto;
            msg.classList.add('mostrar');
            if(esError) {
                msg.classList.add('error');
            } else {
                msg.classList.remove('error');
            }
            setTimeout(function() {
                msg.classList.remove('mostrar');
            }, 3000);
        }
        
        function actualizarInfo() {
            datos.info.centro = 'Alberto Feliz Bello';
            datos.info.maestro = 'Luis Abel G√≥mez F√©liz';
            datos.info.asignatura = 'Educaci√≥n F√≠sica';
            
            // Usar selectores del sistema multigrado
            var gradoSelect = document.getElementById('gradoSelect');
            var seccionSelect = document.getElementById('seccionSelect');
            
            if(gradoSelect && seccionSelect) {
                datos.info.grado = gradoSelect.value + ' - Secci√≥n ' + seccionSelect.value;
            } else {
                datos.info.grado = datosMultigrado.gradoActual + ' - Secci√≥n ' + datosMultigrado.seccionActual;
            }
            
            datos.info.anio = '2025 - 2026';
            renderEstadisticas();
        }
        
        function guardarExcel() {
            try {
                mostrarMensaje('‚è≥ Generando archivo Excel multigrado...');
                
                // Guardar secci√≥n actual antes de exportar
                guardarSeccionActual();
                
                var wb = XLSX.utils.book_new();
                
                // HOJA DE INFORMACI√ìN GENERAL
                var wsInfo = XLSX.utils.aoa_to_sheet([
                    ['Centro', 'Alberto Feliz Bello'],
                    ['Maestro', 'Luis Abel G√≥mez F√©liz'],
                    ['Asignatura', 'Educaci√≥n F√≠sica'],
                    ['A√±o', '2025 - 2026'],
                    ['Tipo', 'MULTIGRADO'],
                    ['Grados', '1ro, 2do, 3ro, 4to, 5to, 6to'],
                    ['Secciones', 'A, B, C, D']
                ]);
                XLSX.utils.book_append_sheet(wb, wsInfo, 'Info');
                
                // EXPORTAR CADA GRADO Y SECCI√ìN
                var gradosExportar = ['1ro', '2do', '3ro', '4to', '5to', '6to'];
                var seccionesExportar = ['A', 'B', 'C', 'D'];
                
                var totalSecciones = 0;
                var totalEstudiantes = 0;
                
                for(var g=0; g<gradosExportar.length; g++) {
                    var grado = gradosExportar[g];
                    
                    for(var s=0; s<seccionesExportar.length; s++) {
                        var seccion = seccionesExportar[s];
                        
                        // Verificar si la secci√≥n tiene datos
                        if(!datosMultigrado.grados[grado].secciones[seccion] || 
                           datosMultigrado.grados[grado].secciones[seccion].estudiantes.length === 0) {
                            continue; // Saltar secciones vac√≠as
                        }
                        
                        totalSecciones++;
                        var seccionData = datosMultigrado.grados[grado].secciones[seccion];
                        totalEstudiantes += seccionData.estudiantes.length;
                        
                        var nombreHoja = grado + '-' + seccion;
                        var hojaData = [];
                        
                        // ENCABEZADO
                        hojaData.push([nombreHoja.toUpperCase()]);
                        hojaData.push([]);
                        
                        // ESTUDIANTES
                        hojaData.push(['ESTUDIANTES']);
                        hojaData.push(['No', 'Nombre']);
                        for(var ei=0; ei<seccionData.estudiantes.length; ei++) {
                            var e = seccionData.estudiantes[ei];
                            hojaData.push([e.num, e.nombre]);
                        }
                        
                        hojaData.push([]);
                        
                        // BLOQUES
                        for(var b=0; b<4; b++) {
                            var bd = seccionData.bloques[b];
                            
                            hojaData.push(['BLOQUE ' + (b+1)]);
                            hojaData.push([]);
                            
                            // COMPETENCIAS
                            hojaData.push(['COMPETENCIAS DEL BLOQUE']);
                            for(var ci=0; ci<bd.comp.length; ci++) {
                                var c = bd.comp[ci];
                                hojaData.push(['Competencia'+(ci+1), c.competencia]);
                            }
                            
                            hojaData.push([]);
                            
                            // PER√çODOS
                            for(var p=1; p<=4; p++) {
                                hojaData.push(['PER√çODO ' + p]);
                                
                                var periodoData = bd.periodos[p];
                                
                                // INDICADORES Y CRITERIOS
                                for(var ii=0; ii<periodoData.indicadores.length; ii++) {
                                    var ind = periodoData.indicadores[ii];
                                    hojaData.push(['Indicador_P'+p+'_'+(ii+1), ind.texto]);
                                    
                                    if(ind.criterios) {
                                        for(var cri=0; cri<ind.criterios.length; cri++) {
                                            var critTexto = typeof ind.criterios[cri] === 'string' ? ind.criterios[cri] : (ind.criterios[cri].texto || '');
                                            hojaData.push(['Criterio_P'+p+'_'+(ii+1)+'_'+(cri+1), critTexto]);
                                        }
                                    }
                                }
                                
                                // FECHAS
                                hojaData.push([]);
                                hojaData.push(['FECHAS_P'+p]);
                                
                                var totalCritP = 0;
                                for(var ii=0; ii<periodoData.indicadores.length; ii++) {
                                    if(periodoData.indicadores[ii].criterios) {
                                        totalCritP += periodoData.indicadores[ii].criterios.length;
                                    }
                                }
                                
                                var headerFechasP = ['Criterio'];
                                for(var c=0; c<totalCritP; c++) {
                                    headerFechasP.push('C'+(c+1));
                                }
                                hojaData.push(headerFechasP);
                                
                                var rowFechaP = ['Fecha'];
                                for(var c=0; c<totalCritP; c++) {
                                    var keyFH = p+'_'+c;
                                    rowFechaP.push(periodoData.fechasHeader[keyFH] || '');
                                }
                                hojaData.push(rowFechaP);
                                
                                // CALIFICACIONES
                                hojaData.push([]);
                                hojaData.push(['CALIFICACIONES_P'+p]);
                                
                                var headerCalP = ['Estudiante'];
                                for(var c=0; c<totalCritP; c++) {
                                    headerCalP.push('C'+(c+1));
                                }
                                headerCalP.push('Promedio');
                                hojaData.push(headerCalP);
                                
                                for(var ei=0; ei<seccionData.estudiantes.length; ei++) {
                                    var e = seccionData.estudiantes[ei];
                                    var rowP = [e.nombre];
                                    
                                    var suma = 0, cuenta = 0;
                                    for(var c=0; c<totalCritP; c++) {
                                        var key = e.num+'_'+p+'_'+c;
                                        var cal = periodoData.cal[key] || '';
                                        rowP.push(cal);
                                        
                                        if(cal) {
                                            var valorNum = parseFloat(cal);
                                            if(!isNaN(valorNum)) {
                                                suma += valorNum;
                                                cuenta++;
                                            } else if(NOTAS[cal]) {
                                                suma += NOTAS[cal];
                                                cuenta++;
                                            }
                                        }
                                    }
                                    
                                    rowP.push(cuenta > 0 ? (suma/cuenta).toFixed(2) : '');
                                    hojaData.push(rowP);
                                }
                                
                                hojaData.push([]);
                            }
                            
                            // RECUPERACIONES DEL BLOQUE
                            hojaData.push(['RECUPERACIONES']);
                            
                            for(var p=1; p<=4; p++) {
                                hojaData.push(['RP'+p]);
                                hojaData.push(['Estudiante', 'Recuperaci√≥n']);
                                
                                for(var ei=0; ei<seccionData.estudiantes.length; ei++) {
                                    var e = seccionData.estudiantes[ei];
                                    var recup = bd.recuperaciones && bd.recuperaciones[p] && bd.recuperaciones[p][e.num] ? bd.recuperaciones[p][e.num] : '';
                                    if(recup !== '') {
                                        hojaData.push([e.nombre, recup]);
                                    }
                                }
                            }
                            
                            hojaData.push([]);
                            hojaData.push([]);
                        }
                        
                        // Crear hoja
                        var ws = XLSX.utils.aoa_to_sheet(hojaData);
                        XLSX.utils.book_append_sheet(wb, ws, nombreHoja);
                    }
                }
                
                // HOJA DE ASISTENCIA (todas las secciones)
                const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const ordenMeses = [8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6];
                
                const asistenciaData = [['ASISTENCIA - A√ëO ' + asistencia.anioActual]];
                asistenciaData.push(['TODAS LAS SECCIONES']);
                asistenciaData.push([]);
                
                // Por ahora, asistencia es compartida (se puede separar en el futuro)
                for (let mIdx = 0; mIdx < ordenMeses.length; mIdx++) {
                    const m = ordenMeses[mIdx];
                    const mesKey = asistencia.anioActual + '-' + m;
                    
                    if (asistencia.meses[mesKey]) {
                        const mesData = asistencia.meses[mesKey];
                        asistenciaData.push([mesesNombres[m].toUpperCase()]);
                        
                        const headerDias = ['Estudiante'];
                        for (let i = 0; i < mesData.dias.length; i++) {
                            headerDias.push('D' + mesData.dias[i]);
                        }
                        headerDias.push('% Asist');
                        asistenciaData.push(headerDias);
                        
                        // Estudiantes de TODOS los grados
                        for(var g=0; g<gradosExportar.length; g++) {
                            var grado = gradosExportar[g];
                            for(var s=0; s<seccionesExportar.length; s++) {
                                var seccion = seccionesExportar[s];
                                
                                if(!datosMultigrado.grados[grado].secciones[seccion]) continue;
                                var seccionData = datosMultigrado.grados[grado].secciones[seccion];
                                
                                for (let ei = 0; ei < seccionData.estudiantes.length; ei++) {
                                    const e = seccionData.estudiantes[ei];
                                    const registros = mesData.registros[e.num] || [];
                                    const row = [grado + '-' + seccion + ': ' + e.nombre];
                                    
                                    for (let i = 0; i < mesData.dias.length; i++) {
                                        row.push(registros[i] || '');
                                    }
                                    
                                    const porc = calcularPorcentajeAsistencia(registros, mesData.dias.length);
                                    row.push(porc.toFixed(1) + '%');
                                    
                                    asistenciaData.push(row);
                                }
                            }
                        }
                        
                        asistenciaData.push([]);
                    }
                }
                
                const wsAsistencia = XLSX.utils.aoa_to_sheet(asistenciaData);
                XLSX.utils.book_append_sheet(wb, wsAsistencia, 'Asistencia');
                
                var fecha = new Date().toISOString().slice(0,10);
                var nombreArchivo = 'EducacionFisica_Multigrado_' + fecha + '.xlsx';
                
                XLSX.writeFile(wb, nombreArchivo);
                
                mostrarMensaje('‚úì Excel multigrado guardado: ' + totalSecciones + ' secciones, ' + totalEstudiantes + ' estudiantes');
            } catch(error) {
                console.error('Error guardando Excel:', error);
                mostrarMensaje('‚úó Error al guardar Excel: ' + error.message, true);
            }
        }
        
        function cargarExcel(event) {
            var archivo = event.target.files[0];
            if(!archivo) return;
            
            mostrarMensaje('‚è≥ Cargando archivo Excel...');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = new Uint8Array(e.target.result);
                    var wb = XLSX.read(data, {type: 'array'});
                    
                    // DETECTAR TIPO DE EXCEL
                    var wsInfo = wb.Sheets['Info'];
                    var esMultigrado = false;
                    
                    if(wsInfo) {
                        var infoData = XLSX.utils.sheet_to_json(wsInfo, {header:1});
                        // Buscar si dice "MULTIGRADO"
                        for(var i=0; i<infoData.length; i++) {
                            if(infoData[i][0] === 'Tipo' && infoData[i][1] === 'MULTIGRADO') {
                                esMultigrado = true;
                                break;
                            }
                        }
                    }
                    
                    if(esMultigrado) {
                        // CARGAR EXCEL MULTIGRADO
                        cargarExcelMultigrado(wb);
                    } else {
                        // CARGAR EXCEL ANTIGUO (una sola secci√≥n)
                        cargarExcelSimple(wb);
                    }
                    
                } catch(error) {
                    console.error('Error cargando Excel:', error);
                    mostrarMensaje('‚úó Error al cargar el archivo: ' + error.message, true);
                }
            };
            
            reader.readAsArrayBuffer(archivo);
            event.target.value = '';
        }
        
        // CARGAR EXCEL MULTIGRADO
        function cargarExcelMultigrado(wb) {
            try {
                var gradosDetectados = 0;
                var seccionesDetectadas = 0;
                var totalEstudiantes = 0;
                
                // RECORRER TODAS LAS HOJAS
                var sheetNames = wb.SheetNames;
                
                for(var si=0; si<sheetNames.length; si++) {
                    var sheetName = sheetNames[si];
                    
                    // Saltar hojas especiales
                    if(sheetName === 'Info' || sheetName === 'Asistencia') continue;
                    
                    // Detectar grado y secci√≥n del nombre de la hoja (ej: "1ro-A")
                    var match = sheetName.match(/^(\d\w+)-([A-D])$/);
                    if(!match) continue;
                    
                    var grado = match[1];
                    var seccion = match[2];
                    
                    // Crear secci√≥n si no existe
                    if(!datosMultigrado.grados[grado].secciones[seccion]) {
                        datosMultigrado.grados[grado].secciones[seccion] = crearEstructuraSeccion();
                    }
                    
                    var seccionData = datosMultigrado.grados[grado].secciones[seccion];
                    
                    // LEER HOJA
                    var hojaData = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], {header:1});
                    
                    // Reinicializar estructura
                    seccionData.estudiantes = [];
                    seccionData.bloques = [
                        crearEstructuraBloque(),
                        crearEstructuraBloque(),
                        crearEstructuraBloque(),
                        crearEstructuraBloque()
                    ];
                    
                    var bloqueActual = -1;
                    var periodoActual = null;
                    
                    for(var r=0; r<hojaData.length; r++) {
                        var row = hojaData[r];
                        if(!row[0]) continue;
                        
                        // CARGAR ESTUDIANTES
                        if(row[0] === 'ESTUDIANTES') {
                            r++; // Saltar header
                            r++; // Primera fila de datos
                            
                            while(r < hojaData.length && hojaData[r][0] && hojaData[r][0] !== '') {
                                if(typeof hojaData[r][0] === 'number' && hojaData[r][1]) {
                                    seccionData.estudiantes.push({
                                        num: hojaData[r][0],
                                        nombre: hojaData[r][1]
                                    });
                                    totalEstudiantes++;
                                }
                                r++;
                            }
                            continue;
                        }
                        
                        // DETECTAR BLOQUE
                        if(row[0].startsWith('BLOQUE')) {
                            bloqueActual = parseInt(row[0].replace('BLOQUE ', '')) - 1;
                            continue;
                        }
                        
                        // CARGAR COMPETENCIAS
                        if(row[0].startsWith('Competencia') && bloqueActual >= 0) {
                            seccionData.bloques[bloqueActual].comp.push({
                                competencia: row[1] || '',
                                indicadores: []
                            });
                            continue;
                        }
                        
                        // DETECTAR PER√çODO
                        if(row[0].startsWith('PER√çODO') && bloqueActual >= 0) {
                            periodoActual = parseInt(row[0].replace('PER√çODO ', ''));
                            continue;
                        }
                        
                        // CARGAR INDICADORES
                        if(row[0].startsWith('Indicador_P') && bloqueActual >= 0 && periodoActual) {
                            var ind = {
                                texto: row[1] || '',
                                criterios: []
                            };
                            seccionData.bloques[bloqueActual].periodos[periodoActual].indicadores.push(ind);
                            continue;
                        }
                        
                        // CARGAR CRITERIOS
                        if(row[0].startsWith('Criterio_P') && bloqueActual >= 0 && periodoActual) {
                            var ultimoInd = seccionData.bloques[bloqueActual].periodos[periodoActual].indicadores[seccionData.bloques[bloqueActual].periodos[periodoActual].indicadores.length - 1];
                            if(ultimoInd) {
                                ultimoInd.criterios.push(row[1] || '');
                            }
                            continue;
                        }
                        
                        // CARGAR FECHAS
                        if(row[0].startsWith('FECHAS_P') && bloqueActual >= 0) {
                            var p = parseInt(row[0].replace('FECHAS_P', ''));
                            
                            // Buscar fila con "Fecha"
                            for(var fr = r+1; fr < hojaData.length && fr < r+5; fr++) {
                                if(hojaData[fr][0] === 'Fecha') {
                                    var fechaRow = hojaData[fr];
                                    
                                    var totalCrit = 0;
                                    for(var ii=0; ii<seccionData.bloques[bloqueActual].periodos[p].indicadores.length; ii++) {
                                        totalCrit += seccionData.bloques[bloqueActual].periodos[p].indicadores[ii].criterios.length;
                                    }
                                    
                                    for(var c=0; c<totalCrit; c++) {
                                        if(fechaRow[c+1]) {
                                            var keyFH = p+'_'+c;
                                            seccionData.bloques[bloqueActual].periodos[p].fechasHeader[keyFH] = fechaRow[c+1];
                                        }
                                    }
                                    break;
                                }
                            }
                            continue;
                        }
                        
                        // CARGAR CALIFICACIONES
                        if(row[0].startsWith('CALIFICACIONES_P') && bloqueActual >= 0) {
                            var p = parseInt(row[0].replace('CALIFICACIONES_P', ''));
                            
                            var totalCrit = 0;
                            for(var ii=0; ii<seccionData.bloques[bloqueActual].periodos[p].indicadores.length; ii++) {
                                totalCrit += seccionData.bloques[bloqueActual].periodos[p].indicadores[ii].criterios.length;
                            }
                            
                            // Leer calificaciones
                            for(var er = r+2; er < hojaData.length; er++) {
                                var calRow = hojaData[er];
                                if(!calRow[0] || calRow[0].startsWith('FECHAS') || calRow[0].startsWith('CALIFICACIONES') || calRow[0].startsWith('RECUPERACIONES') || calRow[0].startsWith('BLOQUE')) break;
                                
                                var nombreEst = calRow[0];
                                var est = null;
                                for(var ei=0; ei<seccionData.estudiantes.length; ei++) {
                                    if(seccionData.estudiantes[ei].nombre === nombreEst) {
                                        est = seccionData.estudiantes[ei];
                                        break;
                                    }
                                }
                                
                                if(est) {
                                    for(var c=0; c<totalCrit; c++) {
                                        var key = est.num+'_'+p+'_'+c;
                                        if(calRow[c+1]) {
                                            seccionData.bloques[bloqueActual].periodos[p].cal[key] = calRow[c+1];
                                        }
                                    }
                                }
                            }
                            continue;
                        }
                        
                        // CARGAR RECUPERACIONES
                        if(row[0].startsWith('RP') && bloqueActual >= 0) {
                            var p = parseInt(row[0].replace('RP', ''));
                            
                            for(var er = r+2; er < hojaData.length; er++) {
                                var recupRow = hojaData[er];
                                if(!recupRow[0] || recupRow[0].startsWith('RP') || recupRow[0].startsWith('BLOQUE')) break;
                                
                                var nombreEst = recupRow[0];
                                var valorRecup = recupRow[1];
                                
                                if(nombreEst && valorRecup) {
                                    var est = null;
                                    for(var ei=0; ei<seccionData.estudiantes.length; ei++) {
                                        if(seccionData.estudiantes[ei].nombre === nombreEst) {
                                            est = seccionData.estudiantes[ei];
                                            break;
                                        }
                                    }
                                    
                                    if(est) {
                                        seccionData.bloques[bloqueActual].recuperaciones[p][est.num] = parseFloat(valorRecup);
                                    }
                                }
                            }
                            continue;
                        }
                    }
                    
                    seccionesDetectadas++;
                }
                
                // CARGAR ASISTENCIA
                var wsAsistencia = wb.Sheets['Asistencia'];
                if(wsAsistencia) {
                    var asistData = XLSX.utils.sheet_to_json(wsAsistencia, {header:1});
                    const mesesNombres = ['', 'ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 
                                          'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];
                    
                    var mesActualLectura = null;
                    var mesKeyLectura = null;
                    var anioAsistencia = new Date().getFullYear();
                    
                    // Leer a√±o de asistencia de la primera l√≠nea
                    if(asistData[0] && asistData[0][0]) {
                        var match = asistData[0][0].toString().match(/(\d{4})/);
                        if(match) anioAsistencia = parseInt(match[1]);
                    }
                    
                    for(var r=0; r<asistData.length; r++) {
                        var row = asistData[r];
                        if(!row[0]) continue;
                        
                        // Detectar mes
                        var mesIdx = mesesNombres.indexOf(row[0].toString().toUpperCase());
                        if(mesIdx > 0) {
                            mesActualLectura = mesIdx;
                            mesKeyLectura = anioAsistencia + '-' + mesActualLectura;
                            
                            // Leer header de d√≠as (siguiente l√≠nea)
                            r++;
                            var headerRow = asistData[r];
                            var diasMes = [];
                            
                            for(var i=1; i<headerRow.length-1; i++) {
                                if(headerRow[i] && headerRow[i].toString().startsWith('D')) {
                                    var dia = parseInt(headerRow[i].toString().replace('D', ''));
                                    diasMes.push(dia);
                                }
                            }
                            
                            // Leer registros de estudiantes
                            for(var er = r+1; er < asistData.length; er++) {
                                var estRow = asistData[er];
                                if(!estRow[0] || !estRow[0].toString().trim()) break;
                                
                                // Detectar grado-secci√≥n del nombre (formato: "1ro-A: NOMBRE")
                                var nombreCompleto = estRow[0].toString();
                                var matchGradoSeccion = nombreCompleto.match(/^(\d\w+)-([A-D]):\s*(.+)$/);
                                
                                if(matchGradoSeccion) {
                                    var gradoAsist = matchGradoSeccion[1];
                                    var seccionAsist = matchGradoSeccion[2];
                                    var nombreEst = matchGradoSeccion[3];
                                    
                                    // Buscar estudiante en ese grado/secci√≥n
                                    if(datosMultigrado.grados[gradoAsist] && 
                                       datosMultigrado.grados[gradoAsist].secciones[seccionAsist]) {
                                        
                                        var seccionData = datosMultigrado.grados[gradoAsist].secciones[seccionAsist];
                                        var estNum = null;
                                        
                                        for(var ei=0; ei<seccionData.estudiantes.length; ei++) {
                                            if(seccionData.estudiantes[ei].nombre === nombreEst) {
                                                estNum = seccionData.estudiantes[ei].num;
                                                break;
                                            }
                                        }
                                        
                                        if(estNum) {
                                            // Crear estructura de asistencia para ese grado/secci√≥n si no existe
                                            if(!asistenciaMultigrado.grados[gradoAsist].secciones[seccionAsist]) {
                                                asistenciaMultigrado.grados[gradoAsist].secciones[seccionAsist] = crearEstructuraAsistencia();
                                            }
                                            
                                            var asistSeccion = asistenciaMultigrado.grados[gradoAsist].secciones[seccionAsist];
                                            
                                            // Crear mes si no existe
                                            if(!asistSeccion.meses[mesKeyLectura]) {
                                                asistSeccion.meses[mesKeyLectura] = {
                                                    dias: diasMes,
                                                    registros: {}
                                                };
                                            }
                                            
                                            // Guardar registros de asistencia
                                            asistSeccion.meses[mesKeyLectura].registros[estNum] = [];
                                            for(var i=1; i<=diasMes.length; i++) {
                                                asistSeccion.meses[mesKeyLectura].registros[estNum].push(estRow[i] || '');
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    console.log('‚úì Asistencia multigrado cargada');
                }
                
                // Cargar la secci√≥n actual
                cargarSeccion(datosMultigrado.gradoActual, datosMultigrado.seccionActual);
                cargarAsistenciaSeccion(datosMultigrado.gradoActual, datosMultigrado.seccionActual);
                renderEstudiantes();
                renderBloques();
                renderEstadisticas();
                guardarDatosLocalStorage();
                
                mostrarMensaje('‚úì Excel multigrado cargado: ' + seccionesDetectadas + ' secciones, ' + totalEstudiantes + ' estudiantes');
                
            } catch(error) {
                console.error('Error:', error);
                mostrarMensaje('‚úó Error cargando multigrado: ' + error.message, true);
            }
        }
        
        // HELPER: Crear estructura de bloque vac√≠a
        function crearEstructuraBloque() {
            return {
                comp:[],
                periodos: {
                    1: {indicadores:[], cal:{}, fechasHeader:{}},
                    2: {indicadores:[], cal:{}, fechasHeader:{}},
                    3: {indicadores:[], cal:{}, fechasHeader:{}},
                    4: {indicadores:[], cal:{}, fechasHeader:{}}
                },
                recuperaciones: {1:{}, 2:{}, 3:{}, 4:{}}
            };
        }
        
        // CARGAR EXCEL SIMPLE (compatibilidad con archivos antiguos)
        function cargarExcelSimple(wb) {
            // Esta funci√≥n mantiene compatibilidad con Excel antiguos de una sola secci√≥n
            // Se carga en la secci√≥n actualmente seleccionada
            
            try {
                // CARGAR ESTUDIANTES
                var wsEst = wb.Sheets['Estudiantes'];
                if(wsEst) {
                    var estData = XLSX.utils.sheet_to_json(wsEst, {header:1});
                    datos.estudiantes = [];
                    for(var i=1; i<estData.length; i++) {
                        if(estData[i][0] && estData[i][1]) {
                            datos.estudiantes.push({
                                num: estData[i][0],
                                nombre: estData[i][1]
                            });
                        }
                    }
                }
                
                // CARGAR BLOQUES (usando l√≥gica anterior)
                for(var b=0; b<4; b++) {
                    var wsBloque = wb.Sheets['Bloque'+(b+1)];
                    if(!wsBloque) continue;
                    
                    var bloqueData = XLSX.utils.sheet_to_json(wsBloque, {header:1});
                    
                    datos.bloques[b] = crearEstructuraBloque();
                    var periodoActual = null;
                    
                    for(var r=0; r<bloqueData.length; r++) {
                        var row = bloqueData[r];
                        if(!row[0]) continue;
                        
                        if(row[0].startsWith('Competencia')) {
                            datos.bloques[b].comp.push({
                                competencia: row[1] || '',
                                indicadores: []
                            });
                        } else if(row[0].startsWith('PER√çODO')) {
                            periodoActual = parseInt(row[0].replace('PER√çODO ', ''));
                        } else if(row[0].startsWith('Indicador_P')) {
                            if(periodoActual) {
                                datos.bloques[b].periodos[periodoActual].indicadores.push({
                                    texto: row[1] || '',
                                    criterios: []
                                });
                            }
                        } else if(row[0].startsWith('Criterio_P')) {
                            if(periodoActual && datos.bloques[b].periodos[periodoActual].indicadores.length > 0) {
                                var ultimoInd = datos.bloques[b].periodos[periodoActual].indicadores[datos.bloques[b].periodos[periodoActual].indicadores.length - 1];
                                ultimoInd.criterios.push(row[1] || '');
                            }
                        }
                        // ... resto de la carga similar a antes
                    }
                }
                
                // Guardar en la secci√≥n actual
                guardarSeccionActual();
                renderEstudiantes();
                renderBloques();
                renderEstadisticas();
                guardarDatosLocalStorage();
                
                mostrarMensaje('‚úì Excel simple cargado en ' + datosMultigrado.gradoActual + '-' + datosMultigrado.seccionActual);
                
            } catch(error) {
                console.error('Error:', error);
                mostrarMensaje('‚úó Error: ' + error.message, true);
            }
        }
        
        function cambiarPantalla(id) {
            var pantallas = document.querySelectorAll('.pantalla');
            for(var i=0; i<pantallas.length; i++) {
                pantallas[i].classList.remove('activa');
            }
            
            var botones = document.querySelectorAll('.nav > button');
            for(var i=0; i<botones.length; i++) {
                botones[i].classList.remove('active');
            }
            
            // Limpiar dropdown
            var dropdownBotones = document.querySelectorAll('.dropdown-content button');
            for(var i=0; i<dropdownBotones.length; i++) {
                dropdownBotones[i].classList.remove('active');
            }
            document.getElementById('btnCalificaciones').classList.remove('active');
            
            document.getElementById(id).classList.add('activa');
            if(event && event.target) {
                event.target.classList.add('active');
            }
            
            if(id === 'reporte') {
                renderReporteFinal();
            } else if(id === 'inicio') {
                renderEstadisticas();
            } else if(id === 'ruleta') {
                restaurarRuleta();
            } else if(id === 'asistencia') {
                inicializarAsistencia();
            }
        }
        
        function cambiarPantallaDropdown(id) {
            var pantallas = document.querySelectorAll('.pantalla');
            for(var i=0; i<pantallas.length; i++) {
                pantallas[i].classList.remove('activa');
            }
            
            var botones = document.querySelectorAll('.nav > button');
            for(var i=0; i<botones.length; i++) {
                botones[i].classList.remove('active');
            }
            
            var dropdownBotones = document.querySelectorAll('.dropdown-content button');
            for(var i=0; i<dropdownBotones.length; i++) {
                dropdownBotones[i].classList.remove('active');
            }
            
            document.getElementById(id).classList.add('activa');
            event.target.classList.add('active');
            document.getElementById('btnCalificaciones').classList.add('active');
            
            if(id === 'reporte') {
                renderReporteFinal();
            }
        }
        
        function calcularPromedioPeriodo(bloqueIdx, periodo, numEstudiante) {
            var bd = datos.bloques[bloqueIdx];
            
            // Verificar que exista la estructura de per√≠odos
            if (!bd.periodos || !bd.periodos[periodo]) return null;
            
            var periodoData = bd.periodos[periodo];
            
            // Obtener informaci√≥n de criterios (tipo)
            var criteriosInfo = [];
            for(var ii=0; ii<periodoData.indicadores.length; ii++) {
                var ind = periodoData.indicadores[ii];
                if(ind.criterios) {
                    for(var cri=0; cri<ind.criterios.length; cri++) {
                        var critObj = ind.criterios[cri];
                        var critTipo = typeof critObj === 'string' ? 'letra' : (critObj.tipo || 'letra');
                        criteriosInfo.push({tipo: critTipo});
                    }
                }
            }
            
            var totalCrit = criteriosInfo.length;
            if(totalCrit === 0) return null;
            
            var suma = 0;
            var cuenta = 0;
            
            for(var i=0; i<totalCrit; i++) {
                var key = numEstudiante + '_' + periodo + '_' + i;
                var cal = periodoData.cal[key];
                
                if(cal) {
                    if(criteriosInfo[i].tipo === 'numero') {
                        // Es un n√∫mero directo
                        var valor = parseFloat(cal);
                        if(!isNaN(valor)) {
                            suma += valor;
                            cuenta++;
                        }
                    } else if(NOTAS[cal]) {
                        // Es una letra, convertir a n√∫mero
                        suma += NOTAS[cal];
                        cuenta++;
                    }
                }
            }
            
            return cuenta > 0 ? (suma / cuenta) : null;
        }
        
        // CALCULAR PROMEDIO DE BLOQUE CON RECUPERACIONES
        function calcularPromedioBloque(bloqueIdx, numEstudiante) {
            var bd = datos.bloques[bloqueIdx];
            if(!bd) return null;
            
            var promediosPeriodos = [];
            
            // Calcular promedio de cada per√≠odo
            for(var p=1; p<=4; p++) {
                var promPeriodo = calcularPromedioPeriodo(bloqueIdx, p, numEstudiante);
                
                // Verificar si hay recuperaci√≥n para este per√≠odo
                var recuperacion = null;
                if(bd.recuperaciones && bd.recuperaciones[p] && bd.recuperaciones[p][numEstudiante]) {
                    recuperacion = parseFloat(bd.recuperaciones[p][numEstudiante]);
                }
                
                // Si hay recuperaci√≥n, usar el MAYOR entre promedio original y recuperaci√≥n
                if(recuperacion !== null && !isNaN(recuperacion)) {
                    if(promPeriodo !== null) {
                        // Usar el mayor: recuperaci√≥n o promedio original
                        promediosPeriodos.push(Math.max(promPeriodo, recuperacion));
                    } else {
                        // Solo hay recuperaci√≥n
                        promediosPeriodos.push(recuperacion);
                    }
                } else if(promPeriodo !== null) {
                    // No hay recuperaci√≥n, usar promedio original
                    promediosPeriodos.push(promPeriodo);
                }
            }
            
            // Calcular promedio del bloque
            if(promediosPeriodos.length === 0) return null;
            
            var suma = 0;
            for(var i=0; i<promediosPeriodos.length; i++) {
                suma += promediosPeriodos[i];
            }
            
            return suma / promediosPeriodos.length;
        }
        
        
        
        function renderTablaPeriodo(bloqueIdx, periodo) {
            var bd = datos.bloques[bloqueIdx];
            var periodoData = bd.periodos[periodo];
            
            // Contar criterios totales
            var totalCrit = 0;
            var criteriosInfo = []; // {texto, tipo, indice}
            
            if(periodoData.indicadores) {
                for(var ii=0; ii<periodoData.indicadores.length; ii++) {
                    var ind = periodoData.indicadores[ii];
                    if(ind.criterios) {
                        for(var cri=0; cri<ind.criterios.length; cri++) {
                            var critObj = ind.criterios[cri];
                            var critTexto = typeof critObj === 'string' ? critObj : (critObj.texto || '');
                            var critTipo = typeof critObj === 'string' ? 'letra' : (critObj.tipo || 'letra');
                            criteriosInfo.push({
                                texto: critTexto,
                                tipo: critTipo,
                                indice: totalCrit
                            });
                            totalCrit++;
                        }
                    }
                }
            }
            
            if(totalCrit === 0 || datos.estudiantes.length === 0) {
                return '<div style="padding:20px;background:#fff3e0;border-radius:8px;text-align:center;color:#f57c00;">‚ö†Ô∏è Agrega criterios y estudiantes para ver la tabla</div>';
            }
            
            var html = '<div style="overflow-x:auto;margin-top:20px;">';
            html += '<table style="width:100%;border-collapse:collapse;box-shadow:0 4px 15px rgba(0,0,0,0.1);">';
            
            // HEADER
            html += '<thead>';
            html += '<tr style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">';
            html += '<th style="padding:15px;border:1px solid #ddd;color:white;font-weight:700;position:sticky;left:0;background:#667eea;z-index:3;">Estudiante</th>';
            
            for(var i=0; i<criteriosInfo.length; i++) {
                var info = criteriosInfo[i];
                var icono = info.tipo === 'numero' ? 'üî¢' : 'üìù';
                html += '<th style="padding:12px;border:1px solid #ddd;color:white;min-width:120px;">';
                html += '<div style="font-weight:600;margin-bottom:5px;">'+icono+' C'+(i+1)+'</div>';
                html += '<div style="font-size:11px;opacity:0.9;">'+info.texto.substring(0,20)+(info.texto.length>20?'...':'')+'</div>';
                html += '</th>';
            }
            
            html += '<th style="padding:15px;border:1px solid #ddd;color:white;font-weight:700;">Promedio</th>';
            html += '</tr>';
            html += '</thead>';
            
            // BODY
            html += '<tbody>';
            for(var e=0; e<datos.estudiantes.length; e++) {
                var est = datos.estudiantes[e];
                var bgColor = e % 2 === 0 ? '#f9f9f9' : 'white';
                html += '<tr style="background:'+bgColor+';">';
                html += '<td style="padding:12px;border:1px solid #ddd;font-weight:600;position:sticky;left:0;background:'+bgColor+';z-index:2;">'+est.nombre+'</td>';
                
                var suma = 0, cuenta = 0;
                
                for(var i=0; i<criteriosInfo.length; i++) {
                    var info = criteriosInfo[i];
                    var key = est.num+'_'+(periodo+1)+'_'+i;
                    var calActual = bd.cal[key] || '';
                    
                    html += '<td style="padding:5px;border:1px solid #ddd;text-align:center;background:'+(calActual?'#e8f5e9':'white')+';">';
                    
                    if(info.tipo === 'numero') {
                        // Input num√©rico
                        html += '<input type="number" min="0" max="100" value="'+calActual+'" onchange="guardarCalPeriodo('+bloqueIdx+','+(periodo+1)+','+est.num+','+i+',this.value)" style="width:100%;padding:8px;border:2px solid #667eea;border-radius:6px;text-align:center;font-weight:600;font-size:14px;">';
                    } else {
                        // Selector de letras
                        html += '<select onchange="guardarCalPeriodo('+bloqueIdx+','+(periodo+1)+','+est.num+','+i+',this.value)" style="width:100%;padding:8px;border:2px solid #667eea;border-radius:6px;font-weight:600;font-size:14px;">';
                        html += '<option value="">-</option>';
                        var notas = ['A+','A','A-','B+','B','B-','C+','C','C-','D+','D','D-','F'];
                        for(var n=0; n<notas.length; n++) {
                            html += '<option value="'+notas[n]+'" '+(calActual===notas[n]?'selected':'')+'>'+notas[n]+'</option>';
                        }
                        html += '</select>';
                    }
                    
                    html += '</td>';
                    
                    // Calcular para promedio
                    if(calActual) {
                        if(info.tipo === 'numero') {
                            var valor = parseFloat(calActual);
                            if(!isNaN(valor)) {
                                suma += valor;
                                cuenta++;
                            }
                        } else if(NOTAS[calActual]) {
                            suma += NOTAS[calActual];
                            cuenta++;
                        }
                    }
                }
                
                var prom = cuenta > 0 ? (suma/cuenta).toFixed(1) : '-';
                var colorProm = prom >= 90 ? '#43a047' : prom >= 70 ? '#fb8c00' : '#e53935';
                html += '<td style="padding:12px;border:1px solid #ddd;font-weight:700;font-size:18px;text-align:center;background:#f5f5f5;color:'+colorProm+';">'+prom+'</td>';
                html += '</tr>';
            }
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            return html;
        }
        
        function guardarCalPeriodo(bloqueIdx, periodo, estudianteNum, criterio, valor) {
            var key = estudianteNum + '_' + periodo + '_' + criterio;
            datos.bloques[bloqueIdx].cal[key] = valor;
            guardarDatosLocalStorage();
            
            // Re-renderizar solo el panel activo
            var panelActivo = document.querySelector('.panel-tab.active');
            if(panelActivo) {
                var periodoActivo = parseInt(panelActivo.getAttribute('data-periodo'));
                renderTablaPeriodoEnDiv(bloqueIdx, periodoActivo);
            }
        }
        
        function renderTablaPeriodoEnDiv(bloqueIdx, periodo) {
            var divId = 'tabla-periodo-'+(bloqueIdx+1)+'-'+(periodo+1);
            var div = document.getElementById(divId);
            if(div) {
                div.innerHTML = renderTablaPeriodo(bloqueIdx, periodo);
            }
        }
        function renderEstadisticas() {
            var estadisticas = calcularEstadisticas();
            
            var html = '';
            html += '<div class="stat-card aprobados">';
            html += '<h3>‚úÖ Aprobados</h3>';
            html += '<div class="stat-number">'+estadisticas.aprobados+'</div>';
            html += '<p>'+estadisticas.porcentajeAprobados.toFixed(1)+'% del total</p>';
            html += '</div>';
            
            html += '<div class="stat-card reprobados">';
            html += '<h3>‚ùå Reprobados</h3>';
            html += '<div class="stat-number">'+estadisticas.reprobados+'</div>';
            html += '<p>'+estadisticas.porcentajeReprobados.toFixed(1)+'% del total</p>';
            html += '</div>';
            
            html += '<div class="stat-card promedio">';
            html += '<h3>üìä Promedio General</h3>';
            html += '<div class="stat-number">'+estadisticas.promedioGeneral.toFixed(1)+'</div>';
            html += '<p>De todos los estudiantes</p>';
            html += '</div>';
            
            html += '<div class="stat-card">';
            html += '<h3>üë• Total Estudiantes</h3>';
            html += '<div class="stat-number" style="color:#6c757d">'+datos.estudiantes.length+'</div>';
            html += '<p>Registrados en el sistema</p>';
            html += '</div>';
            
            document.getElementById('statsGrid').innerHTML = html;
            
            if(charts.aprobados) charts.aprobados.destroy();
            var ctxAprobados = document.getElementById('chartAprobados').getContext('2d');
            charts.aprobados = new Chart(ctxAprobados, {
                type: 'pie',
                data: {
                    labels: ['Aprobados', 'Reprobados', 'Sin Datos'],
                    datasets: [{
                        data: [estadisticas.aprobados, estadisticas.reprobados, estadisticas.sinDatos],
                        backgroundColor: ['#28a745', '#dc3545', '#6c757d']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Aprobados vs Reprobados',
                            font: { size: 14 }
                        },
                        legend: {
                            position: 'bottom',
                            labels: {
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
            
            if(charts.promedios) charts.promedios.destroy();
            var ctxPromedios = document.getElementById('chartPromedios').getContext('2d');
            charts.promedios = new Chart(ctxPromedios, {
                type: 'bar',
                data: {
                    labels: ['Bloque I', 'Bloque II', 'Bloque III', 'Bloque IV'],
                    datasets: [{
                        label: 'Promedio del Bloque',
                        data: estadisticas.promediosPorBloque,
                        backgroundColor: ['#4472C4', '#70AD47', '#FFC000', '#E74C3C']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Promedio General por Bloque',
                            font: { size: 14 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
            
            var topHTML = '';
            for(var i=0; i<Math.min(10, estadisticas.topEstudiantes.length); i++) {
                var e = estadisticas.topEstudiantes[i];
                var medalla = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : (i === 2 ? 'ü•â' : (i+1)+'.'));
                topHTML += '<li class="top-item">';
                topHTML += '<span>'+medalla+' '+e.nombre+'</span>';
                topHTML += '<span><strong>'+e.promedio+'</strong></span>';
                topHTML += '</li>';
            }
            document.getElementById('topEstudiantes').innerHTML = topHTML;
        }
        
        function calcularEstadisticas() {
            var aprobados = 0;
            var reprobados = 0;
            var sinDatos = 0;
            var sumaTotal = 0;
            var totalConDatos = 0;
            var promediosPorBloque = [0, 0, 0, 0];
            var estudiantesConPromedio = [];
            
            for(var ei=0; ei<datos.estudiantes.length; ei++) {
                var e = datos.estudiantes[ei];
                
                var promediosBloques = [];
                for(var b=0; b<4; b++) {
                    var sumaBloque = 0;
                    for(var p=1; p<=4; p++) {
                        var prom = calcularPromedioPeriodo(b, p, e.num);
                        if(prom !== null) sumaBloque += prom;
                    }
                    var promBloque = sumaBloque / 4;
                    promediosBloques.push(promBloque);
                }
                
                for(var b=0; b<4; b++) {
                    promediosPorBloque[b] += promediosBloques[b];
                }
                
                var sumaFinal = 0;
                for(var b=0; b<4; b++) {
                    sumaFinal += promediosBloques[b];
                }
                var promedioFinal = sumaFinal / 4;
                
                if(promedioFinal > 0) {
                    estudiantesConPromedio.push({
                        nombre: e.nombre,
                        promedio: Math.round(promedioFinal)
                    });
                    
                    if(promedioFinal >= 70) {
                        aprobados++;
                    } else {
                        reprobados++;
                    }
                    
                    sumaTotal += promedioFinal;
                    totalConDatos++;
                } else {
                    sinDatos++;
                }
            }
            
            for(var b=0; b<4; b++) {
                promediosPorBloque[b] = totalConDatos > 0 ? promediosPorBloque[b] / datos.estudiantes.length : 0;
            }
            
            estudiantesConPromedio.sort(function(a, b) {
                return b.promedio - a.promedio;
            });
            
            return {
                aprobados: aprobados,
                reprobados: reprobados,
                sinDatos: sinDatos,
                porcentajeAprobados: datos.estudiantes.length > 0 ? (aprobados / datos.estudiantes.length) * 100 : 0,
                porcentajeReprobados: datos.estudiantes.length > 0 ? (reprobados / datos.estudiantes.length) * 100 : 0,
                promedioGeneral: totalConDatos > 0 ? sumaTotal / totalConDatos : 0,
                promediosPorBloque: promediosPorBloque,
                topEstudiantes: estudiantesConPromedio
            };
        }
        
        // RENDER REPORTE FINAL - CON RECUPERACIONES (solo visible si calificaci√≥n < 70)
        function renderReporteFinal() {
            var html = '<table class="tabla-reporte">';
            
            html += '<thead>';
            
            // FILA 1: Bloques y Promedios
            html += '<tr>';
            html += '<th rowspan="2" style="width:50px">No.</th>';
            html += '<th rowspan="2" style="min-width:200px">Estudiante</th>';
            html += '<th colspan="8" class="header-bloque1">BLOQUE I</th>';
            html += '<th colspan="8" class="header-bloque2">BLOQUE II</th>';
            html += '<th colspan="8" class="header-bloque3">BLOQUE III</th>';
            html += '<th colspan="8" class="header-bloque4">BLOQUE IV</th>';
            html += '<th colspan="4" style="background:#ffc107;color:#333">PROMEDIO BLOQUE</th>';
            html += '<th rowspan="2" style="width:80px;background:#28a745">PROM<br>FINAL</th>';
            html += '<th rowspan="2" style="width:100px;background:#28a745">COND</th>';
            html += '</tr>';
            
            // FILA 2: Per√≠odos individuales con sus recuperaciones
            html += '<tr>';
            var clases = ['bloque1-col', 'bloque2-col', 'bloque3-col', 'bloque4-col'];
            for(var b=0; b<4; b++) {
                for(var p=1; p<=4; p++) {
                    html += '<th class="'+clases[b]+'">P'+p+'</th>';
                    html += '<th class="'+clases[b]+'" style="background:#ffe6cc;">RP'+p+'</th>';
                }
            }
            for(var b=1; b<=4; b++) {
                html += '<th class="promedio-bloques">PB'+b+'</th>';
            }
            html += '</tr>';
            
            html += '</thead><tbody>';
            
            for(var ei=0; ei<datos.estudiantes.length; ei++) {
                var e = datos.estudiantes[ei];
                html += '<tr>';
                html += '<td class="col-numero">'+e.num+'</td>';
                html += '<td class="col-estudiante">'+e.nombre+'</td>';
                
                var promediosBloques = [];
                
                for(var b=0; b<4; b++) {
                    var valoresParaPromedio = [];
                    
                    for(var p=1; p<=4; p++) {
                        var promPeriodo = calcularPromedioPeriodo(b, p, e.num);
                        var recuperacion = datos.bloques[b].recuperaciones && datos.bloques[b].recuperaciones[p] ? datos.bloques[b].recuperaciones[p][e.num] : null;
                        
                        // MOSTRAR PROMEDIO DEL PER√çODO
                        if(promPeriodo !== null) {
                            var colorCelda = '';
                            if(promPeriodo < 70) {
                                colorCelda = 'background:#ffcccc;'; // Rojo claro si est√° por debajo de 70
                            }
                            html += '<td class="'+clases[b]+'" style="'+colorCelda+'">'+Math.round(promPeriodo)+'</td>';
                        } else {
                            html += '<td class="'+clases[b]+' sin-datos">-</td>';
                        }
                        
                        // MOSTRAR RECUPERACI√ìN (SOLO SI HAY CALIFICACI√ìN < 70 O SI YA TIENE RECUPERACI√ìN)
                        var mostrarRP = (promPeriodo !== null && promPeriodo < 70) || 
                                       (recuperacion !== null && recuperacion !== undefined && recuperacion !== '');
                        
                        if(mostrarRP) {
                            if(recuperacion !== null && recuperacion !== undefined && recuperacion !== '') {
                                html += '<td class="'+clases[b]+'" style="background:#ffe6cc;font-weight:bold;">'+Math.round(recuperacion)+'</td>';
                            } else {
                                html += '<td class="'+clases[b]+'" style="background:#ffe6cc;color:#999;">-</td>';
                            }
                        } else {
                            // Si la calificaci√≥n es >= 70, no mostrar nada en RP
                            html += '<td class="'+clases[b]+'" style="background:#f0f0f0;"></td>';
                        }
                        
                        // DETERMINAR EL VALOR A USAR PARA EL PROMEDIO
                        var valorFinal = promPeriodo || 0;
                        if(recuperacion !== null && recuperacion !== undefined && recuperacion !== '') {
                            var recupNum = parseFloat(recuperacion);
                            if(!isNaN(recupNum)) {
                                valorFinal = Math.max(promPeriodo || 0, recupNum);
                            }
                        }
                        
                        valoresParaPromedio.push(valorFinal);
                    }
                    
                    // PROMEDIO DEL BLOQUE: SIEMPRE (P1+P2+P3+P4) / 4
                    var sumaBloque = valoresParaPromedio[0] + valoresParaPromedio[1] + valoresParaPromedio[2] + valoresParaPromedio[3];
                    var promBloque = sumaBloque / 4;
                    promediosBloques.push(promBloque);
                }
                
                // MOSTRAR PROMEDIOS DE BLOQUES
                for(var b=0; b<4; b++) {
                    if(promediosBloques[b] > 0) {
                        html += '<td class="promedio-bloques">'+promediosBloques[b].toFixed(2)+'</td>';
                    } else {
                        html += '<td class="promedio-bloques sin-datos">-</td>';
                    }
                }
                
                // PROMEDIO FINAL: SIEMPRE (PB1+PB2+PB3+PB4) / 4
                var sumaFinal = promediosBloques[0] + promediosBloques[1] + promediosBloques[2] + promediosBloques[3];
                var promedioFinal = sumaFinal / 4;
                
                if(promedioFinal > 0) {
                    html += '<td class="final-col">'+Math.round(promedioFinal)+'</td>';
                    
                    if(promedioFinal >= 70) {
                        html += '<td class="aprobado">APR</td>';
                    } else {
                        html += '<td class="reprobado">REP</td>';
                    }
                } else {
                    html += '<td class="final-col sin-datos">-</td>';
                    html += '<td class="sin-datos">-</td>';
                }
                
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            
            document.getElementById('tablaReporte').innerHTML = html;
        }
        
        // ==================== FUNCIONES DE RECUPERACI√ìN ====================
        
        function mostrarRecuperacion(periodo) {
            var html = '<h3 style="color:#1F4E78; margin-bottom:15px;">üìù Calificaciones de Recuperaci√≥n - Per√≠odo ' + periodo + '</h3>';
            html += '<p style="margin-bottom:15px;"><strong>Solo se muestran estudiantes con calificaci√≥n menor a 70 en este per√≠odo.</strong></p>';
            
            // Contar estudiantes que necesitan recuperaci√≥n
            var estudiantesConRecuperacion = [];
            
            for(var ei=0; ei<datos.estudiantes.length; ei++) {
                var e = datos.estudiantes[ei];
                var necesitaRecuperacion = false;
                
                // Verificar si tiene alguna calificaci√≥n < 70 en este per√≠odo en cualquier bloque
                for(var b=0; b<4; b++) {
                    var promPeriodo = calcularPromedioPeriodo(b, periodo, e.num);
                    if(promPeriodo !== null && promPeriodo < 70) {
                        necesitaRecuperacion = true;
                        break;
                    }
                }
                
                if(necesitaRecuperacion) {
                    estudiantesConRecuperacion.push(e);
                }
            }
            
            if(estudiantesConRecuperacion.length === 0) {
                html += '<div style="padding:30px; text-align:center; background:#d4edda; border-radius:8px; color:#155724;">';
                html += '<h3>üéâ ¬°Excelente!</h3>';
                html += '<p style="margin-top:10px;">Ning√∫n estudiante necesita recuperaci√≥n en el Per√≠odo '+periodo+'.</p>';
                html += '<p style="margin-top:5px;">Todos tienen calificaciones ‚â• 70 en todos los bloques.</p>';
                html += '</div>';
                document.getElementById('contenedorRecuperacion').innerHTML = html;
                return;
            }
            
            html += '<div style="margin-bottom:15px; padding:12px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:5px;">';
            html += '<strong>üìä Resumen:</strong> ' + estudiantesConRecuperacion.length + ' estudiante(s) necesitan recuperaci√≥n en este per√≠odo.';
            html += '</div>';
            
            html += '<table class="tabla-calif" style="width:100%;">';
            html += '<thead><tr>';
            html += '<th style="width:50px;">No.</th>';
            html += '<th style="min-width:200px;">Estudiante</th>';
            html += '<th style="background:#4472C4;">Bloque I - RP'+periodo+'</th>';
            html += '<th style="background:#70AD47;">Bloque II - RP'+periodo+'</th>';
            html += '<th style="background:#FFC000;">Bloque III - RP'+periodo+'</th>';
            html += '<th style="background:#E74C3C;">Bloque IV - RP'+periodo+'</th>';
            html += '</tr></thead><tbody>';
            
            for(var i=0; i<estudiantesConRecuperacion.length; i++) {
                var e = estudiantesConRecuperacion[i];
                html += '<tr>';
                html += '<td><strong>'+e.num+'</strong></td>';
                html += '<td style="text-align:left; padding-left:10px;">'+e.nombre+'</td>';
                
                for(var b=0; b<4; b++) {
                    var promPeriodo = calcularPromedioPeriodo(b, periodo, e.num);
                    var recuperacionActual = '';
                    if(datos.bloques[b].recuperaciones && datos.bloques[b].recuperaciones[periodo]) {
                        recuperacionActual = datos.bloques[b].recuperaciones[periodo][e.num] || '';
                    }
                    
                    var infoExtra = '';
                    var colorFondo = '';
                    var habilitado = true;
                    
                    if(promPeriodo !== null) {
                        if(promPeriodo < 70) {
                            infoExtra = ' üìå P'+periodo+': '+Math.round(promPeriodo);
                            colorFondo = 'background:#ffe6cc;';
                        } else {
                            infoExtra = ' ‚úÖ P'+periodo+': '+Math.round(promPeriodo);
                            colorFondo = 'background:#d4edda;';
                            habilitado = false; // Deshabilitar si ya tiene >= 70
                        }
                    }
                    
                    html += '<td>';
                    if(habilitado) {
                        html += '<input type="number" min="0" max="100" ';
                        html += 'value="'+recuperacionActual+'" ';
                        html += 'placeholder="0-100" ';
                        html += 'onchange="guardarRecuperacion('+b+', '+periodo+', '+e.num+', this.value)" ';
                        html += 'style="width:100%; padding:8px; border:2px solid #ff9800; border-radius:6px; text-align:center; font-weight:600; font-size:14px; '+colorFondo+'">';
                    } else {
                        html += '<input type="number" disabled ';
                        html += 'placeholder="No necesita" ';
                        html += 'style="width:100%; padding:8px; border:2px solid #28a745; border-radius:6px; text-align:center; font-weight:600; font-size:13px; '+colorFondo+' color:#666; cursor:not-allowed;">';
                    }
                    html += '<div style="font-size:11px; color:#666; margin-top:3px;">'+infoExtra+'</div>';
                    html += '</td>';
                }
                
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            
            html += '<div style="margin-top:20px; padding:15px; background:#d1ecf1; border-left:4px solid #0c5460; border-radius:5px;">';
            html += '<strong>üí° Nota:</strong><br>';
            html += '‚Ä¢ Solo puedes ingresar recuperaciones para estudiantes con calificaci√≥n <strong>menor a 70</strong>.<br>';
            html += '‚Ä¢ Los campos con ‚úÖ est√°n deshabilitados porque el estudiante ya aprob√≥ ese bloque.<br>';
            html += '‚Ä¢ El sistema tomar√° autom√°ticamente la calificaci√≥n <strong>m√°s alta</strong> entre P'+periodo+' y RP'+periodo+'.';
            html += '</div>';
            
            document.getElementById('contenedorRecuperacion').innerHTML = html;
        }
        
        function guardarRecuperacion(bloque, periodo, numEstudiante, valor) {
            if(!datos.bloques[bloque].recuperaciones) {
                datos.bloques[bloque].recuperaciones = {1:{}, 2:{}, 3:{}, 4:{}};
            }
            if(!datos.bloques[bloque].recuperaciones[periodo]) {
                datos.bloques[bloque].recuperaciones[periodo] = {};
            }
            
            if(valor === '' || valor === null) {
                delete datos.bloques[bloque].recuperaciones[periodo][numEstudiante];
            } else {
                datos.bloques[bloque].recuperaciones[periodo][numEstudiante] = parseFloat(valor);
            }
            
            guardarDatosLocalStorage();
            renderReporteFinal();
            mostrarMensaje('‚úì Recuperaci√≥n guardada');
        }
        
        // ==================== FIN FUNCIONES DE RECUPERACI√ìN ====================
        
        function importarWord(event) {
            var archivo = event.target.files[0];
            if(!archivo) return;
            
            if(typeof mammoth === 'undefined') {
                mostrarMensaje('‚úó Biblioteca no disponible', true);
                return;
            }
            
            mostrarMensaje('‚è≥ Leyendo archivo Word...');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                mammoth.extractRawText({arrayBuffer: e.target.result})
                    .then(function(resultado) {
                        var texto = resultado.value;
                        var lineas = texto.split(/[\r\n]+/);
                        var nombres = [];
                        
                        for(var i=0; i<lineas.length; i++) {
                            var linea = lineas[i].trim();
                            if(linea.length === 0) continue;
                            linea = linea.replace(/^\d+[\.\)\-\s]+/, '').trim();
                            if(linea.length > 0) nombres.push(linea);
                        }
                        
                        if(nombres.length === 0) {
                            mostrarMensaje('‚úó No se encontraron nombres', true);
                            return;
                        }
                        
                        if(confirm('¬øImportar ' + nombres.length + ' estudiantes?')) {
                            datos.estudiantes = [];
                            for(var i=0; i<nombres.length; i++) {
                                datos.estudiantes.push({num: i+1, nombre: nombres[i]});
                            }
                            renderEstudiantes();
                            renderBloques();
                            renderEstadisticas();
                            guardarDatosLocalStorage();
                            mostrarMensaje('‚úì ' + nombres.length + ' estudiantes importados');
                        }
                    })
                    .catch(function(error) {
                        mostrarMensaje('‚úó Error al leer Word', true);
                    });
            };
            reader.readAsArrayBuffer(archivo);
            event.target.value = '';
        }
        
        // IMPORTAR WORD MULTIGRADO - Detecta autom√°ticamente todos los grados
        function importarWordMultigrado(event) {
            var archivo = event.target.files[0];
            if(!archivo) return;
            
            if(typeof mammoth === 'undefined') {
                mostrarMensaje('‚úó Biblioteca mammoth no disponible', true);
                return;
            }
            
            mostrarMensaje('‚è≥ Leyendo archivo Word multigrado...');
            
            var reader = new FileReader();
            reader.onload = function(e) {
                mammoth.extractRawText({arrayBuffer: e.target.result})
                    .then(function(resultado) {
                        var texto = resultado.value;
                        var lineas = texto.split(/[\r\n]+/);
                        
                        // Detectar grados autom√°ticamente
                        var gradosDetectados = {};
                        var gradoActualLectura = null;
                        var seccionActualLectura = null;
                        
                        // Patrones para detectar grados y secciones
                        var patronGradoSeccion = /^(1[er][ora]?|2[dn][oda]?|3[er][ora]?|4[tt][ota]?|5[tt][ota]?|6[tt][ota]?)\s*[-‚Äì‚Äî]\s*([A-D])\b/i;
                        
                        var patronesGrado = [
                            {regex: /^1[ER][ORA]?\b/i, grado: '1ro'},
                            {regex: /^2[DN][ODA]?\b/i, grado: '2do'},
                            {regex: /^3[ER][ORA]?\b/i, grado: '3ro'},
                            {regex: /^4[TT][OTA]?\b/i, grado: '4to'},
                            {regex: /^5[TT][OTA]?\b/i, grado: '5to'},
                            {regex: /^6[TT][OTA]?\b/i, grado: '6to'},
                            {regex: /PRIMER[OA]?\s+GRADO/i, grado: '1ro'},
                            {regex: /SEGUND[OA]?\s+GRADO/i, grado: '2do'},
                            {regex: /TERCER[OA]?\s+GRADO/i, grado: '3ro'},
                            {regex: /CUART[OA]?\s+GRADO/i, grado: '4to'},
                            {regex: /QUINT[OA]?\s+GRADO/i, grado: '5to'},
                            {regex: /SEXT[OA]?\s+GRADO/i, grado: '6to'}
                        ];
                        
                        // Patrones para detectar secciones
                        var patronSeccion = /SECCI[O√ì]N\s+([A-D])/i;
                        
                        for(var i=0; i<lineas.length; i++) {
                            var linea = lineas[i].trim();
                            if(linea.length === 0) continue;
                            
                            // PATR√ìN PRINCIPAL: "4to - A" o "4to ‚Äì B"
                            var matchGradoSeccion = linea.match(patronGradoSeccion);
                            if(matchGradoSeccion) {
                                var gradoTexto = matchGradoSeccion[1].toLowerCase();
                                
                                // Normalizar el grado
                                if(gradoTexto.match(/^1/)) gradoActualLectura = '1ro';
                                else if(gradoTexto.match(/^2/)) gradoActualLectura = '2do';
                                else if(gradoTexto.match(/^3/)) gradoActualLectura = '3ro';
                                else if(gradoTexto.match(/^4/)) gradoActualLectura = '4to';
                                else if(gradoTexto.match(/^5/)) gradoActualLectura = '5to';
                                else if(gradoTexto.match(/^6/)) gradoActualLectura = '6to';
                                
                                seccionActualLectura = matchGradoSeccion[2].toUpperCase();
                                
                                if(!gradosDetectados[gradoActualLectura]) {
                                    gradosDetectados[gradoActualLectura] = {};
                                }
                                if(!gradosDetectados[gradoActualLectura][seccionActualLectura]) {
                                    gradosDetectados[gradoActualLectura][seccionActualLectura] = [];
                                }
                                
                                console.log('Detectado: ' + gradoActualLectura + ' - Secci√≥n ' + seccionActualLectura);
                                continue;
                            }
                            
                            // Detectar grado solo (sin secci√≥n en la misma l√≠nea)
                            var gradoDetectado = null;
                            for(var p=0; p<patronesGrado.length; p++) {
                                if(patronesGrado[p].regex.test(linea)) {
                                    gradoDetectado = patronesGrado[p].grado;
                                    break;
                                }
                            }
                            
                            if(gradoDetectado) {
                                gradoActualLectura = gradoDetectado;
                                
                                // Detectar secci√≥n en la misma l√≠nea
                                var matchSeccion = linea.match(patronSeccion);
                                if(matchSeccion) {
                                    seccionActualLectura = matchSeccion[1].toUpperCase();
                                } else {
                                    seccionActualLectura = 'A'; // Default
                                }
                                
                                if(!gradosDetectados[gradoActualLectura]) {
                                    gradosDetectados[gradoActualLectura] = {};
                                }
                                if(!gradosDetectados[gradoActualLectura][seccionActualLectura]) {
                                    gradosDetectados[gradoActualLectura][seccionActualLectura] = [];
                                }
                                
                                console.log('Detectado (alt): ' + gradoActualLectura + ' - Secci√≥n ' + seccionActualLectura);
                                continue;
                            }
                            
                            // Detectar secci√≥n independiente
                            var matchSeccionSola = linea.match(patronSeccion);
                            if(matchSeccionSola && gradoActualLectura) {
                                seccionActualLectura = matchSeccionSola[1].toUpperCase();
                                if(!gradosDetectados[gradoActualLectura][seccionActualLectura]) {
                                    gradosDetectados[gradoActualLectura][seccionActualLectura] = [];
                                }
                                continue;
                            }
                            
                            // Si estamos en un grado, agregar el nombre
                            if(gradoActualLectura && seccionActualLectura) {
                                // Limpiar numeraci√≥n al inicio (si existe)
                                var nombre = linea.replace(/^\d+[\.\)\-\s]+/, '').trim();
                                
                                // Validar que sea un nombre v√°lido
                                // - Debe tener al menos una coma (APELLIDO, NOMBRE)
                                // - Debe tener al menos 5 caracteres
                                // - No debe ser un encabezado com√∫n
                                if(nombre.length >= 5 && 
                                   nombre.includes(',') &&
                                   !nombre.match(/^(LISTA|ESTUDIANTES|ALUMNOS|NOMBRES|GRADO|SECCION|A√ëO)/i)) {
                                    
                                    gradosDetectados[gradoActualLectura][seccionActualLectura].push(nombre);
                                    console.log('Agregado a ' + gradoActualLectura + '-' + seccionActualLectura + ': ' + nombre);
                                }
                            }
                        }
                        
                        // Contar total de estudiantes
                        var totalEstudiantes = 0;
                        var resumen = [];
                        
                        for(var grado in gradosDetectados) {
                            for(var seccion in gradosDetectados[grado]) {
                                var cantidad = gradosDetectados[grado][seccion].length;
                                totalEstudiantes += cantidad;
                                if(cantidad > 0) {
                                    resumen.push(grado + '-' + seccion + ': ' + cantidad + ' estudiantes');
                                }
                            }
                        }
                        
                        if(totalEstudiantes === 0) {
                            mostrarMensaje('‚úó No se detectaron estudiantes. Verifica el formato del Word.', true);
                            return;
                        }
                        
                        // Mostrar resumen y confirmar
                        var mensaje = 'üìö ESTUDIANTES DETECTADOS:\n\n' + resumen.join('\n') + '\n\n' +
                                     'TOTAL: ' + totalEstudiantes + ' estudiantes\n\n' +
                                     '¬øImportar todos estos estudiantes?';
                        
                        if(confirm(mensaje)) {
                            // Importar a la estructura multigrado
                            for(var grado in gradosDetectados) {
                                for(var seccion in gradosDetectados[grado]) {
                                    var nombres = gradosDetectados[grado][seccion];
                                    if(nombres.length > 0) {
                                        // Crear o actualizar la secci√≥n
                                        if(!datosMultigrado.grados[grado].secciones[seccion]) {
                                            datosMultigrado.grados[grado].secciones[seccion] = crearEstructuraSeccion();
                                        }
                                        
                                        // Agregar estudiantes
                                        datosMultigrado.grados[grado].secciones[seccion].estudiantes = [];
                                        for(var n=0; n<nombres.length; n++) {
                                            datosMultigrado.grados[grado].secciones[seccion].estudiantes.push({
                                                num: n+1,
                                                nombre: nombres[n]
                                            });
                                        }
                                        
                                        console.log('‚úì Importados ' + nombres.length + ' estudiantes en ' + grado + '-' + seccion);
                                    }
                                }
                            }
                            
                            // Recargar la secci√≥n actual
                            cargarSeccion(datosMultigrado.gradoActual, datosMultigrado.seccionActual);
                            renderEstudiantes();
                            renderBloques();
                            renderEstadisticas();
                            guardarDatosLocalStorage();
                            
                            mostrarMensaje('‚úì Importados ' + totalEstudiantes + ' estudiantes en ' + resumen.length + ' secciones');
                        }
                    })
                    .catch(function(error) {
                        console.error('Error:', error);
                        mostrarMensaje('‚úó Error al leer Word: ' + error.message, true);
                    });
            };
            reader.readAsArrayBuffer(archivo);
            event.target.value = '';
        }
        
        function abrirModalPDF() {
            document.getElementById('modalPDF').style.display = 'block';
        }
        
        function cerrarModalPDF() {
            document.getElementById('modalPDF').style.display = 'none';
        }
        
        function exportarPDF(opcion) {
            try {
                cerrarModalPDF();
                actualizarInfo();
                
                console.log('===================================');
                console.log('üìÑ INICIANDO EXPORTACI√ìN PDF');
                console.log('===================================');
                console.log('Opci√≥n seleccionada:', opcion);
                console.log('Timestamp:', new Date().toISOString());
                
                mostrarMensaje('‚è≥ Generando PDF...');
                
                // PASO 1: Verificar window.jspdf
                console.log('\nüîç PASO 1: Verificando window.jspdf');
                console.log('typeof window.jspdf:', typeof window.jspdf);
                
                if (typeof window.jspdf === 'undefined') {
                    const error = 'jsPDF no est√° cargado. La biblioteca no se descarg√≥ correctamente.';
                    console.error('‚ùå ERROR:', error);
                    alert('‚ùå ' + error + '\n\nSOLUCI√ìN:\n1. Verifica tu conexi√≥n a internet\n2. Recarga la p√°gina (F5)\n3. Intenta nuevamente');
                    mostrarMensaje('‚úó ' + error, true);
                    return;
                }
                console.log('‚úÖ window.jspdf existe');
                
                // PASO 2: Extraer jsPDF
                console.log('\nüîç PASO 2: Extrayendo jsPDF');
                const { jsPDF } = window.jspdf;
                console.log('typeof jsPDF:', typeof jsPDF);
                console.log('‚úÖ jsPDF extra√≠do correctamente');
                
                // PASO 3: Crear instancia de prueba para verificar autoTable
                console.log('\nüîç PASO 3: Verificando autoTable');
                const testDoc = new jsPDF();
                console.log('typeof testDoc.autoTable:', typeof testDoc.autoTable);
                
                if (typeof testDoc.autoTable !== 'function') {
                    const error = 'Plugin autoTable no est√° cargado. Se necesita para generar las tablas.';
                    console.error('‚ùå ERROR:', error);
                    alert('‚ùå ' + error + '\n\nSOLUCI√ìN:\n1. Recarga la p√°gina (F5)\n2. Verifica tu conexi√≥n a internet\n3. Intenta nuevamente');
                    mostrarMensaje('‚úó ' + error, true);
                    return;
                }
                console.log('‚úÖ autoTable est√° disponible');
                
                // PASO 4: Verificar datos m√≠nimos
                console.log('\nüîç PASO 4: Verificando datos');
                console.log('Estudiantes:', datos.estudiantes.length);
                
                if (datos.estudiantes.length === 0) {
                    const error = 'No hay estudiantes. Agrega al menos un estudiante antes de exportar.';
                    console.error('‚ö†Ô∏è ADVERTENCIA:', error);
                    alert('‚ö†Ô∏è ' + error);
                    mostrarMensaje('‚úó ' + error, true);
                    return;
                }
                console.log('‚úÖ Datos verificados');
                
                // PASO 5: Generar PDF seg√∫n opci√≥n
                console.log('\nüîç PASO 5: Generando PDF');
                let nombreArchivo;
                
                if(opcion === 'final') {
                    console.log('üìä Generando Reporte Final...');
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: [297, 420]
                    });
                    console.log('‚úÖ Documento creado');
                    
                    generarPDFReporteFinal(doc);
                    console.log('‚úÖ Reporte Final generado');
                    
                    nombreArchivo = 'Reporte_Final_' + datos.info.asignatura + '.pdf';
                    
                } else {
                    const bloqueNum = parseInt(opcion);
                    console.log('üìò Generando Bloque', bloqueNum, '...');
                    
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    console.log('‚úÖ Documento creado');
                    
                    generarPDFBloque(doc, bloqueNum);
                    console.log('‚úÖ Bloque', bloqueNum, 'generado');
                    
                    nombreArchivo = 'Bloque_' + bloqueNum + '_' + datos.info.asignatura + '.pdf';
                }
                
                // PASO 6: Guardar archivo
                console.log('\nüîç PASO 6: Guardando archivo');
                console.log('Nombre archivo:', nombreArchivo);
                
                if (opcion === 'final') {
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: [297, 420]
                    });
                    generarPDFReporteFinal(doc);
                    doc.save(nombreArchivo);
                } else {
                    const bloqueNum = parseInt(opcion);
                    const doc = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    generarPDFBloque(doc, bloqueNum);
                    doc.save(nombreArchivo);
                }
                
                console.log('‚úÖ Archivo guardado');
                
                console.log('\n===================================');
                console.log('‚úÖ EXPORTACI√ìN EXITOSA');
                console.log('===================================');
                
                mostrarMensaje('‚úì PDF generado: ' + nombreArchivo);
                
            } catch(error) {
                console.log('\n===================================');
                console.log('‚ùå ERROR EN EXPORTACI√ìN');
                console.log('===================================');
                console.error('Tipo:', error.name);
                console.error('Mensaje:', error.message);
                console.error('Stack:', error.stack);
                console.log('===================================');
                
                alert('‚ùå Error al generar PDF:\n\n' + error.message + '\n\n' + 
                      'Por favor:\n' +
                      '1. Copia el error de la consola (F12)\n' +
                      '2. Reporta el error completo\n\n' +
                      'Error t√©cnico: ' + error.name);
                
                mostrarMensaje('‚úó Error: ' + error.message, true);
            }
        }
        
        // GENERAR PDF REPORTE FINAL - FORMATO MEJORADO
        function generarPDFReporteFinal(doc) {
            doc.setFontSize(18);
            doc.setTextColor(31, 78, 120);
            doc.text('REPORTE FINAL - ' + datos.info.asignatura.toUpperCase(), 210, 15, {align:'center'});
            
            doc.setFontSize(11);
            doc.setTextColor(0,0,0);
            var y = 22;
            doc.text('Centro: ' + datos.info.centro, 15, y);
            y += 6;
            doc.text('Maestro/a: ' + datos.info.maestro, 15, y);
            y += 6;
            doc.text('Grado: ' + datos.info.grado + ' | A√±o Escolar: ' + datos.info.anio, 15, y);
            y += 12;
            
            // DETECTAR QU√â PER√çODOS TIENEN RECUPERACIONES
            var periodosConRecup = [];
            for(var b=0; b<4; b++) {
                periodosConRecup[b] = {};
                for(var p=1; p<=4; p++) {
                    var bd = datos.bloques[b];
                    var hayRecup = false;
                    
                    if(bd.recuperaciones && bd.recuperaciones[p]) {
                        for(var key in bd.recuperaciones[p]) {
                            if(bd.recuperaciones[p][key]) {
                                hayRecup = true;
                                break;
                            }
                        }
                    }
                    
                    periodosConRecup[b][p] = hayRecup;
                }
            }
            
            // CONSTRUIR HEADERS DIN√ÅMICOS
            var headers = [];
            var headerRow1 = [
                {content: 'No.', rowSpan: 2, styles: {valign: 'middle'}},
                {content: 'Estudiante', rowSpan: 2, styles: {valign: 'middle'}}
            ];
            var headerRow2 = [];
            
            var bloquesNombres = ['BLOQUE I', 'BLOQUE II', 'BLOQUE III', 'BLOQUE IV'];
            var bloquesColores = [
                [68,114,196],
                [112,173,71],
                [255,192,0],
                [231,76,60]
            ];
            
            var columnStyles = {
                0: {cellWidth: 10, halign: 'center', fontSize: 11},
                1: {cellWidth: 50, halign: 'left', fontSize: 11}
            };
            var colIdx = 2;
            
            // Para cada bloque
            for(var b=0; b<4; b++) {
                var colCount = 0;
                
                // Contar columnas del bloque (P + R si hay recuperaci√≥n)
                for(var p=1; p<=4; p++) {
                    colCount++; // Columna de per√≠odo
                    if(periodosConRecup[b][p]) {
                        colCount++; // Columna de recuperaci√≥n
                    }
                }
                
                // Header del bloque
                headerRow1.push({
                    content: bloquesNombres[b],
                    colSpan: colCount,
                    styles: {
                        fillColor: bloquesColores[b],
                        textColor: b === 2 ? [0,0,0] : [255,255,255],
                        halign: 'center'
                    }
                });
                
                // Headers de per√≠odos
                for(var p=1; p<=4; p++) {
                    headerRow2.push('P'+p);
                    columnStyles[colIdx] = {
                        fillColor: getLightColor(bloquesColores[b]),
                        fontSize: 10
                    };
                    colIdx++;
                    
                    if(periodosConRecup[b][p]) {
                        headerRow2.push('RP'+p);
                        columnStyles[colIdx] = {
                            fillColor: getLighterColor(bloquesColores[b]),
                            fontSize: 9,
                            fontStyle: 'italic'
                        };
                        colIdx++;
                    }
                }
            }
            
            // Columna de promedio de bloque
            headerRow1.push({
                content: 'PROM BLOQUE',
                colSpan: 4,
                styles: {fillColor: [255,193,7], textColor: [0,0,0], halign: 'center'}
            });
            headerRow2.push('PB1', 'PB2', 'PB3', 'PB4');
            for(var i=0; i<4; i++) {
                columnStyles[colIdx] = {
                    fillColor: [255,243,205],
                    fontStyle: 'bold',
                    fontSize: 10
                };
                colIdx++;
            }
            
            // Columnas finales
            headerRow1.push(
                {content: 'FINAL', rowSpan: 2, styles: {fillColor: [40,167,69], valign: 'middle'}},
                {content: 'COND', rowSpan: 2, styles: {fillColor: [40,167,69], valign: 'middle'}}
            );
            columnStyles[colIdx] = {fillColor: [212,237,218], fontStyle: 'bold', fontSize: 12};
            columnStyles[colIdx+1] = {fillColor: [212,237,218], fontStyle: 'bold', fontSize: 11};
            
            headers = [headerRow1, headerRow2];
            
            // GENERAR FILAS DE DATOS
            var rows = [];
            
            for(var ei=0; ei<datos.estudiantes.length; ei++) {
                var e = datos.estudiantes[ei];
                var row = [e.num, e.nombre];
                
                var promBloques = [];
                
                // Para cada bloque
                for(var b=0; b<4; b++) {
                    // Para cada per√≠odo
                    for(var p=1; p<=4; p++) {
                        var pr = calcularPromedioPeriodo(b, p, e.num);
                        var bd = datos.bloques[b];
                        var recuperacion = null;
                        
                        if(bd.recuperaciones && bd.recuperaciones[p] && bd.recuperaciones[p][e.num]) {
                            recuperacion = parseFloat(bd.recuperaciones[p][e.num]);
                        }
                        
                        // Agregar columna de per√≠odo
                        row.push(pr !== null ? Math.round(pr) : '-');
                        
                        // Si este per√≠odo tiene recuperaciones, agregar columna de recuperaci√≥n
                        if(periodosConRecup[b][p]) {
                            if(recuperacion !== null && !isNaN(recuperacion)) {
                                row.push(Math.round(recuperacion));
                            } else {
                                row.push('-');
                            }
                        }
                    }
                    
                    // Calcular promedio del bloque CON recuperaciones
                    var pb = calcularPromedioBloque(b, e.num);
                    promBloques.push(pb !== null ? pb : 0);
                }
                
                // Agregar promedios de cada bloque
                for(var b=0; b<4; b++) {
                    row.push(promBloques[b] > 0 ? promBloques[b].toFixed(2) : '-');
                }
                
                // Calcular promedio final
                var sumaFinal = 0;
                var bloquesConNota = 0;
                for(var b=0; b<4; b++) {
                    if(promBloques[b] > 0) {
                        sumaFinal += promBloques[b];
                        bloquesConNota++;
                    }
                }
                var pf = bloquesConNota > 0 ? (sumaFinal / bloquesConNota) : 0;
                row.push(pf > 0 ? Math.round(pf) : '-');
                row.push(pf >= 70 ? 'APR' : (pf > 0 ? 'REP' : '-'));
                
                rows.push(row);
            }
            
            // GENERAR TABLA
            doc.autoTable({
                startY: y,
                head: headers,
                body: rows,
                theme: 'grid',
                styles: {fontSize: 9, cellPadding: 2, halign: 'center'},
                headStyles: {fillColor: [31,78,120], textColor: 255, fontSize: 10, fontStyle: 'bold'},
                columnStyles: columnStyles,
                margin: {left: 10, right: 10}
            });
        }
        
        // FUNCI√ìN AUXILIAR: Obtener color claro
        function getLightColor(rgb) {
            return [
                Math.min(255, rgb[0] + 80),
                Math.min(255, rgb[1] + 80),
                Math.min(255, rgb[2] + 80)
            ];
        }
        
        // FUNCI√ìN AUXILIAR: Obtener color m√°s claro
        function getLighterColor(rgb) {
            return [
                Math.min(255, rgb[0] + 120),
                Math.min(255, rgb[1] + 120),
                Math.min(255, rgb[2] + 120)
            ];
        }
        
        function generarPDFBloque(doc, bloqueNum) {
            try {
                const bd = datos.bloques[bloqueNum-1];
                const bloqueNombres = ['I','II','III','IV'];
                
                // T√çTULO
                doc.setFontSize(18);
                doc.setTextColor(102, 126, 234);
                const titulo = 'BLOQUE ' + bloqueNombres[bloqueNum-1];
                doc.text(titulo, 148, 15, {align:'center'});
                
                // INFORMACI√ìN
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Centro: ' + (datos.info.centro || ''), 15, 25);
                doc.text('Maestro: ' + (datos.info.maestro || ''), 15, 30);
                doc.text('Grado: ' + (datos.info.grado || '') + ' | Asignatura: ' + (datos.info.asignatura || '') + ' | A√±o: ' + (datos.info.anio || ''), 15, 35);
                
                let yPos = 45;
                
                // COMPETENCIAS
                doc.setFillColor(240, 244, 255);
                doc.rect(15, yPos, 270, 8, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text('COMPETENCIAS DEL BLOQUE', 17, yPos + 5);
                yPos += 12;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                
                if (bd.comp && bd.comp.length > 0) {
                    for(let ci=0; ci<bd.comp.length; ci++) {
                        const c = bd.comp[ci];
                        const textoComp = (ci+1) + '. ' + (c.competencia || '');
                        const lineas = doc.splitTextToSize(textoComp, 265);
                        doc.text(lineas, 18, yPos);
                        yPos += lineas.length * 5;
                    }
                } else {
                    doc.text('No hay competencias definidas', 18, yPos);
                    yPos += 6;
                }
                
                yPos += 5;
                
                // PROCESAR CADA PER√çODO
                for(let periodo=1; periodo<=4; periodo++) {
                    const periodoData = bd.periodos[periodo];
                    
                    if(yPos > 180) {
                        doc.addPage('landscape', 'a4');
                        yPos = 20;
                    }
                    
                    // T√çTULO DEL PER√çODO
                    doc.setFillColor(255, 243, 224);
                    doc.rect(15, yPos, 270, 8, 'F');
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 152, 0);
                    doc.text('PERIODO ' + periodo, 17, yPos + 5);
                    yPos += 12;
                    
                    // INDICADORES Y CRITERIOS DEL PER√çODO
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    
                    let criteriosInfo = [];
                    
                    if(periodoData.indicadores && periodoData.indicadores.length > 0) {
                        for(let ii=0; ii<periodoData.indicadores.length; ii++) {
                            const ind = periodoData.indicadores[ii];
                            
                            // Indicador
                            doc.setFont(undefined, 'bold');
                            const textoInd = '  Indicador ' + (ii+1) + ': ' + (ind.texto || '');
                            const lineasInd = doc.splitTextToSize(textoInd, 260);
                            doc.text(lineasInd, 18, yPos);
                            yPos += lineasInd.length * 4;
                            doc.setFont(undefined, 'normal');
                            
                            // Criterios
                            if(ind.criterios && ind.criterios.length > 0) {
                                for(let cr=0; cr<ind.criterios.length; cr++) {
                                    const critObj = ind.criterios[cr];
                                    const critTexto = typeof critObj === 'string' ? critObj : (critObj.texto || '');
                                    const critTipo = typeof critObj === 'string' ? 'letra' : (critObj.tipo || 'letra');
                                    const tipoTexto = critTipo === 'numero' ? '[NUM]' : '[LET]';
                                    
                                    criteriosInfo.push({texto: critTexto, tipo: critTipo});
                                    
                                    const textoCrit = '     - C' + criteriosInfo.length + ': ' + critTexto + ' ' + tipoTexto;
                                    const lineasCrit = doc.splitTextToSize(textoCrit, 255);
                                    doc.text(lineasCrit, 20, yPos);
                                    yPos += lineasCrit.length * 4;
                                    
                                    if(yPos > 185) {
                                        doc.addPage('landscape', 'a4');
                                        yPos = 20;
                                    }
                                }
                            }
                        }
                        
                        yPos += 3;
                        
                        // TABLA DE CALIFICACIONES DEL PER√çODO
                        if(criteriosInfo.length > 0 && datos.estudiantes && datos.estudiantes.length > 0) {
                            if(yPos > 150) {
                                doc.addPage('landscape', 'a4');
                                yPos = 20;
                            }
                            
                            // Headers
                            const headers = [['No.', 'Estudiante']];
                            for(let i=0; i<criteriosInfo.length; i++) {
                                const tipoAbrev = criteriosInfo[i].tipo === 'numero' ? '[N] ' : '[L] ';
                                headers[0].push(tipoAbrev + 'C' + (i+1));
                            }
                            headers[0].push('PROM');
                            
                            // Filas
                            const rows = [];
                            for(let ei=0; ei<datos.estudiantes.length; ei++) {
                                const e = datos.estudiantes[ei];
                                const row = [e.num, e.nombre];
                                
                                let suma = 0, cuenta = 0;
                                
                                for(let i=0; i<criteriosInfo.length; i++) {
                                    const key = e.num + '_' + periodo + '_' + i;
                                    const cal = periodoData.cal[key] || '-';
                                    row.push(cal);
                                    
                                    if(cal !== '-') {
                                        if(criteriosInfo[i].tipo === 'numero') {
                                            const valor = parseFloat(cal);
                                            if(!isNaN(valor)) {
                                                suma += valor;
                                                cuenta++;
                                            }
                                        } else if(NOTAS[cal]) {
                                            suma += NOTAS[cal];
                                            cuenta++;
                                        }
                                    }
                                }
                                
                                const promedio = cuenta > 0 ? (suma/cuenta).toFixed(1) : '-';
                                row.push(promedio);
                                rows.push(row);
                            }
                            
                            // Generar tabla
                            doc.autoTable({
                                startY: yPos,
                                head: headers,
                                body: rows,
                                theme: 'striped',
                                styles: {
                                    fontSize: 7,
                                    cellPadding: 2,
                                    halign: 'center',
                                    valign: 'middle'
                                },
                                headStyles: {
                                    fillColor: [102, 126, 234],
                                    textColor: [255, 255, 255],
                                    fontSize: 8,
                                    fontStyle: 'bold',
                                    halign: 'center'
                                },
                                columnStyles: {
                                    0: {cellWidth: 12, halign: 'center'},
                                    1: {cellWidth: 45, halign: 'left'}
                                },
                                alternateRowStyles: {
                                    fillColor: [248, 249, 250]
                                }
                            });
                            
                            yPos = doc.lastAutoTable.finalY + 8;
                        } else {
                            doc.setFontSize(8);
                            doc.setTextColor(150, 150, 150);
                            doc.text('Sin calificaciones en este periodo', 18, yPos);
                            yPos += 10;
                        }
                        
                    } else {
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text('Sin indicadores en este periodo', 18, yPos);
                        yPos += 10;
                    }
                }
                
                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for(let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Generado: ' + new Date().toLocaleDateString(), 15, 200);
                    doc.text('Pagina ' + i + ' de ' + pageCount, 270, 200);
                }
                
            } catch(error) {
                console.error('Error en generarPDFBloque:', error);
                throw error;
            }
        }
        
        function renderEstudiantes() {
            var html = '';
            for(var i=0; i<datos.estudiantes.length; i++) {
                var e = datos.estudiantes[i];
                html += '<div class="estudiante">'+
                    '<span style="font-weight:bold;width:40px;text-align:center">'+e.num+'</span>'+
                    '<input value="'+e.nombre+'" onchange="actualizarEstudiante('+i+',this.value)" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px">'+
                    '<button class="btn-eliminar" onclick="eliminarEstudiante('+i+')">üóëÔ∏è</button>'+
                    '</div>';
            }
            document.getElementById('listaEstudiantes').innerHTML = html;
        }
        
        function agregarEstudiante() {
            var num = datos.estudiantes.length + 1;
            datos.estudiantes.push({num:num, nombre:'Estudiante '+num});
            renderEstudiantes();
            renderBloques();
            renderEstadisticas();
            guardarDatosLocalStorage();
            mostrarMensaje('‚úì Estudiante agregado');
        }
        
        function actualizarEstudiante(idx, nombre) {
            datos.estudiantes[idx].nombre = nombre;
            renderBloques();
            guardarDatosLocalStorage();
        }
        
        function eliminarEstudiante(idx) {
            if(confirm('¬øEliminar?')) {
                datos.estudiantes.splice(idx, 1);
                for(var i=0; i<datos.estudiantes.length; i++) {
                    datos.estudiantes[i].num = i+1;
                }
                renderEstudiantes();
                renderBloques();
                renderEstadisticas();
                guardarDatosLocalStorage();
                mostrarMensaje('‚úì Eliminado');
            }
        }
        
        function renderBloques() {
            var nombres = ['I','II','III','IV'];
            for(var b=1; b<=4; b++) {
                var bloqueDiv = document.getElementById('bloque'+b);
                var bd = datos.bloques[b-1];
                
                var html = '<div class="seccion">';
                html += '<h2>üìò Bloque '+nombres[b-1]+'</h2>';
                html += '<h3 style="color:#ff9800;margin:15px 0;">üìã Competencias del Bloque (Comunes a todos los per√≠odos)</h3>';
                html += '<button class="btn-agregar" onclick="agregarCompetencia('+(b-1)+')">‚ûï Agregar Competencia</button>';
                html += '<div id="comp-'+b+'"></div>';
                html += '</div>';
                
                html += '<div class="seccion">';
                html += '<h2>üìù Indicadores y Criterios por Per√≠odo</h2>';
                html += '<div class="tabs-periodo">';
                for(var p=1; p<=4; p++) {
                    html += '<button onclick="cambiarPeriodo('+b+','+p+')" id="tab-'+b+'-'+p+'" '+(p===1?'class="activo"':'')+'>Per√≠odo '+p+'</button>';
                }
                html += '</div>';
                html += '<div id="indicadores-'+b+'"></div>';
                html += '</div>';
                
                html += '<div class="seccion">';
                html += '<h2>üìä Calificaciones</h2>';
                html += '<div id="tabla-'+b+'"></div>';
                html += '</div>';
                
                bloqueDiv.innerHTML = html;
                renderCompetencias(b);
                renderIndicadoresPeriodo(b, 1);
                renderTabla(b, 1);
            }
        }
        
        function renderCompetencias(bloque) {
            var bd = datos.bloques[bloque-1];
            var html = '';
            for(var ci=0; ci<bd.comp.length; ci++) {
                var c = bd.comp[ci];
                html += '<div class="competencia-card">';
                html += '<div class="competencia-header">';
                html += '<span class="competencia-titulo">üìò COMPETENCIA '+(ci+1)+'</span>';
                html += '<button class="btn-eliminar" onclick="eliminarCompetencia('+(bloque-1)+','+ci+')">üóëÔ∏è</button>';
                html += '</div>';
                html += '<div class="competencia-content">';
                html += '<textarea onchange="actualizarComp('+(bloque-1)+','+ci+',this.value)" placeholder="Escribe la competencia...">'+c.competencia+'</textarea>';
                html += '</div>';
                html += '</div>';
            }
            document.getElementById('comp-'+bloque).innerHTML = html;
        }
        
        var periodoActualPorBloque = {1:1, 2:1, 3:1, 4:1}; // Mantener per√≠odo activo por bloque
        
        function renderIndicadoresPeriodo(bloque, periodo) {
            periodoActualPorBloque[bloque] = periodo;
            var bd = datos.bloques[bloque-1];
            var periodoData = bd.periodos[periodo];
            
            console.log('üîç Renderizando Bloque '+bloque+' Per√≠odo '+periodo);
            console.log('üìä Indicadores:', periodoData.indicadores);
            
            var html = '<div style="margin:20px 0;padding:15px;background:#fff3e0;border-radius:8px;">';
            html += '<h4 style="margin:0;color:#ff9800;">üìå Indicadores y Criterios del Per√≠odo '+periodo+'</h4>';
            html += '<p style="margin:10px 0 0 0;font-size:13px;color:#666;">Estos indicadores y criterios son espec√≠ficos de este per√≠odo.</p>';
            html += '</div>';
            
            html += '<button class="btn-agregar" onclick="agregarIndicadorPeriodo('+(bloque-1)+','+periodo+')">‚ûï Agregar Indicador</button>';
            
            for(var ii=0; ii<periodoData.indicadores.length; ii++) {
                var ind = periodoData.indicadores[ii];
                html += '<div class="indicador-card">';
                html += '<div class="indicador-header">';
                html += '<span class="indicador-label">üìå INDICADOR '+(ii+1)+'</span>';
                html += '<button class="btn-eliminar" onclick="eliminarIndicadorPeriodo('+(bloque-1)+','+periodo+','+ii+')">üóëÔ∏è</button>';
                html += '</div>';
                html += '<input class="indicador-input" value="'+(ind.texto || '')+'" onchange="actualizarIndPeriodo('+(bloque-1)+','+periodo+','+ii+',this.value)" placeholder="Escribe el indicador...">';
                
                for(var cri=0; cri<ind.criterios.length; cri++) {
                    var critObj = ind.criterios[cri];
                    var critTexto = typeof critObj === 'string' ? critObj : (critObj.texto || '');
                    var critTipo = typeof critObj === 'string' ? 'letra' : (critObj.tipo || 'letra');
                    var icono = critTipo === 'numero' ? 'üî¢' : 'üìù';
                    
                    html += '<div class="criterio-card">';
                    html += '<div class="criterio-header">';
                    html += '<span class="criterio-label">'+icono+' CRITERIO '+(cri+1)+'</span>';
                    html += '<button class="btn-eliminar" onclick="eliminarCriterioPeriodo('+(bloque-1)+','+periodo+','+ii+','+cri+')">üóëÔ∏è</button>';
                    html += '</div>';
                    html += '<input class="criterio-input" value="'+critTexto+'" onchange="actualizarCritPeriodo('+(bloque-1)+','+periodo+','+ii+','+cri+',this.value)" placeholder="Escribe el criterio...">';
                    html += '</div>';
                }
                html += '<button class="btn-add-crit" onclick="agregarCriterioPeriodo('+(bloque-1)+','+periodo+','+ii+')">‚ûï Criterio</button>';
                html += '</div>';
            }
            
            document.getElementById('indicadores-'+bloque).innerHTML = html;
        }
        
        // FUNCIONES COMPETENCIAS (nivel bloque)
        function agregarCompetencia(bi) {
            datos.bloques[bi].comp.push({competencia:'Nueva Competencia'});
            renderCompetencias(bi+1);
            guardarDatosLocalStorage();
            mostrarMensaje('‚úì Competencia agregada');
        }
        
        function eliminarCompetencia(bi,ci) {
            if(confirm('¬øEliminar esta competencia?')) {
                datos.bloques[bi].comp.splice(ci,1);
                renderCompetencias(bi+1);
                guardarDatosLocalStorage();
            }
        }
        
        function actualizarComp(bi,ci,val) {
            datos.bloques[bi].comp[ci].competencia = val;
            guardarDatosLocalStorage();
        }
        
        // FUNCIONES INDICADORES/CRITERIOS (nivel per√≠odo)
        function agregarIndicadorPeriodo(bi,periodo) {
            datos.bloques[bi].periodos[periodo].indicadores.push({texto:'Nuevo Indicador',criterios:['Criterio 1']});
            renderIndicadoresPeriodo(bi+1, periodo);
            renderTabla(bi+1, periodo); // ‚Üê Actualizar tabla de calificaciones
            guardarDatosLocalStorage();
            mostrarMensaje('‚úì Indicador agregado al Per√≠odo '+periodo);
        }
        
        function eliminarIndicadorPeriodo(bi,periodo,ii) {
            if(confirm('¬øEliminar este indicador?')) {
                datos.bloques[bi].periodos[periodo].indicadores.splice(ii,1);
                renderIndicadoresPeriodo(bi+1, periodo);
                guardarDatosLocalStorage();
            }
        }
        
        function actualizarIndPeriodo(bi,periodo,ii,val) {
            datos.bloques[bi].periodos[periodo].indicadores[ii].texto = val;
            guardarDatosLocalStorage();
        }
        
        function agregarCriterioPeriodo(bi,periodo,ii) {
            // Modal para elegir tipo de criterio
            var modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:500px;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <h3 style="margin:0 0 20px 0;color:#667eea;font-size:24px;">‚ûï Nuevo Criterio</h3>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;margin-bottom:8px;font-weight:600;color:#555;">Descripci√≥n del criterio:</label>
                        <input type="text" id="textoCriterio" placeholder="Ej: Mantiene equilibrio correctamente" style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;" value="Nuevo Criterio">
                    </div>
                    
                    <div style="margin-bottom:25px;">
                        <label style="display:block;margin-bottom:12px;font-weight:600;color:#555;">Tipo de calificaci√≥n:</label>
                        <div style="display:flex;gap:15px;">
                            <label style="flex:1;cursor:pointer;">
                                <input type="radio" name="tipoCrit" value="letra" checked style="display:none;">
                                <div class="radio-option" style="padding:15px;border:2px solid #667eea;border-radius:10px;text-align:center;background:#f0f4ff;transition:all 0.3s;">
                                    <div style="font-size:32px;margin-bottom:8px;">üìù</div>
                                    <div style="font-weight:600;color:#667eea;">Letras</div>
                                    <div style="font-size:12px;color:#666;">A+, A, B+, etc.</div>
                                </div>
                            </label>
                            <label style="flex:1;cursor:pointer;">
                                <input type="radio" name="tipoCrit" value="numero" style="display:none;">
                                <div class="radio-option" style="padding:15px;border:2px solid #e0e0e0;border-radius:10px;text-align:center;background:white;transition:all 0.3s;">
                                    <div style="font-size:32px;margin-bottom:8px;">üî¢</div>
                                    <div style="font-weight:600;color:#666;">N√∫meros</div>
                                    <div style="font-size:12px;color:#666;">0 - 100</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;justify-content:flex-end;">
                        <button onclick="this.closest('div[style*=fixed]').remove()" style="padding:12px 24px;background:#e0e0e0;border:none;border-radius:8px;cursor:pointer;font-weight:600;color:#555;">Cancelar</button>
                        <button id="btnGuardarCrit" style="padding:12px 24px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;box-shadow:0 4px 12px rgba(102,126,234,0.3);">Agregar Criterio</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Manejar selecci√≥n visual de radio
            var radios = modal.querySelectorAll('input[type=radio]');
            radios.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    modal.querySelectorAll('.radio-option').forEach(function(opt) {
                        opt.style.border = '2px solid #e0e0e0';
                        opt.style.background = 'white';
                    });
                    var selected = radio.parentElement.querySelector('.radio-option');
                    selected.style.border = '2px solid #667eea';
                    selected.style.background = '#f0f4ff';
                });
            });
            
            // Guardar
            modal.querySelector('#btnGuardarCrit').onclick = function() {
                var texto = modal.querySelector('#textoCriterio').value.trim();
                var tipo = modal.querySelector('input[name=tipoCrit]:checked').value;
                
                if(!texto) {
                    alert('Por favor ingresa una descripci√≥n');
                    return;
                }
                
                datos.bloques[bi].periodos[periodo].indicadores[ii].criterios.push({
                    texto: texto,
                    tipo: tipo
                });
                
                renderIndicadoresPeriodo(bi+1, periodo);
                renderTabla(bi+1, periodo); // ‚Üê Actualizar tabla de calificaciones
                guardarDatosLocalStorage();
                modal.remove();
                mostrarMensaje('‚úì Criterio agregado: ' + (tipo === 'letra' ? 'üìù Letras' : 'üî¢ N√∫meros'));
            };
            
            // Focus en input
            setTimeout(function() {
                modal.querySelector('#textoCriterio').focus();
                modal.querySelector('#textoCriterio').select();
            }, 100);
        }
        
        function eliminarCriterioPeriodo(bi,periodo,ii,cri) {
            if(confirm('¬øEliminar este criterio?')) {
                datos.bloques[bi].periodos[periodo].indicadores[ii].criterios.splice(cri,1);
                renderIndicadoresPeriodo(bi+1, periodo);
                guardarDatosLocalStorage();
            }
        }
        
        function actualizarCritPeriodo(bi,periodo,ii,cri,val) {
            var criterio = datos.bloques[bi].periodos[periodo].indicadores[ii].criterios[cri];
            if(typeof criterio === 'string') {
                // Convertir criterio antiguo a nuevo formato
                datos.bloques[bi].periodos[periodo].indicadores[ii].criterios[cri] = {
                    texto: val,
                    tipo: 'letra'
                };
            } else {
                criterio.texto = val;
            }
            guardarDatosLocalStorage();
        }
        
        function cambiarPeriodo(bloque, periodo) {
            // Actualizar tabs visuales
            for(var p=1; p<=4; p++) {
                var tab = document.getElementById('tab-'+bloque+'-'+p);
                if(tab) {
                    if(p === periodo) {
                        tab.classList.add('activo');
                    } else {
                        tab.classList.remove('activo');
                    }
                }
            }
            
            // Renderizar indicadores y tabla del per√≠odo
            renderIndicadoresPeriodo(bloque, periodo);
            renderTabla(bloque, periodo);
        }
        
        // ==================== FUNCIONES DE RULETA ====================
        
        function dibujarRuleta() {
            const canvas = document.getElementById('ruletaCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 230;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (ruleta.estudiantes.length === 0) {
                ctx.fillStyle = '#ccc';
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#666';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('No hay estudiantes', centerX, centerY);
                return;
            }
            
            const anglePerStudent = (Math.PI * 2) / ruleta.estudiantes.length;
            const colores = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B739', '#52B788'];
            
            for (let i = 0; i < ruleta.estudiantes.length; i++) {
                const startAngle = anglePerStudent * i + ruleta.anguloActual;
                const endAngle = startAngle + anglePerStudent;
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                ctx.closePath();
                
                ctx.fillStyle = colores[i % colores.length];
                ctx.fill();
                
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(startAngle + anglePerStudent / 2);
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.fillText(ruleta.estudiantes[i].nombre, radius * 0.65, 0);
                ctx.restore();
            }
            
            actualizarListaRestantes();
        }
        
        function actualizarListaRestantes() {
            const lista = document.getElementById('listaRestantes');
            const contador = document.getElementById('contadorRestantes');
            
            if (!lista || !contador) return;
            
            contador.textContent = ruleta.estudiantes.length;
            
            let html = '';
            for (let i = 0; i < ruleta.estudiantes.length; i++) {
                html += '<span class="chip-estudiante" style="display:inline-flex;align-items:center;gap:5px;">';
                html += ruleta.estudiantes[i].nombre;
                html += '<button onclick="eliminarEstudianteRuleta(' + ruleta.estudiantes[i].num + ')" style="background:none;border:none;color:white;cursor:pointer;font-weight:bold;padding:0 5px;">√ó</button>';
                html += '</span>';
            }
            
            for (let i = 0; i < ruleta.eliminados.length; i++) {
                html += '<span class="chip-estudiante chip-eliminado">' + ruleta.eliminados[i].nombre + '</span>';
            }
            
            lista.innerHTML = html;
        }
        
        function eliminarEstudianteRuleta(numEstudiante) {
            const indice = ruleta.estudiantes.findIndex(e => e.num === numEstudiante);
            if (indice !== -1) {
                if (confirm('¬øEliminar a ' + ruleta.estudiantes[indice].nombre + ' de la ruleta?')) {
                    ruleta.eliminados.push(ruleta.estudiantes[indice]);
                    ruleta.estudiantes.splice(indice, 1);
                    dibujarRuleta();
                    mostrarMensaje('‚úì Estudiante eliminado de la ruleta');
                }
            }
        }
        
        function girarRuleta() {
            if (ruleta.girando || ruleta.estudiantes.length === 0) return;
            
            ruleta.girando = true;
            document.getElementById('btnGirar').disabled = true;
            document.getElementById('resultadoRuleta').style.display = 'none';
            document.getElementById('btnEliminar').style.display = 'none';
            
            const vueltas = 5 + Math.random() * 3;
            const anguloExtra = Math.random() * Math.PI * 2;
            const anguloTotal = vueltas * Math.PI * 2 + anguloExtra;
            
            const duracion = 4000;
            const inicio = Date.now();
            
            function animar() {
                const transcurrido = Date.now() - inicio;
                const progreso = Math.min(transcurrido / duracion, 1);
                
                const easeOut = 1 - Math.pow(1 - progreso, 3);
                
                ruleta.anguloActual = anguloTotal * easeOut;
                dibujarRuleta();
                
                if (progreso < 1) {
                    requestAnimationFrame(animar);
                } else {
                    finalizarGiro();
                }
            }
            
            animar();
        }
        
        function finalizarGiro() {
            ruleta.girando = false;
            document.getElementById('btnGirar').disabled = false;
            
            const anglePerStudent = (Math.PI * 2) / ruleta.estudiantes.length;
            const anguloNormalizado = (ruleta.anguloActual % (Math.PI * 2) + Math.PI * 2) % (Math.PI * 2);
            
            // La flecha apunta hacia arriba (√°ngulo 0 o 360 grados, que es 3*PI/2 radianes en canvas)
            // Compensar por la rotaci√≥n para encontrar qu√© estudiante est√° en la parte superior
            const anguloFlecha = Math.PI * 1.5; // 270 grados (arriba)
            const anguloRelativoFlecha = (anguloFlecha - anguloNormalizado + Math.PI * 2) % (Math.PI * 2);
            
            // Encontrar el √≠ndice del estudiante bajo la flecha
            const indice = Math.floor(anguloRelativoFlecha / anglePerStudent) % ruleta.estudiantes.length;
            
            ruleta.seleccionado = ruleta.estudiantes[indice];
            
            document.getElementById('nombreSeleccionado').textContent = ruleta.seleccionado.nombre;
            document.getElementById('resultadoRuleta').style.display = 'block';
            document.getElementById('btnEliminar').style.display = 'inline-block';
            
            mostrarMensaje('üéâ Seleccionado: ' + ruleta.seleccionado.nombre);
        }
        
        function eliminarSeleccionado() {
            if (!ruleta.seleccionado) return;
            
            const indice = ruleta.estudiantes.findIndex(e => e.num === ruleta.seleccionado.num);
            if (indice !== -1) {
                ruleta.eliminados.push(ruleta.estudiantes[indice]);
                ruleta.estudiantes.splice(indice, 1);
            }
            
            ruleta.seleccionado = null;
            document.getElementById('resultadoRuleta').style.display = 'none';
            document.getElementById('btnEliminar').style.display = 'none';
            
            dibujarRuleta();
            mostrarMensaje('‚úì Estudiante eliminado del sorteo');
        }
        
        function restaurarRuleta() {
            ruleta.estudiantes = [];
            ruleta.eliminados = [];
            ruleta.seleccionado = null;
            ruleta.anguloActual = 0;
            
            for (let i = 0; i < datos.estudiantes.length; i++) {
                ruleta.estudiantes.push({
                    num: datos.estudiantes[i].num,
                    nombre: datos.estudiantes[i].nombre
                });
            }
            
            document.getElementById('resultadoRuleta').style.display = 'none';
            document.getElementById('btnEliminar').style.display = 'none';
            
            dibujarRuleta();
            mostrarMensaje('‚úì Ruleta restaurada con todos los estudiantes');
        }
        
        function generarGrupos() {
            const numIntegrantes = parseInt(document.getElementById('numIntegrantes').value);
            
            if (!numIntegrantes || numIntegrantes < 2) {
                mostrarMensaje('‚úó Ingresa un n√∫mero v√°lido (m√≠nimo 2)', true);
                return;
            }
            
            // Usar estudiantes de la ruleta (excluyendo eliminados)
            if (ruleta.estudiantes.length === 0) {
                mostrarMensaje('‚úó No hay estudiantes en la ruleta. Usa los botones √ó para eliminar ausentes primero.', true);
                return;
            }
            
            // Crear copia y mezclar aleatoriamente
            const estudiantesAleatorios = [...ruleta.estudiantes].sort(() => Math.random() - 0.5);
            
            const grupos = [];
            let grupoActual = [];
            
            for (let i = 0; i < estudiantesAleatorios.length; i++) {
                grupoActual.push(estudiantesAleatorios[i]);
                
                if (grupoActual.length === numIntegrantes || i === estudiantesAleatorios.length - 1) {
                    grupos.push([...grupoActual]);
                    grupoActual = [];
                }
            }
            
            gruposGenerados = grupos;
            mostrarGrupos(grupos);
            
            // Mostrar botones de exportaci√≥n
            document.getElementById('gruposExportContainer').style.display = 'block';
            
            mostrarMensaje('‚úì Grupos generados con ' + ruleta.estudiantes.length + ' estudiantes');
        }
        
        function mostrarGrupos(grupos) {
            const container = document.getElementById('gruposResultado');
            let html = '';
            
            for (let i = 0; i < grupos.length; i++) {
                html += '<div class="grupo-card">';
                html += '<h3>Grupo ' + (i + 1) + ' (' + grupos[i].length + ' integrantes)</h3>';
                html += '<ul>';
                for (let j = 0; j < grupos[i].length; j++) {
                    html += '<li>' + (j + 1) + '. ' + grupos[i][j].nombre + '</li>';
                }
                html += '</ul>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        // ==================== EXPORTACI√ìN DE GRUPOS ====================
        
        function exportarGruposPDF() {
            if (gruposGenerados.length === 0) {
                mostrarMensaje('‚úó No hay grupos para exportar', true);
                return;
            }
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF no est√° cargado');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // T√çTULO
                doc.setFontSize(20);
                doc.setTextColor(31, 78, 120);
                doc.text('GRUPOS ALEATORIOS', 105, 20, {align: 'center'});
                
                // INFORMACI√ìN
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('Asignatura: ' + (datos.info.asignatura || 'Sin especificar'), 20, 35);
                doc.text('Maestro/a: ' + (datos.info.maestro || 'Sin especificar'), 20, 42);
                doc.text('Fecha: ' + new Date().toLocaleDateString(), 20, 49);
                doc.text('Total de grupos: ' + gruposGenerados.length, 20, 56);
                
                let yPos = 70;
                
                for (let i = 0; i < gruposGenerados.length; i++) {
                    // Verificar si necesita nueva p√°gina
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // T√≠tulo del grupo
                    doc.setFontSize(14);
                    doc.setTextColor(68, 114, 196);
                    doc.text('Grupo ' + (i + 1), 20, yPos);
                    yPos += 8;
                    
                    // Lista de integrantes
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    
                    for (let j = 0; j < gruposGenerados[i].length; j++) {
                        doc.text('   ' + (j + 1) + '. ' + gruposGenerados[i][j].nombre, 20, yPos);
                        yPos += 6;
                    }
                    
                    yPos += 10; // Espacio entre grupos
                }
                
                const fecha = new Date().toISOString().slice(0, 10);
                doc.save('Grupos_' + (datos.info.asignatura || 'Clase') + '_' + fecha + '.pdf');
                
                mostrarMensaje('‚úì PDF de grupos generado');
            } catch(error) {
                console.error('Error al generar PDF:', error);
                mostrarMensaje('‚úó Error al generar PDF: ' + error.message, true);
            }
        }
        
        function exportarGruposExcel() {
            if (gruposGenerados.length === 0) {
                mostrarMensaje('‚úó No hay grupos para exportar', true);
                return;
            }
            
            try {
                const wb = XLSX.utils.book_new();
                
                // Hoja de informaci√≥n
                const infoData = [
                    ['GRUPOS ALEATORIOS'],
                    [''],
                    ['Asignatura:', datos.info.asignatura || 'Sin especificar'],
                    ['Maestro/a:', datos.info.maestro || 'Sin especificar'],
                    ['Fecha:', new Date().toLocaleDateString()],
                    ['Total de grupos:', gruposGenerados.length],
                    ['']
                ];
                
                // Agregar grupos
                for (let i = 0; i < gruposGenerados.length; i++) {
                    infoData.push(['Grupo ' + (i + 1)]);
                    for (let j = 0; j < gruposGenerados[i].length; j++) {
                        infoData.push(['', (j + 1) + '. ' + gruposGenerados[i][j].nombre]);
                    }
                    infoData.push(['']);
                }
                
                const ws = XLSX.utils.aoa_to_sheet(infoData);
                
                // Ajustar anchos de columna
                ws['!cols'] = [
                    {wch: 15},
                    {wch: 40}
                ];
                
                XLSX.utils.book_append_sheet(wb, ws, 'Grupos');
                
                // Crear hoja por cada grupo (opcional)
                for (let i = 0; i < gruposGenerados.length; i++) {
                    const grupoData = [
                        ['Grupo ' + (i + 1)],
                        ['No.', 'Nombre'],
                    ];
                    
                    for (let j = 0; j < gruposGenerados[i].length; j++) {
                        grupoData.push([j + 1, gruposGenerados[i][j].nombre]);
                    }
                    
                    const wsGrupo = XLSX.utils.aoa_to_sheet(grupoData);
                    wsGrupo['!cols'] = [{wch: 10}, {wch: 40}];
                    XLSX.utils.book_append_sheet(wb, wsGrupo, 'Grupo ' + (i + 1));
                }
                
                const fecha = new Date().toISOString().slice(0, 10);
                XLSX.writeFile(wb, 'Grupos_' + (datos.info.asignatura || 'Clase') + '_' + fecha + '.xlsx');
                
                mostrarMensaje('‚úì Excel de grupos generado');
            } catch(error) {
                console.error('Error al generar Excel:', error);
                mostrarMensaje('‚úó Error al generar Excel', true);
            }
        }
        
        function copiarGrupos() {
            if (gruposGenerados.length === 0) {
                mostrarMensaje('‚úó No hay grupos para copiar', true);
                return;
            }
            
            let texto = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            texto += '   GRUPOS ALEATORIOS\n';
            texto += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            texto += 'Asignatura: ' + (datos.info.asignatura || 'Sin especificar') + '\n';
            texto += 'Maestro/a: ' + (datos.info.maestro || 'Sin especificar') + '\n';
            texto += 'Fecha: ' + new Date().toLocaleDateString() + '\n';
            texto += 'Total de grupos: ' + gruposGenerados.length + '\n';
            texto += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            for (let i = 0; i < gruposGenerados.length; i++) {
                texto += 'üìå GRUPO ' + (i + 1) + ' (' + gruposGenerados[i].length + ' integrantes)\n';
                texto += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                
                for (let j = 0; j < gruposGenerados[i].length; j++) {
                    texto += '  ' + (j + 1) + '. ' + gruposGenerados[i][j].nombre + '\n';
                }
                
                texto += '\n';
            }
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(texto).then(function() {
                mostrarMensaje('‚úì Grupos copiados al portapapeles');
            }).catch(function(err) {
                // Fallback para navegadores antiguos
                const textarea = document.createElement('textarea');
                textarea.value = texto;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                
                try {
                    document.execCommand('copy');
                    mostrarMensaje('‚úì Grupos copiados al portapapeles');
                } catch(e) {
                    mostrarMensaje('‚úó No se pudo copiar al portapapeles', true);
                }
                
                document.body.removeChild(textarea);
            });
        }
        
        // ==================== FIN EXPORTACI√ìN DE GRUPOS ====================
        
        // ==================== FUNCIONES DE ASISTENCIA ====================
        
        function inicializarAsistencia() {
            // Establecer mes y a√±o actual
            const mesSelect = document.getElementById('mesAsistencia');
            const anioInput = document.getElementById('anioAsistencia');
            
            if (mesSelect) mesSelect.value = asistencia.mesActual;
            if (anioInput) anioInput.value = asistencia.anioActual;
            
            renderResumenMes();
        }
        
        function cambiarMesAsistencia() {
            asistencia.mesActual = parseInt(document.getElementById('mesAsistencia').value);
            asistencia.anioActual = parseInt(document.getElementById('anioAsistencia').value);
            renderResumenMes();
        }
        
        function calcularPorcentajeAsistencia(registros, totalDias) {
            if (totalDias === 0) return 0;
            
            let presentes = 0;
            let tardanzas = 0;
            let excusas = 0;
            let ausencias = 0;
            let diasRegistrados = 0;
            
            for (let i = 0; i < registros.length; i++) {
                // Solo contar d√≠as que tienen alg√∫n registro
                if (registros[i] && registros[i] !== '') {
                    diasRegistrados++;
                    
                    if (registros[i] === 'P') presentes++;
                    else if (registros[i] === 'T') tardanzas++;
                    else if (registros[i] === 'E') excusas++;
                    else if (registros[i] === 'A') ausencias++;
                }
            }
            
            // Si no hay d√≠as registrados, retornar 0
            if (diasRegistrados === 0) return 0;
            
            // L√ìGICA CORRECTA:
            // Cada grupo de 3 T o E: las primeras 2 cuentan como P, la 3ra como A
            // Ejemplo: T,T,T = 2P + 1A
            // Ejemplo: T,T,T,T = 3P + 1A (se reinicia el conteo)
            // Ejemplo: E,E,E,E,E,E = 4P + 2A
            
            // Calcular cu√°ntos grupos completos de 3
            const gruposTardanzas = Math.floor(tardanzas / 3);
            const gruposExcusas = Math.floor(excusas / 3);
            
            // Calcular cu√°ntas T y E quedan despu√©s de formar grupos
            const tardanzasRestantes = tardanzas % 3;
            const excusasRestantes = excusas % 3;
            
            // Cada grupo de 3 aporta 2P + 1A
            const presenciasPorTardanzas = (gruposTardanzas * 2) + tardanzasRestantes;
            const presenciasPorExcusas = (gruposExcusas * 2) + excusasRestantes;
            
            const ausenciasPorTardanzas = gruposTardanzas;
            const ausenciasPorExcusas = gruposExcusas;
            
            // Total de presencias efectivas
            const presenciasEfectivas = presentes + presenciasPorTardanzas + presenciasPorExcusas;
            
            // Total de ausencias
            const ausenciasEfectivas = ausencias + ausenciasPorTardanzas + ausenciasPorExcusas;
            
            // Calcular porcentaje basado SOLO en d√≠as registrados
            return (presenciasEfectivas / diasRegistrados) * 100;
        }
        
        function renderResumenMes() {
            const container = document.getElementById('statsAsistencia');
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            
            if (!asistencia.meses[mesKey]) {
                container.innerHTML = '<p>No hay datos de asistencia</p>';
                return;
            }
            
            const mesData = asistencia.meses[mesKey];
            let totalP = 0, totalT = 0, totalE = 0, totalA = 0;
            let sumaPorc = 0;
            let contEst = 0;
            let estudiantesBajaAsistencia = [];
            
            for (let key in mesData.registros) {
                const registros = mesData.registros[key];
                contEst++;
                
                for (let i = 0; i < registros.length; i++) {
                    if (registros[i] === 'P') totalP++;
                    else if (registros[i] === 'T') totalT++;
                    else if (registros[i] === 'E') totalE++;
                    else if (registros[i] === 'A') totalA++;
                }
                
                const porc = calcularPorcentajeAsistencia(registros, mesData.dias.length);
                sumaPorc += porc;
                
                // Verificar si est√° por debajo de 75%
                if (porc < 75 && porc > 0) {
                    const estudiante = datos.estudiantes.find(e => e.num == key);
                    if (estudiante) {
                        estudiantesBajaAsistencia.push({
                            nombre: estudiante.nombre,
                            porcentaje: porc
                        });
                    }
                }
            }
            
            const promedioPorc = contEst > 0 ? sumaPorc / contEst : 0;
            
            let html = '';
            
            // ALERTA DE BAJA ASISTENCIA
            if (estudiantesBajaAsistencia.length > 0) {
                html += '<div class="alerta-asistencia" style="background:#fff3cd;border:2px solid #ffc107;padding:15px;border-radius:10px;margin-bottom:20px;">';
                html += '<h4 style="color:#856404;margin:0 0 10px 0;">‚ö†Ô∏è Alerta: Estudiantes con Asistencia Baja (< 75%)</h4>';
                html += '<ul style="margin:0;padding-left:20px;color:#856404;">';
                for (let i = 0; i < estudiantesBajaAsistencia.length; i++) {
                    html += '<li><strong>' + estudiantesBajaAsistencia[i].nombre + '</strong>: ' + estudiantesBajaAsistencia[i].porcentaje.toFixed(1) + '%</li>';
                }
                html += '</ul>';
                html += '</div>';
            }
            
            html += '<div class="stat-asistencia" style="background:#C6E0B4;">';
            html += '<div class="label">Presentes</div>';
            html += '<div class="numero" style="color:#2d5016;">' + totalP + '</div>';
            html += '</div>';
            
            html += '<div class="stat-asistencia" style="background:#FFE699;">';
            html += '<div class="label">Tardanzas</div>';
            html += '<div class="numero" style="color:#7f6000;">' + totalT + '</div>';
            html += '</div>';
            
            html += '<div class="stat-asistencia" style="background:#F4B084;">';
            html += '<div class="label">Excusas</div>';
            html += '<div class="numero" style="color:#7f3800;">' + totalE + '</div>';
            html += '</div>';
            
            html += '<div class="stat-asistencia" style="background:#FFB3B3;">';
            html += '<div class="label">Ausencias</div>';
            html += '<div class="numero" style="color:#7f0000;">' + totalA + '</div>';
            html += '</div>';
            
            html += '<div class="stat-asistencia" style="background:#E7F3FF;">';
            html += '<div class="label">% Promedio</div>';
            html += '<div class="numero" style="color:#4472C4;">' + promedioPorc.toFixed(1) + '%</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        
        function renderResumenAnual() {
            // Ya no se usa - el resumen anual est√° en el modal
            return;
        }
        
        function exportarAsistenciaPDF() {
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            
            if (!asistencia.meses[mesKey] || datos.estudiantes.length === 0) {
                mostrarMensaje('‚úó No hay datos de asistencia para exportar', true);
                return;
            }
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF no est√° cargado');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const mesData = asistencia.meses[mesKey];
                const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                
                // T√çTULO
                doc.setFontSize(16);
                doc.setTextColor(31, 78, 120);
                doc.text('REGISTRO DE ASISTENCIA - ' + mesesNombres[mes].toUpperCase() + ' ' + anio, 148, 15, {align: 'center'});
                
                // INFORMACI√ìN
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Asignatura: ' + (datos.info.asignatura || ''), 15, 25);
                doc.text('Maestro/a: ' + (datos.info.maestro || ''), 15, 30);
                doc.text('Centro: ' + (datos.info.centro || ''), 15, 35);
                
                // LEYENDA
                doc.setFontSize(9);
                doc.text('P: Presente  |  T: Tardanza (3T=1A)  |  E: Excusa (3E=1A)  |  A: Ausencia', 15, 42);
                
                // TABLA
                const headers = [['No.', 'Estudiante']];
                
                // Headers de d√≠as
                for (let i = 0; i < mesData.dias.length; i++) {
                    headers[0].push('D' + mesData.dias[i]);
                }
                headers[0].push('% Asist');
                
                const rows = [];
                
                for (let ei = 0; ei < datos.estudiantes.length; ei++) {
                    const e = datos.estudiantes[ei];
                    const registros = mesData.registros[e.num] || [];
                    const row = [e.num, e.nombre];
                    
                    for (let i = 0; i < mesData.dias.length; i++) {
                        row.push(registros[i] || '-');
                    }
                    
                    const porc = calcularPorcentajeAsistencia(registros, mesData.dias.length);
                    row.push(porc.toFixed(1) + '%');
                    
                    rows.push(row);
                }
                
                doc.autoTable({
                    startY: 48,
                    head: headers,
                    body: rows,
                    theme: 'grid',
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        halign: 'center',
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [31, 78, 120],
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: {cellWidth: 10, halign: 'center'},
                        1: {cellWidth: 50, halign: 'left'}
                    }
                });
                
                doc.save('Asistencia_' + mesesNombres[mes] + '_' + anio + '.pdf');
                mostrarMensaje('‚úì PDF de asistencia generado');
                
            } catch(error) {
                console.error('Error al generar PDF:', error);
                mostrarMensaje('‚úó Error al generar PDF: ' + error.message, true);
            }
        }
        
        function exportarResumenAnualPDF() {
            if (datos.estudiantes.length === 0) {
                mostrarMensaje('‚úó No hay estudiantes para exportar', true);
                return;
            }
            
            try {
                if (typeof window.jspdf === 'undefined') {
                    throw new Error('jsPDF no est√° cargado');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                const ordenMeses = [8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6];
                
                // T√çTULO
                doc.setFontSize(16);
                doc.setTextColor(31, 78, 120);
                doc.text('RESUMEN ANUAL DE ASISTENCIA - ' + asistencia.anioActual, 148, 15, {align: 'center'});
                
                // INFORMACI√ìN
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Asignatura: ' + (datos.info.asignatura || ''), 15, 25);
                doc.text('Maestro/a: ' + (datos.info.maestro || ''), 15, 30);
                doc.text('Centro: ' + (datos.info.centro || ''), 15, 35);
                
                // TABLA
                const headers = [['No.', 'Estudiante']];
                
                // Headers de meses (Ago a Jun)
                for (let i = 0; i < ordenMeses.length; i++) {
                    const m = ordenMeses[i];
                    headers[0].push(mesesNombres[m].substr(0, 3));
                }
                headers[0].push('Prom');
                
                const rows = [];
                
                for (let ei = 0; ei < datos.estudiantes.length; ei++) {
                    const e = datos.estudiantes[ei];
                    const row = [e.num, e.nombre];
                    
                    let sumaPorcentajes = 0;
                    let mesesConDatos = 0;
                    
                    for (let i = 0; i < ordenMeses.length; i++) {
                        const m = ordenMeses[i];
                        const mesKey = asistencia.anioActual + '-' + m;
                        
                        if (asistencia.meses[mesKey] && asistencia.meses[mesKey].registros[e.num]) {
                            const registros = asistencia.meses[mesKey].registros[e.num];
                            const diasMes = asistencia.meses[mesKey].dias.length;
                            const porc = calcularPorcentajeAsistencia(registros, diasMes);
                            
                            if (porc > 0) {
                                row.push(porc.toFixed(0) + '%');
                                sumaPorcentajes += porc;
                                mesesConDatos++;
                            } else {
                                row.push('-');
                            }
                        } else {
                            row.push('-');
                        }
                    }
                    
                    const promedioAnual = mesesConDatos > 0 ? sumaPorcentajes / mesesConDatos : 0;
                    row.push(promedioAnual > 0 ? promedioAnual.toFixed(1) + '%' : '-');
                    
                    rows.push(row);
                }
                
                doc.autoTable({
                    startY: 42,
                    head: headers,
                    body: rows,
                    theme: 'grid',
                    styles: {
                        fontSize: 8,
                        cellPadding: 2,
                        halign: 'center',
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [31, 78, 120],
                        textColor: [255, 255, 255],
                        fontSize: 9,
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: {cellWidth: 10, halign: 'center'},
                        1: {cellWidth: 50, halign: 'left'}
                    }
                });
                
                doc.save('Resumen_Anual_Asistencia_' + asistencia.anioActual + '.pdf');
                mostrarMensaje('‚úì PDF de resumen anual generado');
                
            } catch(error) {
                console.error('Error al generar PDF:', error);
                mostrarMensaje('‚úó Error al generar PDF: ' + error.message, true);
            }
        }
        
        // ==================== FIN FUNCIONES ASISTENCIA ====================
        
        // ==================== NUEVAS FUNCIONES MODALES ASISTENCIA ====================
        
        var asistenciaTemporal = {}; // Para guardar temporalmente la asistencia mientras se edita
        
        function abrirModalTomarAsistencia() {
            if (datos.estudiantes.length === 0) {
                mostrarMensaje('‚úó No hay estudiantes. Agrega estudiantes primero.', true);
                return;
            }
            
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            
            if (!asistencia.meses[mesKey]) {
                asistencia.meses[mesKey] = { dias: [], registros: {} };
            }
            
            const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('mesAnioTomarLabel').textContent = mesesNombres[mes] + ' ' + anio;
            
            // Sugerir el siguiente d√≠a disponible
            const mesData = asistencia.meses[mesKey];
            const siguienteDia = mesData.dias.length > 0 ? mesData.dias[mesData.dias.length - 1] + 1 : 1;
            document.getElementById('diaTomarAsistencia').value = siguienteDia <= 31 ? siguienteDia : 1;
            
            // Renderizar lista de estudiantes
            renderListaTomarAsistencia();
            
            document.getElementById('modalTomarAsistencia').classList.add('activo');
        }
        
        function renderListaTomarAsistencia() {
            const container = document.getElementById('listaTomarAsistencia');
            let html = '';
            
            for (let i = 0; i < datos.estudiantes.length; i++) {
                const e = datos.estudiantes[i];
                const radioName = 'asist_' + e.num;
                
                html += '<div class="estudiante-row">';
                html += '<span class="estudiante-num">' + e.num + '</span>';
                html += '<span class="estudiante-nombre">' + e.nombre + '</span>';
                html += '<div class="estudiante-opciones">';
                html += '<div class="radio-option opcion-P"><input type="radio" name="' + radioName + '" value="P"> <label>P</label></div>';
                html += '<div class="radio-option opcion-T"><input type="radio" name="' + radioName + '" value="T"> <label>T</label></div>';
                html += '<div class="radio-option opcion-E"><input type="radio" name="' + radioName + '" value="E"> <label>E</label></div>';
                html += '<div class="radio-option opcion-A"><input type="radio" name="' + radioName + '" value="A"> <label>A</label></div>';
                html += '</div>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function marcarTodos(valor) {
            for (let i = 0; i < datos.estudiantes.length; i++) {
                const radioName = 'asist_' + datos.estudiantes[i].num;
                const radios = document.getElementsByName(radioName);
                for (let j = 0; j < radios.length; j++) {
                    if (radios[j].value === valor) {
                        radios[j].checked = true;
                    }
                }
            }
        }
        
        function guardarAsistenciaTomada() {
            const dia = parseInt(document.getElementById('diaTomarAsistencia').value);
            
            if (!dia || dia < 1 || dia > 31) {
                mostrarMensaje('‚úó Ingresa un d√≠a v√°lido (1-31)', true);
                return;
            }
            
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            
            if (!asistencia.meses[mesKey]) {
                asistencia.meses[mesKey] = { dias: [], registros: {} };
            }
            
            const mesData = asistencia.meses[mesKey];
            
            // Agregar el d√≠a si no existe
            if (!mesData.dias.includes(dia)) {
                mesData.dias.push(dia);
                mesData.dias.sort((a, b) => a - b);
            }
            
            const diaIndex = mesData.dias.indexOf(dia);
            
            // Guardar asistencia de cada estudiante
            for (let i = 0; i < datos.estudiantes.length; i++) {
                const e = datos.estudiantes[i];
                const radioName = 'asist_' + e.num;
                const radios = document.getElementsByName(radioName);
                let valor = '';
                
                for (let j = 0; j < radios.length; j++) {
                    if (radios[j].checked) {
                        valor = radios[j].value;
                        break;
                    }
                }
                
                if (!mesData.registros[e.num]) {
                    mesData.registros[e.num] = [];
                }
                
                // Asegurar que el array tenga el tama√±o correcto
                while (mesData.registros[e.num].length < mesData.dias.length) {
                    mesData.registros[e.num].push('');
                }
                
                mesData.registros[e.num][diaIndex] = valor;
            }
            
            cerrarModal('modalTomarAsistencia');
            renderResumenMes();
            guardarDatosLocalStorage();
            mostrarMensaje('‚úì Asistencia del d√≠a ' + dia + ' guardada correctamente');
        }
        
        function abrirModalVerAsistencia() {
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            
            const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('tituloVerMes').textContent = 'Asistencia de ' + mesesNombres[mes] + ' ' + anio;
            
            // Renderizar selector de d√≠as
            const container = document.getElementById('selectorDiasVer');
            let html = '';
            
            if (asistencia.meses[mesKey] && asistencia.meses[mesKey].dias.length > 0) {
                const dias = asistencia.meses[mesKey].dias;
                for (let i = 0; i < dias.length; i++) {
                    html += '<button class="dia-btn" onclick="verAsistenciaDia(' + dias[i] + ')">D√≠a ' + dias[i] + '</button>';
                }
            } else {
                html = '<p style="text-align:center;color:#999;padding:40px;">No hay d√≠as registrados para este mes</p>';
            }
            
            container.innerHTML = html;
            document.getElementById('tablaVerDia').style.display = 'none';
            document.getElementById('modalVerAsistencia').classList.add('activo');
        }
        
        function verAsistenciaDia(dia) {
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            const mesData = asistencia.meses[mesKey];
            
            if (!mesData) return;
            
            const diaIndex = mesData.dias.indexOf(dia);
            if (diaIndex === -1) return;
            
            const container = document.getElementById('tablaVerDia');
            let html = '<h3 style="color:#4472C4;margin:20px 0;">Asistencia del D√≠a ' + dia + '</h3>';
            html += '<table><thead><tr>';
            html += '<th>No.</th><th>Estudiante</th><th>Asistencia</th>';
            html += '</tr></thead><tbody>';
            
            for (let i = 0; i < datos.estudiantes.length; i++) {
                const e = datos.estudiantes[i];
                const registros = mesData.registros[e.num] || [];
                const valor = registros[diaIndex] || '-';
                
                let clase = '';
                let texto = valor;
                if (valor === 'P') {
                    clase = 'style="background:#d4edda;color:#155724;font-weight:bold;"';
                    texto = '‚úì Presente';
                } else if (valor === 'T') {
                    clase = 'style="background:#fff3cd;color:#856404;font-weight:bold;"';
                    texto = '‚è∞ Tardanza';
                } else if (valor === 'E') {
                    clase = 'style="background:#ffe5d0;color:#833c00;font-weight:bold;"';
                    texto = 'üìù Excusa';
                } else if (valor === 'A') {
                    clase = 'style="background:#f8d7da;color:#721c24;font-weight:bold;"';
                    texto = '‚úó Ausente';
                }
                
                html += '<tr><td>' + e.num + '</td><td>' + e.nombre + '</td><td ' + clase + '>' + texto + '</td></tr>';
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
            container.style.display = 'block';
        }
        
        function abrirModalEditarAsistencia() {
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            
            const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            document.getElementById('mesAnioEditarLabel').textContent = mesesNombres[mes] + ' ' + anio;
            
            // Llenar selector de d√≠as
            const select = document.getElementById('diaEditarSelect');
            select.innerHTML = '<option value="">-- Seleccione un d√≠a --</option>';
            
            if (asistencia.meses[mesKey] && asistencia.meses[mesKey].dias.length > 0) {
                const dias = asistencia.meses[mesKey].dias;
                for (let i = 0; i < dias.length; i++) {
                    select.innerHTML += '<option value="' + dias[i] + '">D√≠a ' + dias[i] + '</option>';
                }
            }
            
            document.getElementById('listaEditarAsistencia').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">Selecciona un d√≠a para editar</p>';
            
            document.getElementById('modalEditarAsistencia').classList.add('activo');
        }
        
        function cargarDiaEditar() {
            const dia = parseInt(document.getElementById('diaEditarSelect').value);
            if (!dia) {
                document.getElementById('listaEditarAsistencia').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">Selecciona un d√≠a para editar</p>';
                return;
            }
            
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            const mesData = asistencia.meses[mesKey];
            
            if (!mesData) return;
            
            const diaIndex = mesData.dias.indexOf(dia);
            if (diaIndex === -1) return;
            
            const container = document.getElementById('listaEditarAsistencia');
            let html = '';
            
            for (let i = 0; i < datos.estudiantes.length; i++) {
                const e = datos.estudiantes[i];
                const radioName = 'edit_asist_' + e.num;
                const registros = mesData.registros[e.num] || [];
                const valorActual = registros[diaIndex] || '';
                
                html += '<div class="estudiante-row">';
                html += '<span class="estudiante-num">' + e.num + '</span>';
                html += '<span class="estudiante-nombre">' + e.nombre + '</span>';
                html += '<div class="estudiante-opciones">';
                html += '<div class="radio-option opcion-P"><input type="radio" name="' + radioName + '" value="P"' + (valorActual === 'P' ? ' checked' : '') + '> <label>P</label></div>';
                html += '<div class="radio-option opcion-T"><input type="radio" name="' + radioName + '" value="T"' + (valorActual === 'T' ? ' checked' : '') + '> <label>T</label></div>';
                html += '<div class="radio-option opcion-E"><input type="radio" name="' + radioName + '" value="E"' + (valorActual === 'E' ? ' checked' : '') + '> <label>E</label></div>';
                html += '<div class="radio-option opcion-A"><input type="radio" name="' + radioName + '" value="A"' + (valorActual === 'A' ? ' checked' : '') + '> <label>A</label></div>';
                html += '</div>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        function guardarAsistenciaEditada() {
            const dia = parseInt(document.getElementById('diaEditarSelect').value);
            if (!dia) {
                mostrarMensaje('‚úó Selecciona un d√≠a para editar', true);
                return;
            }
            
            const mes = asistencia.mesActual;
            const anio = asistencia.anioActual;
            const mesKey = anio + '-' + mes;
            const mesData = asistencia.meses[mesKey];
            
            if (!mesData) return;
            
            const diaIndex = mesData.dias.indexOf(dia);
            if (diaIndex === -1) return;
            
            // Guardar cambios
            for (let i = 0; i < datos.estudiantes.length; i++) {
                const e = datos.estudiantes[i];
                const radioName = 'edit_asist_' + e.num;
                const radios = document.getElementsByName(radioName);
                let valor = '';
                
                for (let j = 0; j < radios.length; j++) {
                    if (radios[j].checked) {
                        valor = radios[j].value;
                        break;
                    }
                }
                
                if (!mesData.registros[e.num]) {
                    mesData.registros[e.num] = [];
                }
                
                mesData.registros[e.num][diaIndex] = valor;
            }
            
            cerrarModal('modalEditarAsistencia');
            renderResumenMes();
            guardarDatosLocalStorage();
            mostrarMensaje('‚úì Asistencia del d√≠a ' + dia + ' actualizada');
        }
        
        function abrirModalVerAnual() {
            const container = document.getElementById('contenidoAnual');
            
            const mesesNombres = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                                  'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const ordenMeses = [8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6];
            
            if (datos.estudiantes.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">No hay estudiantes</p>';
                document.getElementById('modalVerAnual').classList.add('activo');
                return;
            }
            
            let estudiantesBajaAsistenciaAnual = [];
            let html = '';
            
            // Calcular primero para detectar alertas
            let tempData = [];
            for (let ei = 0; ei < datos.estudiantes.length; ei++) {
                const e = datos.estudiantes[ei];
                let sumaPorcentajes = 0;
                let mesesConDatos = 0;
                
                for (let i = 0; i < ordenMeses.length; i++) {
                    const m = ordenMeses[i];
                    const mesKey = asistencia.anioActual + '-' + m;
                    
                    if (asistencia.meses[mesKey] && asistencia.meses[mesKey].registros[e.num]) {
                        const registros = asistencia.meses[mesKey].registros[e.num];
                        const diasMes = asistencia.meses[mesKey].dias.length;
                        const porc = calcularPorcentajeAsistencia(registros, diasMes);
                        
                        if (porc > 0) {
                            sumaPorcentajes += porc;
                            mesesConDatos++;
                        }
                    }
                }
                
                const promedioAnual = mesesConDatos > 0 ? sumaPorcentajes / mesesConDatos : 0;
                
                if (promedioAnual < 75 && promedioAnual > 0) {
                    estudiantesBajaAsistenciaAnual.push({
                        nombre: e.nombre,
                        porcentaje: promedioAnual
                    });
                }
                
                tempData.push({
                    estudiante: e,
                    promedioAnual: promedioAnual,
                    sumaPorcentajes: sumaPorcentajes,
                    mesesConDatos: mesesConDatos
                });
            }
            
            // ALERTA DE BAJA ASISTENCIA ANUAL
            if (estudiantesBajaAsistenciaAnual.length > 0) {
                html += '<div class="alerta-asistencia" style="background:#fff3cd;border:2px solid #ffc107;padding:15px;border-radius:10px;margin-bottom:20px;">';
                html += '<h4 style="color:#856404;margin:0 0 10px 0;">‚ö†Ô∏è Alerta Anual: Estudiantes con Promedio Bajo (< 75%)</h4>';
                html += '<ul style="margin:0;padding-left:20px;color:#856404;">';
                for (let i = 0; i < estudiantesBajaAsistenciaAnual.length; i++) {
                    html += '<li><strong>' + estudiantesBajaAsistenciaAnual[i].nombre + '</strong>: ' + estudiantesBajaAsistenciaAnual[i].porcentaje.toFixed(1) + '%</li>';
                }
                html += '</ul>';
                html += '</div>';
            }
            
            html += '<table class="tabla-asistencia" style="width:100%;">';
            html += '<thead><tr>';
            html += '<th style="min-width:40px;">No.</th>';
            html += '<th style="min-width:200px;">Estudiante</th>';
            
            for (let i = 0; i < ordenMeses.length; i++) {
                const m = ordenMeses[i];
                html += '<th>' + mesesNombres[m].substr(0, 3) + '</th>';
            }
            
            html += '<th style="font-weight:bold;">Promedio</th>';
            html += '</tr></thead><tbody>';
            
            for (let ei = 0; ei < datos.estudiantes.length; ei++) {
                const e = datos.estudiantes[ei];
                const data = tempData[ei];
                
                html += '<tr>';
                html += '<td class="col-numero">' + e.num + '</td>';
                html += '<td class="col-estudiante">' + e.nombre + '</td>';
                
                for (let i = 0; i < ordenMeses.length; i++) {
                    const m = ordenMeses[i];
                    const mesKey = asistencia.anioActual + '-' + m;
                    
                    if (asistencia.meses[mesKey] && asistencia.meses[mesKey].registros[e.num]) {
                        const registros = asistencia.meses[mesKey].registros[e.num];
                        const diasMes = asistencia.meses[mesKey].dias.length;
                        const porc = calcularPorcentajeAsistencia(registros, diasMes);
                        
                        if (porc > 0) {
                            let clase = '';
                            if (porc >= 95) clase = 'porcentaje-excelente';
                            else if (porc >= 85) clase = 'porcentaje-bueno';
                            else if (porc >= 70) clase = 'porcentaje-regular';
                            else clase = 'porcentaje-malo';
                            
                            html += '<td class="' + clase + '">' + porc.toFixed(0) + '%</td>';
                        } else {
                            html += '<td style="color:#ccc;">-</td>';
                        }
                    } else {
                        html += '<td style="color:#ccc;">-</td>';
                    }
                }
                
                const promedioAnual = data.promedioAnual;
                let claseAnual = '';
                if (promedioAnual >= 95) claseAnual = 'porcentaje-excelente';
                else if (promedioAnual >= 85) claseAnual = 'porcentaje-bueno';
                else if (promedioAnual >= 70) claseAnual = 'porcentaje-regular';
                else if (promedioAnual > 0) claseAnual = 'porcentaje-malo';
                
                html += '<td class="col-porcentaje ' + claseAnual + '" style="font-weight:bold;">' + (promedioAnual > 0 ? promedioAnual.toFixed(1) + '%' : '-') + '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            container.innerHTML = html;
            
            document.getElementById('modalVerAnual').classList.add('activo');
        }
        
        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('activo');
        }
        
        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('activo');
            }
        }
        
        // ==================== FIN FUNCIONES MODALES ====================
        
        // ==================== FIN FUNCIONES RULETA ====================
        
        
        // TABLA SIN FECHAS INDIVIDUALES - SOLO HEADER
        function renderTabla(bloque, periodo) {
            var bd = datos.bloques[bloque-1];
            var periodoData = bd.periodos[periodo];
            
            // Contar total de criterios del per√≠odo Y obtener su tipo
            var criteriosInfo = []; // {texto, tipo}
            for(var ii=0; ii<periodoData.indicadores.length; ii++) {
                var ind = periodoData.indicadores[ii];
                if(ind.criterios) {
                    for(var cri=0; cri<ind.criterios.length; cri++) {
                        var critObj = ind.criterios[cri];
                        var critTexto = typeof critObj === 'string' ? critObj : (critObj.texto || '');
                        var critTipo = typeof critObj === 'string' ? 'letra' : (critObj.tipo || 'letra');
                        criteriosInfo.push({texto: critTexto, tipo: critTipo});
                    }
                }
            }
            
            var totalCrit = criteriosInfo.length;
            
            if(totalCrit === 0) {
                document.getElementById('tabla-'+bloque).innerHTML = '<p style="text-align:center;padding:20px;color:#999;">Agrega indicadores y criterios primero en la secci√≥n de arriba</p>';
                return;
            }
            
            // FILA DE FECHAS EN HEADER
            var headerFechas = '';
            for(var critIdx=0; critIdx<totalCrit; critIdx++) {
                var keyFH = periodo+'_'+critIdx;
                var fechaH = periodoData.fechasHeader[keyFH] || '';
                var icono = criteriosInfo[critIdx].tipo === 'numero' ? 'üî¢' : 'üìù';
                headerFechas += '<th>'+icono+' <input type="text" class="fecha-header-input" placeholder="dd/mm" value="'+fechaH+'" onchange="guardarFechaHeaderPeriodo('+(bloque-1)+','+periodo+','+critIdx+',this.value)"></th>';
            }
            
            // FILA DE CRITERIOS
            var headers = '';
            for(var critIdx=0; critIdx<totalCrit; critIdx++) {
                headers += '<th>C'+(critIdx+1)+'</th>';
            }
            
            var rows = '';
            for(var ei=0; ei<datos.estudiantes.length; ei++) {
                var e = datos.estudiantes[ei];
                rows += '<tr><td><b>'+e.num+'</b></td><td style="text-align:left;padding-left:10px">'+e.nombre+'</td>';
                
                for(var critIdx=0; critIdx<totalCrit; critIdx++) {
                    var key = e.num+'_'+periodo+'_'+critIdx;
                    var cal = periodoData.cal[key] || '';
                    var critInfo = criteriosInfo[critIdx];
                    
                    rows += '<td>';
                    
                    if(critInfo.tipo === 'numero') {
                        // INPUT NUM√âRICO
                        var clase = cal ? 'nota-numero' : '';
                        rows += '<input type="number" min="0" max="100" class="input-numero '+clase+'" value="'+cal+'" onchange="guardarCalifPeriodo('+(bloque-1)+','+e.num+','+periodo+','+critIdx+',this.value)" style="width:100%;padding:8px;border:2px solid #667eea;border-radius:6px;text-align:center;font-weight:600;font-size:14px;">';
                    } else {
                        // SELECT DE LETRAS
                        var clase = cal ? 'nota-'+cal[0].toLowerCase() : '';
                        rows += '<select class="select-nota '+clase+'" onchange="guardarCalifPeriodo('+(bloque-1)+','+e.num+','+periodo+','+critIdx+',this.value)">'+
                            '<option value="">-</option>';
                        var notas = Object.keys(NOTAS);
                        for(var n=0; n<notas.length; n++) {
                            rows += '<option value="'+notas[n]+'"'+(cal===notas[n]?' selected':'')+'>'+notas[n]+'</option>';
                        }
                        rows += '</select>';
                    }
                    
                    rows += '</td>';
                }
                
                // Calcular promedio considerando tipo
                var suma = 0, cuenta = 0;
                for(var i=0; i<totalCrit; i++) {
                    var key = e.num+'_'+periodo+'_'+i;
                    var cal = periodoData.cal[key];
                    if(cal) {
                        if(criteriosInfo[i].tipo === 'numero') {
                            var valor = parseFloat(cal);
                            if(!isNaN(valor)) {
                                suma += valor;
                                cuenta++;
                            }
                        } else if(NOTAS[cal]) {
                            suma += NOTAS[cal];
                            cuenta++;
                        }
                    }
                }
                rows += '<td class="celda-promedio">'+(cuenta>0?(suma/cuenta).toFixed(2):'-')+'</td></tr>';
            }
            
            document.getElementById('tabla-'+bloque).innerHTML = '<div style="overflow-x:auto"><table class="tabla-calif">'+
                '<tr><th style="width:50px">No.</th><th style="min-width:180px">Estudiante</th>'+headerFechas+'<th>PROMEDIO</th></tr>'+
                '<tr><th colspan="2">Criterios ‚Üí</th>'+headers+'<th></th></tr>'+
                rows+'</table></div>';
        }
        
        function guardarCalifPeriodo(bi, num, periodo, crit, valor) {
            datos.bloques[bi].periodos[periodo].cal[num+'_'+periodo+'_'+crit] = valor;
            renderTabla(bi+1, periodo);
            guardarDatosLocalStorage();
        }
        
        function guardarFechaHeaderPeriodo(bi, periodo, crit, valor) {
            var keyFH = periodo+'_'+crit;
            datos.bloques[bi].periodos[periodo].fechasHeader[keyFH] = valor;
            guardarDatosLocalStorage();
        }
        
        function iniciar() {
            // Intentar cargar datos guardados
            cargarDatosLocalStorage();
            
            // Si no hay datos guardados, inicializar con valores por defecto
            if (datos.estudiantes.length === 0) {
                // Inicializar informaci√≥n fija
                datos.info.centro = 'Alberto Feliz Bello';
                datos.info.maestro = 'Luis Abel G√≥mez F√©liz';
                datos.info.asignatura = 'Educaci√≥n F√≠sica';
                datos.info.anio = '2025 - 2026';
                
                for(var i=1; i<=15; i++) {
                    datos.estudiantes.push({num:i, nombre:'Estudiante '+i});
                }
                
                // Inicializar estructura con per√≠odos
                for(var b=0; b<4; b++) {
                    // Competencias del bloque (fijas)
                    datos.bloques[b].comp = [{
                        competencia:'Competencia Fundamental ' + (b+1)
                    }];
                    
                    // Indicadores y criterios por per√≠odo - CADA PER√çODO ES INDEPENDIENTE
                    for(var p=1; p<=4; p++) {
                        datos.bloques[b].periodos[p].indicadores = [
                            {
                                texto: 'Indicador de Bloque ' + (b+1) + ' - Per√≠odo ' + p + ' (Indicador 1)',
                                criterios: [
                                    'Criterio 1.1 del Per√≠odo ' + p,
                                    'Criterio 1.2 del Per√≠odo ' + p
                                ]
                            },
                            {
                                texto: 'Indicador de Bloque ' + (b+1) + ' - Per√≠odo ' + p + ' (Indicador 2)',
                                criterios: [
                                    'Criterio 2.1 del Per√≠odo ' + p
                                ]
                            }
                        ];
                        
                        // Inicializar objetos vac√≠os para calificaciones y fechas
                        datos.bloques[b].periodos[p].cal = {};
                        datos.bloques[b].periodos[p].fechasHeader = {};
                    }
                }
                
                console.log('‚úÖ Estructura inicializada con indicadores para TODOS los per√≠odos');
                
                // Guardar datos iniciales
                guardarDatosLocalStorage();
                mostrarMensaje('‚úì Sistema iniciado - Todos los per√≠odos tienen indicadores de ejemplo');
            } else {
                mostrarMensaje('‚úì Datos cargados desde la √∫ltima sesi√≥n');
            }
            
            renderEstudiantes();
            renderBloques();
            renderEstadisticas();
        }
        
        window.onload = iniciar;
    </script>
</body>
</html>
